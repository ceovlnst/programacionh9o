!doctype html
html lang=es
head
  meta charset=utf-8 
  meta name=viewport content=width=device-width,initial-scale=1 
  titleGestión de Quirófanos – QuirófanosH9Otitle

  
  !-- Iconos  previsualización al compartir --
  meta name=description content=Gestión de quirófanos parrilla, lista de espera y herramientas de coordinación – QuirófanosH9O. 

  link rel=icon type=imagepng href=httpsceovlnst.github.ioprogramacionh9oog-image.png 
  link rel=apple-touch-icon href=httpsceovlnst.github.ioprogramacionh9oog-image.png 

  meta property=ogtype content=website 
  meta property=ogtitle content=Gestión de Quirófanos – QuirófanosH9O 
  meta property=ogdescription content=Parrilla de quirófanos, lista de espera y coordinación. 
  meta property=ogimage content=httpsceovlnst.github.ioprogramacionh9oog-image.png 
  meta property=ogurl content=httpsceovlnst.github.ioprogramacionh9o 

  meta name=twittercard content=summary_large_image 
  meta name=twittertitle content=Gestión de Quirófanos – QuirófanosH9O 
  meta name=twitterdescription content=Parrilla de quirófanos, lista de espera y coordinación. 
  meta name=twitterimage content=httpsceovlnst.github.ioprogramacionh9oog-image.png 
style
    root{
      --bg#f4f7fb;
      --card#ffffff;
      --muted#5b6b82;
      --text#0f172a;
      --acc#1d4ed8;
      --line#d7e2f0;

      --bad#b91c1c;
      --ok#047857;
      --warn#b45309;

      --softAcc rgba(29,78,216,.08);
      --softOk rgba(4,120,87,.08);
      --softWarn rgba(180,83,9,.08);
      --softBad rgba(185,28,28,.08);
    }

    {box-sizingborder-box}
    html,body{height100%}
    body{
      margin0;
      font-family system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji,Segoe UI Emoji;
      background
        radial-gradient(1000px 500px at 10% -10%, rgba(29,78,216,.10), transparent 55%),
        radial-gradient(1000px 500px at 100% 0%, rgba(4,120,87,.08), transparent 55%),
        var(--bg);
      colorvar(--text);
      overflow-xhidden;
    }

    .wrap{max-width1280px;margin0 auto;padding12px}
    @media(min-width 980px){ .wrap{padding16px} }

    .topbar{
      displayflex;gap12px;align-itemscenter;justify-contentspace-between;
      padding12px 14px;border1px solid var(--line);border-radius16px;
      background rgba(255,255,255,.88);
      backdrop-filter blur(8px);
      position sticky; top 10px; z-index 50;
      box-shadow 0 8px 30px rgba(15,23,42,.06);
      flex-wrapwrap;
      min-width0;
    }

    .brand{displayflex;gap12px;align-itemscenter;min-width0}
    .logo{
      width38px;
      height38px;
      border-radius14px;
      object-fitcontain;
      background#fff;
      box-shadow0 10px 25px rgba(15,23,42,.12);
      flex0 0 auto;
    }
    .brand h1{font-size15px;margin0;line-height1.2}
    .brand small{displayblock;colorvar(--muted);margin-top2px}

    .pill{
      displayflex;gap10px;align-itemscenter;flex-wrapwrap;
      padding8px 10px;border1px solid var(--line);border-radius999px;
      background rgba(255,255,255,.92);
      colorvar(--muted);
      font-size12px;
      max-width100%;
      min-width0;
    }
    .pill span{colorvar(--text);font-weight700}

    .btn{
      border1px solid var(--line);
      background #fff;
      colorvar(--text);
      padding10px 12px;border-radius12px;
      cursorpointer;
      font-weight750;
      box-shadow 0 8px 20px rgba(15,23,42,.06);
    }
    .btnhover{border-color rgba(29,78,216,.30)}
    .btn.primary{background var(--softAcc);border-color rgba(29,78,216,.25);color #0b2a78;}
    .btn.good{background var(--softOk);border-color rgba(4,120,87,.22);color#064e3b;}
    .btn.bad{background var(--softBad);border-color rgba(185,28,28,.22);color#7f1d1d;}
    .btn.warn{background var(--softWarn);border-color rgba(180,83,9,.22);color#7c2d12;}
    .btn.ghost{background transparent;border-color transparent;box-shadownone;}
    .btn.small{padding8px 10px;border-radius10px;font-size12px}
    .btndisabled, buttondisabled{opacity.55;cursornot-allowed;filtersaturate(.7);box-shadownone;}

    .grid{displaygrid;grid-template-columns minmax(0,1fr);gap12px;margin-top14px;}
    @media(min-width 980px){ .grid{grid-template-columns 380px minmax(0,1fr)} }

    .card{
      border1px solid var(--line);
      border-radius18px;
      background rgba(255,255,255,.92);
      backdrop-filter blur(8px);
      padding14px;
      box-shadow 0 18px 45px rgba(15,23,42,.08);
      min-width0;
    }
    .card h2{margin0 0 10px 0;font-size15px}
    .card h3{margin0 0 10px 0;font-size14px;colorvar(--muted);font-weight800}

    .row{displayflex;gap10px;align-itemscenter;flex-wrapwrap;min-width0}
    label{displayblock;colorvar(--muted);font-size12px;margin10px 0 6px}

    input, select, textarea{
      width100%;
      padding10px 12px;border-radius12px;
      border1px solid var(--line);
      background #fff;
      color var(--text);
      outlinenone;
      box-shadow 0 6px 16px rgba(15,23,42,.05);
      min-width0;
    }
    textarea{min-height84px;resizevertical}
    inputfocus, selectfocus, textareafocus{
      border-color rgba(29,78,216,.40);
      box-shadow 0 0 0 4px rgba(29,78,216,.10);
    }

    .actions{displayflex;gap10px;flex-wrapwrap;margin-top10px}
    .hr{height1px;background var(--line);margin12px 0}

    .msg{
      margin-top10px;
      padding10px 12px;border-radius12px;
      border1px solid var(--line);
      background #fff;
      colorvar(--muted);
      font-size 13px;
      white-space pre-wrap;
      box-shadow 0 10px 24px rgba(15,23,42,.06);
      min-width0;
    }
    .msg.ok{border-color rgba(4,120,87,.24); background var(--softOk); color var(--text)}
    .msg.bad{border-color rgba(185,28,28,.22); background var(--softBad); color var(--text)}
    .msg.warn{border-color rgba(180,83,9,.22); background var(--softWarn); color var(--text)}
    .hide{displaynone !important}

    .slots{displayflex;gap8px;flex-wrapwrap;margin-top10px}
    .slot{
      padding8px 10px;border-radius999px;border1px solid var(--line);
      background #fff;
      color var(--text);
      cursorpointer;
      font-size 12px;
      box-shadow 0 10px 24px rgba(15,23,42,.06);
    }
    .slothover{border-color rgba(29,78,216,.30)}
    .slot.selected{
      border-color rgba(29,78,216,.60);
      background var(--softAcc);
      font-weight700;
    }

    .tableWrap{
      overflow-xauto;
      border1px solid var(--line);
      border-radius14px;
      background#fff;
      box-shadow 0 14px 32px rgba(15,23,42,.06);
      max-width100%;
    }
    table{border-collapsecollapse;width100%;min-width0;}
    th, td{
      border-bottom1px solid rgba(215,226,240,.9);
      border-right1px solid rgba(215,226,240,.7);
      padding8px 10px;
      font-size 12px;
      white-space nowrap;
    }
    th{positionsticky;top0;background rgba(255,255,255,.96); z-index 2;}
    tdlast-child, thlast-child{border-rightnone}

     COLORES CELDAS 
    .cellFree{
      background var(--softOk);
      color#064e3b;
      cursorpointer;
      font-weight600;
    }
    .cellFreehover{outline1px solid rgba(4,120,87,.35)}

    .cellNA{opacity.35}

    .cellNon,
    .cellStruct{
      background var(--softBad);
      color#7f1d1d;
      cursorpointer;
      font-weight600;
    }
    .cellNonhover,
    .cellStructhover{
      outline1px solid rgba(185,28,28,.35);
    }

    .badge{
      displayinline-block;padding2px 8px;border-radius999px;
      border1px solid rgba(215,226,240,.95);
      background #fff;
      colorvar(--muted); font-size11px;
      font-weight800;
    }

    .modalBack{
      positionfixed; inset0; background rgba(15,23,42,.45);
      displayflex; align-itemscenter; justify-contentcenter;
      padding16px; z-index 999;
    }
    .modal{
      widthmin(720px, 100%);
      border1px solid var(--line);
      border-radius18px;
      background rgba(255,255,255,.98);
      padding14px;
      box-shadow 0 30px 80px rgba(15,23,42,.30);
      max-height calc(100vh - 32px);
      overflow auto;
    }

    .modal h3{margin0 0 8px 0}
    .modal .x{floatright}
    .hint{colorvar(--muted);font-size12px;margin-top6px}

    .kpi{displaygrid;grid-template-columnsrepeat(3,minmax(0,1fr));gap10px;margin-top10px}
    .kpi .box{
      border1px solid var(--line);
      border-radius14px;
      padding10px;
      background #fff;
      color var(--muted); font-size12px;
      box-shadow 0 10px 24px rgba(15,23,42,.06);
    }
    .kpi .box b{displayblock;colorvar(--text);font-size14px;margin-top2px}

    .weekPick{displayflex;gap8px;flex-wrapwrap;margin-top6px}
    .wchip{
      displayinline-flex;align-itemscenter;gap8px;
      padding8px 10px;border-radius999px;
      border1px solid var(--line);
      background #fff;
      color var(--text);
      cursorpointer;
      font-size12px;
      user-selectnone;
      box-shadow 0 10px 24px rgba(15,23,42,.06);
    }
    .wchiphover{border-color rgba(29,78,216,.30)}
    .wchip input{widthauto; margin0; accent-color var(--acc )}
    .wchip b{font-weight850}

    .mgrid{displaygrid;grid-template-columns1fr;gap10px}
    @media(min-width 640px){ .mgrid{grid-template-columns1fr 1fr} }
    .mgrid .full{grid-column1  -1}

    .loadingBar{
      position fixed;
      left 16px;
      right 16px;
      bottom 16px;
      z-index 2000;
      border 1px solid var(--line);
      border-radius 14px;
      background rgba(255,255,255,.96);
      backdrop-filter blur(8px);
      padding 10px 12px;
      displayflex;
      align-itemscenter;
      justify-contentspace-between;
      gap12px;
      box-shadow 0 20px 60px rgba(15,23,42,.20);
    }
    .loadingBar .txt{color var(--text); font-size 13px; font-weight800}
    .loadingBar .sub{color var(--muted); font-size 12px}
    .loadingBar .dot{
      width10px;height10px;border-radius50%;
      background rgba(29,78,216,.9);
      box-shadow 0 0 0 6px rgba(29,78,216,.14);
      animation pulse 1.2s infinite ease-in-out;
    }
    @keyframes pulse{
      0%{transformscale(.9); opacity.6}
      50%{transformscale(1.15); opacity1}
      100%{transformscale(.9); opacity.6}
    }

    .structStack{
      displayflex;
      flex-directioncolumn;
      gap12px;
      min-width0;
    }
    .structPanel{
      border1px solid var(--line);
      border-radius16px;
      background rgba(255,255,255,.96);
      padding12px;
      box-shadow 0 14px 32px rgba(15,23,42,.06);
      min-width0;
    }
    .structPanel h3{margin0 0 10px 0;colorvar(--muted);font-size14px;font-weight850}

    .filterBar{
      displayflex;
      gap10px;
      align-itemsflex-end;
      flex-wrapwrap;
      margin-top6px;
      min-width0;
    }
    .filterBar .field{
      min-width240px;
      flex1;
    }

    .summaryTable{
      width100%;
      border-collapsecollapse;
      margin-top8px;
      overflowhidden;
      border-radius12px;
    }
    .summaryTable th, .summaryTable td{
      border-bottom1px solid rgba(215,226,240,.9);
      padding8px 10px;
      font-size12px;
      text-alignleft;
      white-spacenowrap;
    }
    .summaryTable th{colorvar(--muted); font-weight900}

    .summaryKpiRow{
      displayflex; gap10px; flex-wrapwrap; margin-top8px;
    }
    .summaryKpi{
      border1px solid var(--line);
      border-radius12px;
      background#fff;
      padding8px 10px;
      font-size12px;
      colorvar(--muted);
      box-shadow 0 10px 24px rgba(15,23,42,.06);
    }
    .summaryKpi b{colorvar(--text)}

    .reportGrid{
      border1px solid var(--line);
      border-radius14px;
      background#fff;
      overflowhidden;
      box-shadow 0 14px 32px rgba(15,23,42,.06);
      margin-top10px;
    }
    .reportGrid table{width100%; border-collapsecollapse; min-width840px;}
    .reportGrid th, .reportGrid td{
      border-bottom1px solid rgba(215,226,240,.9);
      border-right1px solid rgba(215,226,240,.7);
      padding10px;
      vertical-aligntop;
      font-size12px;
      white-spacenormal;
    }
    .reportGrid th{
      positionsticky; top0; z-index2;
      background rgba(255,255,255,.98);
      colorvar(--muted);
      font-weight900;
    }
    .reportGrid tdlast-child, .reportGrid thlast-child{border-rightnone}
    .rchip{
      displayblock;
      border1px solid rgba(215,226,240,.95);
      border-radius12px;
      padding8px 10px;
      margin6px 0;
      background rgba(29,78,216,.05);
    }
    .rchip.struct{background rgba(4,120,87,.06)}
    .rchip b{displayblock;colorvar(--text);font-size12px;margin-bottom2px}
    .rchip small{colorvar(--muted)}
    .rhead{
      displayflex;gap8px;flex-wrapwrap;align-itemscenter;justify-contentspace-between;
    }

     ===== MEJORA huecos NO estructurales agrupados por ubicación ===== 
    .slotsByOr{
      displayflex;
      flex-directioncolumn;
      gap10px;
      margin-top10px;
    }
    .slotsRow{
      border1px solid var(--line);
      border-radius14px;
      background rgba(255,255,255,.96);
      box-shadow 0 10px 24px rgba(15,23,42,.06);
      padding10px;
      min-width0;
    }
    .slotsRowHead{
      displayflex;
      align-itemscenter;
      justify-contentspace-between;
      gap10px;
      margin-bottom8px;
      flex-wrapwrap;
    }
    .slotsRowTitle{
      font-weight900;
      colorvar(--text);
      font-size12px;
      displayflex;
      align-itemscenter;
      gap8px;
      min-width0;
    }
    .slotsRowTitle .badge{flex0 0 auto;}
    .slotsRowChips{
      displayflex;
      gap8px;
      flex-wrapwrap;
      min-width0;
    }
  
     --- Equipos quirúrgicos (modal compacto + buscador) --- 
    .groupsWrap{margin-top8px}
    .groupsTools{displayflex;gap8px;align-itemscenter;margin8px 0 10px 0}
    .groupsTools input{
      flex1; padding10px 12px; border1px solid var(--line); border-radius12px;
      outlinenone; font-size13px; background#fff;
    }
    .groupsTools inputfocus{border-color rgba(29,78,216,.45); box-shadow 0 0 0 3px rgba(29,78,216,.10)}
    .groupsCount{colorvar(--muted); font-size12px; margin0 0 6px 0}
    .groupsList{max-height 70vh; overflowauto; padding-right6px}
     --- Equipos quirúrgicos tarjetas bonitas y compactas (accordion) --- 
.gGrid{displaygrid;grid-template-columnsrepeat(2,minmax(0,1fr));gap12px;margin-top12px}
@media (max-width 720px){ .gGrid{grid-template-columns1fr} }

.gTeamCard{
  border1px solid var(--line);
  border-radius18px;
  background linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.80));
  box-shadow 0 10px 26px rgba(15,23,42,.06);
  overflowhidden;
}
.gTeamCardhover{ box-shadow 0 14px 34px rgba(15,23,42,.10); transform translateY(-1px); transition .15s ease; }

.gTeamSummary{
  list-stylenone;
  padding12px 12px;
  cursorpointer;
  user-selectnone;
}
.gTeamSummary-webkit-details-marker{displaynone;}
.gTeamTopRow{
  displayflex; align-itemscenter; gap10px; flex-wrapwrap;
}
.gTeamCode{
  font-weight850;
  letter-spacing.3px;
  font-size13px;
  padding6px 10px;
  border-radius999px;
  background rgba(2,132,199,.10);
  border1px solid rgba(2,132,199,.20);
}
.gTeamMeta{
  displayflex; align-itemscenter; gap8px; flex1 1 auto; min-width160px; flex-wrapwrap;
  colorvar(--muted); font-size12px;
}
.gTeamMeta b{ colorvar(--text); font-weight750; }
.gTeamPill{
  padding4px 8px;
  border-radius999px;
  border1px solid var(--line);
  background rgba(255,255,255,.75);
  font-size12px;
  colorvar(--text);
}
.gTeamChevron{
  margin-leftauto;
  width30px; height30px;
  border-radius12px;
  displaygrid; place-itemscenter;
  border1px solid var(--line);
  background rgba(255,255,255,.70);
}
details[open] .gTeamChevron{ transform rotate(180deg); transition.15s ease; }

.gTeamBody{
  padding10px 12px 12px 12px;
  border-top1px solid rgba(148,163,184,.35);
  background rgba(248,250,252,.70);
}
.gLine{
  displayflex; flex-wrapwrap; align-itemscenter;
  gap6px;
  padding8px 10px;
  margin7px 0 0 0;
  border1px solid rgba(148,163,184,.25);
  border-radius14px;
  background rgba(255,255,255,.85);
  font-size12.5px;
  line-height1.25;
}
.gLinefirst-child{ margin-top0; }
.gLine .sep{ colorrgba(100,116,139,.75); }
.gLine a{ color inherit; text-decoration underline; text-underline-offset 2px; }
.gEmptyTeam{
  padding12px;
  colorvar(--muted);
  font-size12px;
}
 --- fin equipos quirúrgicos --- 
 --- Modal genérico --- 
  .modal{positionfixed;inset0;backgroundrgba(15,23,42,.45);displayflex;align-itemscenter;justify-contentcenter;z-index9999;padding16px}
  .modalCard{widthmin(640px,100%);backgroundvar(--card);border1px solid var(--line);border-radius16px;box-shadow0 10px 30px rgba(2,6,23,.25);padding14px}
  .modalTop{displayflex;align-itemscenter;justify-contentspace-between;gap10px}
  .modalTitle{font-weight900;font-size16px}
  .iconBtn{border1px solid var(--line);background#fff;border-radius12px;padding6px 10px;cursorpointer}
  textarea{width100%;padding10px;border1px solid var(--line);border-radius12px;resizevertical;font-familyinherit}
  .label{font-size12px;colorvar(--muted);font-weight800;margin-bottom6px}


   ===============================
     Grupos quirúrgicos (UI mejorada)
     =============================== 
  .gToolbar{displayflex;gap10px;align-itemscenter;justify-contentspace-between;margin-top12px}
  .gSearchWrap{flex1;positionrelative}
  .gSearch{width100%;padding10px 12px;border1px solid var(--line);border-radius14px;background#fff}
  .gHint{font-size12px;colorvar(--muted);white-spacenowrap}
  .gGrid{displaygrid;grid-template-columnsrepeat(2,minmax(0,1fr));gap12px;margin-top12px}
  @media (max-width 720px){ .gGrid{grid-template-columns1fr} .gHint{displaynone} }
  .gCard{border1px solid var(--line);border-radius16px;background#fff;overflowhidden}
  .gCardTop{displayflex;align-itemsflex-start;justify-contentspace-between;gap10px;padding12px 12px 10px 12px;backgroundlinear-gradient(180deg, rgba(29,78,216,.06), rgba(29,78,216,0))}
  .gCardTitle{font-weight900;font-size14px;line-height1.2}
  .gCardSub{margin-top4px;font-size12px;colorvar(--muted);displayflex;flex-wrapwrap;gap6px}
  .pill{displayinline-flex;align-itemscenter;gap6px;padding4px 8px;border-radius999px;border1px solid var(--line);background#fff;font-size12px;colorvar(--muted)}
  .gCardBtns{displayflex;align-itemscenter;gap10px}
  .badge{min-width28px;height28px;border-radius999px;displayinline-flex;align-itemscenter;justify-contentcenter;font-weight900;border1px solid var(--line);background#fff;colorvar(--text)}
  .gCardBody{padding10px 12px 12px 12px}
  .gMembers{displayflex;flex-directioncolumn;gap8px}
  .gRow{padding10px 10px;border1px solid var(--line);border-radius14px;background#fff;displayflex;align-itemsflex-start;justify-contentspace-between;gap10px}
  .gRowL{min-width0}
  .gRowName{font-weight800;white-spacenowrap;overflowhidden;text-overflowellipsis}
  .gRowSpec{font-size12px;colorvar(--muted);margin-top2px;white-spacenowrap;overflowhidden;text-overflowellipsis}
  .gEmpty{border1px dashed var(--line);border-radius16px;padding14px;colorvar(--muted);background#fff;margin-top12px}
  .disclosure{cursorpointer;user-selectnone}
  .disclosure-webkit-details-marker{displaynone}
  details.gCard[open] .gCardTop{backgroundlinear-gradient(180deg, rgba(4,120,87,.07), rgba(4,120,87,0))}


   --- Modal a pantalla completa (para listas largas) --- 
  .modalBack .modal.full{
    widthmin(980px, 96vw);
    heightmin(92vh, 96vh);
    overflowauto;
    padding14px;
    border-radius18px;
  }
  .modalBack .modal.full #btnModalClose{
    positionsticky; top0;
    margin-leftauto;
    z-index2;
  }

   --- Equipos quirúrgicos lista simple --- 
  .teamTools{displayflex;gap10px;align-itemscenter;margin-top8px}
  .teamTools input{flex1;padding10px 12px;border1px solid var(--line);border-radius14px;background#fff}
  .teamList{displayflex;flex-directioncolumn;gap8px;margin-top8px}
  .teamList{displayflex;flex-directioncolumn;gap8px;margin-top8px}
  .teamCard{border1px solid var(--line);border-radius14px;background#fff;overflowhidden}
  .teamHead{displayflex;align-itemscenter;justify-contentspace-between;gap10px;padding10px 12px;backgroundlinear-gradient(180deg, rgba(29,78,216,.05), rgba(29,78,216,0))}
  .teamTitle{font-weight900;font-size14px;line-height1.1}
  .teamMeta{font-size12px;colorvar(--muted);margin-top2px}
  .teamBtns{displayflex;align-itemscenter;gap8px}
  .teamBody{padding10px 12px;border-top1px solid var(--line);displaygrid;grid-template-columnsrepeat(2,minmax(0,1fr));gap8px}
  @media (max-width 640px){ .teamBody{grid-template-columns1fr} }
  .memberItem{padding8px 10px;border1px solid var(--line);border-radius12px;background#fff}
  .memberName{font-weight800;font-size13px;line-height1.15}
  .memberSpec{font-size12px;colorvar(--muted);margin-top2px;white-spacenowrap;overflowhidden;text-overflowellipsis}
  
   --- Equipos (modal) ultra-compacto --- 
  .teamCard{padding10px 10px 8px}
  .teamHead{margin-bottom6px}
  .teamTitle{font-size13px}
  .teamMeta{font-size11px}
  .teamBody{displayflex;flex-directioncolumn;gap4px;margin-top6px}
  .memberLine{
    displayflex;
    flex-wrapwrap;
    gap6px;
    align-itemsbaseline;
    padding3px 0;
    border-top1px dashed var(--line);
  }
  .teamBody .memberLinefirst-child{border-topnone}
  .mlName{font-weight700;font-size12.5px}
  .mlRole,.mlSpec,.mlContact{font-size12px;colorvar(--muted)}
  .mlContact a{colorinherit;text-decorationnone;border-bottom1px dotted rgba(0,0,0,.25)}
  .mlSep{colorvar(--muted);font-size12px}
.toggleBtn{border1px solid var(--line);background#fff;border-radius12px;padding6px 10px;cursorpointer;font-size12px}


   --- Columna derecha anclada (layout 11) --- 
  @media(min-width 980px){
    .rightCol{positionsticky; top12px; align-selfstart; displayflex; flex-directioncolumn; gap12px; heightcalc(100vh - 24px); overflowauto; padding-right2px}
  }
   Equipos quirúrgicos lista 11 con el menú (botones en .actions) 
  #groupsPanelList .btn{
    justify-contentspace-between;
    text-alignleft;
    white-spacenormal;
    line-height1.2;
    padding10px 12px;
  }
  #groupsPanelList .btn .sub{
    displayblock;
    font-size12px;
    colorvar(--muted);
    font-weight700;
    margin-top4px;
  }


   (seguimos ocultando el panel lateral antiguo) 
  #groupsSideBack, #groupsPanel{displaynone !important}

 --- Modal centrado compacto (info bloque) --- 
  #modalBack{align-itemscenter !important; justify-contentcenter !important;}
  #modalBack .modal{widthmin(560px,92vw) !important; max-height86vh; overflowauto; backgroundvar(--card) !important;}


   --- Modal centrado (solo cuando está visible) + cerrar claro --- 
  #modalBack.hide{displaynone !important;}
  #modalBacknot(.hide){
    displayflex;
    align-itemscenter;
    justify-contentcenter;
    padding18px;
  }
  #modalBack .modal{
    widthmin(560px, 92vw);
    max-height86vh;
    overflowauto;
    margin0;
    backgroundvar(--card);
  }
  .iconBtn{
    border1px solid var(--line);
    background#fff;
    border-radius12px;
    padding6px 10px;
    cursorpointer;
    font-weight900;
    line-height1;
  }


   --- Modal BLOQUE (minimalista, centrada, sin oscurecer) --- 
  #modalBack.noDim{backgroundtransparent !important;}
  #modalBack.noDim.hide{displaynone !important;}
  #modalBack.noDimnot(.hide){
    displayflex; align-itemscenter; justify-contentcenter;
    padding16px;
  }
  #modal.miniBlock{
    widthmin(420px, 92vw);
    max-height78vh;
    overflowauto;
    border-radius16px;
  }
  #modalTitle.blockTitle{
    font-size13px;
    font-weight800;
    colorvar(--muted);
    margin0;
  }
  .blkWrap{displayflex;flex-directioncolumn;gap10px}
  .blkGrid{displaygrid;grid-template-columns 120px minmax(0,1fr);gap8px 10px}
  .blkK{font-size12px;colorvar(--muted);font-weight800}
  .blkV{font-size13px;colorvar(--text);font-weight800;overflowhidden;text-overflowellipsis;white-spacenowrap}
  .blkBtnRow{displayflex;justify-contentflex-end;gap10px;margin-top4px}


   --- Modal centrado ligero (diálogo de bloque) --- 
  #modalBack.hide{displaynone !important;}
  #modalBacknot(.hide){
    displayflex;
    align-itemscenter;
    justify-contentcenter;
    padding18px;
    backgroundrgba(15,23,42,.08);  muy suave 
  }
  #modalBack .modal{
    widthmin(520px, 92vw);
    max-height86vh;
    overflowauto;
    margin0;
    backgroundvar(--card);
    border1px solid var(--line);
    border-radius16px;
    box-shadow0 18px 40px rgba(2,6,23,.18);
  }
  .iconBtn{
    border1px solid var(--line);
    background#fff;
    border-radius12px;
    padding6px 10px;
    cursorpointer;
    font-weight950;
    line-height1;
  }
  .iconBtnhover{filterbrightness(.98)}
  .dlgGrid{displaygrid;grid-template-columns120px minmax(0,1fr);gap8px 10px;margin-top10px}
  .dlgK{font-size12px;colorvar(--muted);font-weight800}
  .dlgV{font-size13px;colorvar(--text);font-weight800;overflowhidden;text-overflowellipsis;white-spacenowrap}
  .dlgActions{displayflex;justify-contentflex-end;gap10px;margin-top12px}


   --- Centrado perfecto en escritorio --- 
  #modalBack{
    positionfixed !important;
    inset0 !important;
  }
  #modalBacknot(.hide){
    displayflex !important;
    align-itemscenter !important;
    justify-contentcenter !important;
  }


   --- Evitar cortes en textos del diálogo --- 
  .dlgV{white-spacenormal !important; overflowvisible !important; text-overflowclip !important;}
  .dlgGrid{align-itemsstart;}


  #swapModal.modal{
    positionfixed;
    inset0;
    displaynone;
    align-itemscenter;
    justify-contentcenter;
    padding18px;
    backgroundrgba(15,23,42,.08);
    z-index10000;
  }
  #swapModal .modalCard{
    widthmin(520px, 92vw);
    max-height86vh;
    overflowauto;
    backgroundvar(--card);
    border1px solid var(--line);
    border-radius16px;
    box-shadow0 18px 40px rgba(2,6,23,.18);
    padding14px;
  }
  #swapModal .modalTop{
    displayflex;
    align-itemscenter;
    justify-contentspace-between;
    gap10px;
    padding0;
    border-bottom1px solid var(--line);
    margin-bottom10px;
    padding-bottom10px;
  }
  #swapModal .modalTitle{font-weight950}
  #swapModal textarea{
    width100%;
    padding10px 12px;
    border1px solid var(--line);
    border-radius14px;
    resizevertical;
  }
  #swapModal .label{font-size12px;colorvar(--muted);font-weight800;margin-bottom6px}


   --- FIX centrado (desktop) para evitar descuadre --- 
  #modalBack{
    positionfixed !important;
    left0 !important; top0 !important; right0 !important; bottom0 !important;
    width100vw !important;
    height100vh !important;
    margin0 !important;
  }
  #modalBack.hide{displaynone !important;}
  #modalBacknot(.hide){
    displayflex !important;
    align-itemscenter !important;
    justify-contentcenter !important;
    padding18px !important;
  }
  #modalBack .modal{
    positionrelative !important;
    leftauto !important;
    rightauto !important;
    transformnone !important;
    margin0 !important;
  }

   Diálogo Solicitud de cambio centrado absoluto y consistente 
  #swapModal.modal{
    positionfixed !important;
    left0 !important; top0 !important; right0 !important; bottom0 !important;
    width100vw !important;
    height100vh !important;
    margin0 !important;
    displaynone;
    align-itemscenter !important;
    justify-contentcenter !important;
    padding18px !important;
  }
  #swapModal .modalCard{
    margin0 !important;
    transformnone !important;
  }


   --- Swap modal (Solicitud de cambio) igual que diálogo --- 
  #swapModal.modal{
    positionfixed !important;
    inset0 !important;
    displaynone;
    align-itemscenter !important;
    justify-contentcenter !important;
    padding18px !important;
    backgroundrgba(15,23,42,.08) !important;
    z-index10000 !important;
  }
  #swapModal .modalCard{
    widthmin(520px, 92vw) !important;
    max-height86vh !important;
    overflowauto !important;
    backgroundvar(--card) !important;
    border1px solid var(--line) !important;
    border-radius16px !important;
    box-shadow0 18px 40px rgba(2,6,23,.18) !important;
    padding14px !important;
    margin0 !important;
  }
  #swapModal .modalTop{
    displayflex;
    align-itemscenter;
    justify-contentspace-between;
    gap10px;
    padding0 0 10px 0;
    border-bottom1px solid var(--line);
    margin0 0 10px 0;
  }
  #swapModal .modalTitle{font-weight950}
  #swapModal .label{font-size12px;colorvar(--muted);font-weight800;margin-bottom6px}
  #swapModal textarea{
    width100%;
    padding10px 12px;
    border1px solid var(--line);
    border-radius14px;
    resizevertical;
  }


   --- Chapa y pintura diálogo de bloque más simple --- 
  #modalTitleempty{displaynone;}
  .dlgGrid.compact{grid-template-columns92px minmax(0,1fr); gap6px 10px; margin-top6px;}
  .dlgGrid.compact .dlgK{font-size12px;}
  .dlgGrid.compact .dlgV{font-size13px; font-weight850;}
  .dlgSection{margin-top10px; padding-top10px; border-top1px solid var(--line);}
  .dlgFooter{margin-top14px; padding-top12px; border-top1px solid var(--line);}


   --- Compactar diálogo de bloque --- 
  .dlgSection{margin-top8px; padding-top8px;}
  .dlgFooter{margin-top10px; padding-top10px;}
  .dlgActions{gap8px;}
  .dlgGrid.compact{margin-bottom6px;}


   --- Ultra compacto reducir espacios y separadores --- 
  #modalBack .modal .modalBody{padding14px !important;}
  .dlgSection{margin-top8px !important; padding-top0 !important; border-topnone !important;}
  .dlgFooter{margin-top12px !important; padding-top0 !important; border-topnone !important;}
  .dlgGrid.compact{gap6px 12px !important;}
  .dlgK{line-height1.2;}
  .dlgV{line-height1.25;}


   --- Centrar texto en diálogo --- 
  #modalBack .modal .modalBody { text-align center; }
  .dlgGrid.compact { justify-items center; }
  .dlgGrid.compact .dlgK { text-align right; }
  .dlgGrid.compact .dlgV { text-align left; }
  @media (max-width 640px){
    .dlgGrid.compact .dlgK,
    .dlgGrid.compact .dlgV { text-align center; }
  }


   --- Master evitar cortes y apelotonamiento --- 
  #modal.wide{ widthmin(920px, 94vw) !important; }
  #modalForm{ text-alignleft; }
  #modalForm label{ displayblock; font-size12px; colorvar(--muted); font-weight800; margin-bottom6px;}
  #modalForm input, #modalForm select{
    width100%;
    border1px solid var(--line);
    border-radius14px;
    padding10px 12px;
    background#fff;
  }
  #modalForm .actions{ displayflex; justify-contentflex-end; gap10px; }
  #modalForm .hint{ colorvar(--muted); font-size12px; line-height1.25; }


   --- Master formulario más ordenado y compacto --- 
  #modalForm{ text-alignleft; }
  #modalForm .formGrid{
    displaygrid;
    grid-template-columns 1fr 1fr;
    gap10px 12px;
    margin-top2px;
  }
  #modalForm .field{ min-width0; }
  #modalForm .span2{ grid-column 1  -1; }
  #modalForm label{
    displayblock;
    font-size12px;
    colorvar(--muted);
    font-weight800;
    margin0 0 6px 0;
  }
  #modalForm input, #modalForm select{
    width100%;
    border1px solid var(--line);
    border-radius14px;
    padding10px 12px;
    background#fff;
  }
  #modalForm .hint{
    colorvar(--muted);
    font-size12px;
    line-height1.25;
  }
  #modalForm .actions{
    displayflex;
    justify-contentflex-end;
    gap10px;
    margin-top12px;
  }
  #modalForm .msg{ margin-top10px; }


   --- Master modal ancho sin cortes --- 
  #modal.wide{ widthmin(920px, 94vw) !important; max-height86vh !important; }
  #modal.wide .modalBody{ max-heightcalc(86vh - 40px) !important; overflowauto !important; }


   --- Master modo edición inline dentro del mismo diálogo --- 
  #blockView.hide{displaynone !important;}
  #modalForm.hide{displaynone !important;}
  #modalForm{ margin-top10px; }


   --- Master botones siempre visibles en edición --- 
  #modalForm .actions{
    position sticky;
    bottom 0;
    background var(--card);
    padding-top 10px;
  }


   --- Fix botones edición visibles --- 
  #modalActions.actions{
    displayflex !important;
    justify-contentflex-end !important;
    gap10px !important;
    margin-top12px !important;
  }
  #modalForm{ padding-bottom6px; }


  #modal.wide .modalBody{ padding-bottom18px !important; }


   --- Master diálogo ultra discreto --- 
  .masterMini{ padding10px !important; margin-top8px !important; }
  .masterMini .dlgActions{ margin0 !important; }
  .masterMini .btn{ padding8px 12px !important; border-radius14px !important; }
  #modalBack .modal{ widthmin(520px, 92vw) !important; }


   --- Evitar que el modal quede cortado por arriba --- 
  #modalBack{
    align-itemscenter !important;
    justify-contentcenter !important;
    padding18px !important;
  }
  #modal{
    margin0 !important;
    max-heightcalc(100vh - 36px) !important;
  }
  #modal .modalBody{
    max-heightcalc(100vh - 110px) !important;
    overflowauto !important;
  }


   --- Modal compacto sin scroll innecesario --- 
  #modalBack{
    positionfixed !important;
    inset0 !important;
    displayflex !important;
    align-itemscenter !important;
    justify-contentcenter !important;
    padding18px !important;
  }
  #modal{
    max-heightcalc(100vh - 36px) !important;
    overflowvisible !important;
  }
  #modal .modalBody{
    overflowvisible !important;
    max-heightnone !important;
  }
  .miniLines{
    displayflex;
    flex-directioncolumn;
    gap8px;
    text-aligncenter;
    padding4px 0;
  }
  .miniLine{
    font-size13px;
    font-weight850;
  }
  .miniSub{
    font-size12px;
    font-weight700;
    colorvar(--muted);
  }


 === Reporte visual compacto === 
.structReportScroll{ overflow-xauto; padding-bottom6px; }
.structReportTable{ widthmax-content; border-collapseseparate; border-spacing0; }
.structReportTable th, .structReportTable td{ border1px solid rgba(148,163,184,.35); padding6px; vertical-aligntop; }
.structReportTable thead th{ positionsticky; top0; backgroundvar(--card); z-index2; }
.structReportTable .srLoc{ left0; z-index3; positionsticky; }
.structReportTable .srLocCell{ positionsticky; left0; backgroundvar(--card); z-index1; font-weight700; min-width160px; }
.structReportTable .srDay{ text-aligncenter; min-width240px; }
.structReportTable .srSess{ text-aligncenter; width120px; font-size12px; opacity.9; }
.srDayTop{ font-weight800; }
.srDayKey{ font-size11px; opacity.75; margin-top2px; }
.srCell{ min-width120px; }
.srCellStack{ displayflex; flex-directioncolumn; gap4px; }
.srEmpty{ font-size12px; opacity.6; padding2px 0; }
.srCard{ width100%; border1px solid rgba(0,0,0,.14); text-alignleft; padding6px 8px; border-radius10px; background#fff; color#0f172a; cursorpointer; }
.srCardhover{ filterbrightness(0.95); }
.srCardTop{ displayflex; align-itemscenter; justify-contentspace-between; gap6px; }
.srLabel{ font-weight800; font-size12px; white-spacenowrap; overflowhidden; text-overflowellipsis; max-width110px; }
.srTime{ font-size12px; opacity.95; white-spacenowrap; }


 ===== STRUCT REPORT COMPACT STYLES ===== 
.srWrap{ overflow-xauto; border1px solid #ddd; border-radius10px; padding8px; background#fff; }
.srGrid{
  displaygrid;
  grid-template-columns 180px repeat(14, minmax(92px, 1fr));
  gap6px;
  align-itemsstart;
}
.srHead{ font-weight700; text-aligncenter; background#f3f4f6; padding6px 4px; border-radius8px; }
.srLocHead{ positionsticky; left0; z-index3; background#f3f4f6; }
.srSubHead{ font-size12px; text-aligncenter; background#fafafa; padding4px 0; border-radius8px; }
.srLocHead2{ positionsticky; left0; z-index2; background#fafafa; }
.srLoc{
  positionsticky; left0; z-index1;
  background#ffffff;
  border1px solid #eee;
  border-radius10px;
  padding8px 10px;
  font-weight700;
  white-spacenowrap;
  overflowhidden;
  text-overflowellipsis;
}
.srCell{ min-height44px; border1px dashed #e5e7eb; border-radius10px; padding4px; }
.srCell.srEmpty{ background#fcfcfd; }
.srCard{
  width100%;
  border0;
  background#2e7d32;
  color#fff;
  border-radius10px;
  padding6px 8px;
  margin0 0 4px 0;
  cursorpointer;
  text-alignleft;
  line-height1.1;
}
.srCardhover{ filterbrightness(1.05); }
.srCardTop{ displayflex; justify-contentspace-between; gap8px; align-itemscenter; }
.srLabel{ font-weight800; font-size12px; white-spacenowrap; overflowhidden; text-overflowellipsis; }
.srTime{ font-size11px; opacity.95; white-spacenowrap; }
.srMore{ font-size11px; color#6b7280; padding2px 4px; }
.srModalBackdrop{
  positionfixed; inset0;
  backgroundrgba(0,0,0,.25);
  displayflex;
  align-itemscenter; justify-contentcenter;
}
.srModalBackdrop.hide{ displaynone; }
.srModal{
  widthmin(360px, 92vw);
  background#fff;
  border-radius14px;
  box-shadow0 12px 30px rgba(0,0,0,.25);
  padding12px 14px;
}
.srModalRow{ displayflex; justify-contentspace-between; align-itemscenter; gap10px; }
.srModalTitle{ font-weight800; font-size14px; }
.srModalCloseX{
  border0; background#f3f4f6;
  border-radius10px;
  width34px; height34px;
  cursorpointer;
}
.srModalBody{ margin-top8px; font-size13px; }
.srModalActions{ margin-top10px; displayflex; justify-contentflex-end; }

style
head

body
  div class=wrap
    div class=topbar
      div class=brand
        img class=logo src=httpsceovlnst.github.ioprogramacionh9oog-image.png alt=QuirófanosH9O 
        div
          h1QuirófanosH9Oh1
          small id=appSubtitleSolicitud de quirófanosmall
        div
      div

      div class=row
        div class=pill id=pillSession
          smallUsuariosmall span id=pillUser—span
          smallPerfilsmall span id=pillRole—span
        div
        button class=btn small ghost hide id=btnLogoutSalirbutton
      div
    div

    div class=grid
      !-- LEFT --
      div class=card
        h2Accesoh2

        labelPIN (contraseña)label
        input id=pinInput type=password inputmode=numeric placeholder=Introduce tu PIN 

        div class=actions
          button class=btn primary id=btnLoginEntrarbutton
          button class=btn id=btnClearLimpiarbutton
        div

        div id=msgLogin class=msg hidediv

        div class=hrdiv

        div class=actions
          button class=btn id=btnToggleSignupDarme de altabutton
        div

        div id=signupBox class=hide
          h3 style=margin-top10pxAlta profesional (solo usuarios vithas)h3

          labelNombrelabelinput id=suNombre placeholder=Nombre 
          labelApellidoslabelinput id=suApellidos placeholder=Apellidos 
          labelServicio  Especialidadlabelselect id=suEspselect
          labelCorreolabelinput id=suCorreo placeholder=Correo electrónico 
          labelTeléfonolabelinput id=suTel placeholder=Teléfono 

          div class=actions
            button class=btn good id=btnSignupCompletar altabutton
          div
          div id=msgSignup class=msg hidediv
        div

        div class=hrdiv

        h2Panelh2
        div class=actions
          button class=btn hide id=btnGoReserveSolicitar quirófanobutton
          button class=btn hide id=btnGoMineMis solicitudesbutton

          button class=btn hide id=btnGoGridParrillabutton
          button class=btn hide id=btnGoStructGenerar Quirófanosbutton
          button class=btn hide id=btnGoWaitLista de esperabutton
          button class=btn hide id=btnGoReportReportebutton
                  button class=btn hide id=btnGoGroupsEquipos quirúrgicosbutton
div

        div id=msgMenu class=msg hidediv
      div

      !-- RIGHT --
      div class=rightCol
div class=card
        !-- USER RESERVAR --
        div id=viewReserve class=hide
          h2Solicitud de quirófanoh2
          div class=row
            div style=flex1;min-width260px
              labelFechalabel
              div class=row style=gap6px
                input id=rvDate type=date style=flex1;min-width0 
                button class=btn small id=btnRvPrevDay title=Día anterior←button
                button class=btn small id=btnRvNextDay title=Día siguiente→button
              div
            div
            div style=width160px
              labelDuración (h)label
              select id=rvHours
                option1optionoption2optionoption3optionoption4option
                option5optionoption6optionoption7optionoption8option
              select
            div
          div

          div class=actions
            button class=btn primary id=btnCheckSlotsVer disponibilidadbutton
            button class=btn warn hide id=btnOpenWaitlistFromReserveSolicitar lista de esperabutton
          div

          div id=slotsBox class=slotsdiv
          div id=msgReserve class=msg hidediv
        div

        !-- USER MIS RESERVAS --
        div id=viewMine class=hide
          h2Mis solicitudesh2

          div class=row
            div style=width220px
              labelHorizonte (días)label
              select id=mineDays
                option value=3030option
                option value=6060option
                option value=9090option
                option value=180180option
              select
            div
            div class=actions style=margin-top26px
              button class=btn primary id=btnLoadMineActualizarbutton
            div
          div

          div id=mineBox class=tableWrap style=margin-top10pxdiv
          div id=msgMine class=msg hidediv
        div

        !-- MASTER GRID --
        div id=viewGrid class=hide
          h2Parrilla quirúrgicah2
          div class=row
            div style=flex1;min-width260px
              labelFechalabel
              div class=row style=gap6px
                input id=gdDate type=date style=flex1;min-width0 
                button class=btn small id=btnGridPrevDay title=Día anterior←button
                button class=btn small id=btnGridNextDay title=Día siguiente→button
              div
            div
            div style=width160px; displaynone
              labelDuración (h) reservalabel
              select id=gdHours
                option1optionoption2optionoption3optionoption4option
                option5optionoption6optionoption7optionoption8option
              select
            div
            div class=actions style=margin-top26px
              button class=btn primary id=btnLoadGridCargar parrillabutton
div
          div

          div id=gridReserveInfo class=msg hide style=margin-top8pxdiv
          div class=kpi id=gridKpisdiv

          div class=actions style=margin-top8px
            button class=btn small id=btnToggleAdvancedBúsqueda avanzadabutton
          div
          div id=advancedBox class=hide style=margin-top4px
            labelQuirófanos incluidos en KPIslabel
            div id=orCalcChips class=weekPickdiv
          div

          div id=gridBox class=tableWrap style=margin-top10pxdiv
          div id=msgGrid class=msg hidediv
        div

        !-- MASTER ESTRUCTURALES + NO ESTRUCTURALES --
        div id=viewStruct class=hide
          h2Generar quirófanosh2

          div class=structStack
            !-- NO ESTRUCTURALES (ARRIBA) --
            div class=structPanel
              h3Crear quirófano NO estructural (Master)h3

              div class=row
                div style=flex1;min-width200px
                  labelFechalabel
                  input id=stNSDate type=date 
                div
                div style=width160px
                  labelDuración (h)label
                  select id=stNSDur
                    option1optionoption2optionoption3optionoption4option
                    option5optionoption6optionoption7optionoption8option
                    option9optionoption10optionoption11optionoption12option
                  select
                div
              div

              div class=row
                div style=flex1;min-width220px
                  labelUsuario (lista)label
                  select id=stNSDoctorSelect
                    option value=(Cargando profesionales…)option
                  select
                div
                div style=flex1;min-width220px
                  labelUsuario (email editable)label
                  input id=stNSDoctorEmail placeholder=nombre@vithas.es 
                div
              div

              div class=row
                div style=flex1;min-width220px
                  labelEtiqueta (grupo  cirujano)label
                  input id=stNSLabel placeholder=Ej Traumatología Dr. X 
                div
              div

              div class=actions
                button class=btn primary id=btnNSFindSlotsBuscar huecosbutton
                button class=btn good id=btnNSAssignSlotAsignar hueco seleccionadobutton
              div

              div id=stNSSlotsBox class=slotsdiv
              div id=msgStructNon class=msg hidediv
            div

            !-- EDITOR ESTRUCTURAL --
            div class=structPanel
              div class=actions style=margin-top0
                button class=btn id=btnNewStructNuevobutton
                button class=btn good id=btnSaveStructGuardarbutton
                button class=btn bad id=btnDeleteStructByIdEliminar por IDbutton
                button class=btn primary id=btnReloadStructActualizar listadobutton
              div

              div id=msgStructEdit class=msg hidediv

              div class=hrdiv
              h3Editor de programación estructuralh3

              div class=row
                div style=flex1;min-width240px
                  labelID (vacío = nuevo)label
                  input id=stId placeholder=(vacío para crear) 
                div
                div style=flex1;min-width240px
                  labelEquipo  Servicio (etiqueta)label
                  input id=stLabel placeholder=Ej Traumatología COTA 
                div
              div

              div class=row
                div style=flex1;min-width240px
                  labelQuirófanolabel
                  select id=stOrselect
                div
                div style=width160px
                  labelHora iniciolabel
                  select id=stStartHourselect
                div
                div style=width160px
                  labelDuración (h)label
                  select id=stDur
                    option1optionoption2optionoption3optionoption4option
                    option5optionoption6optionoption7optionoption8option
                    option9optionoption10optionoption11optionoption12option
                  select
                div
              div

              div class=row
                div style=flex1;min-width240px
                  labelIniciolabel
                  input id=stStartDate type=date 
                div
                div style=flex1;min-width240px
                  labelFin (vacío = 3112)label
                  input id=stEndDate type=date 
                div
              div

              labelDías de la semanalabel
              div class=row
                label style=displayflex;gap8px;align-itemscenterinput type=checkbox class=stDow value=MONDAYLlabel
                label style=displayflex;gap8px;align-itemscenterinput type=checkbox class=stDow value=TUESDAYMlabel
                label style=displayflex;gap8px;align-itemscenterinput type=checkbox class=stDow value=WEDNESDAYXlabel
                label style=displayflex;gap8px;align-itemscenterinput type=checkbox class=stDow value=THURSDAYJlabel
                label style=displayflex;gap8px;align-itemscenterinput type=checkbox class=stDow value=FRIDAYVlabel
                label style=displayflex;gap8px;align-itemscenterinput type=checkbox class=stDow value=SATURDAYSlabel
                label style=displayflex;gap8px;align-itemscenterinput type=checkbox class=stDow value=SUNDAYDlabel
              div

              div class=row
                div style=flex1;min-width240px
                  labelCadencialabel
                  select id=stCadence
                    option value=WEEKLYSemanalesoption
                    option value=MONTH_WEEKSCadencia personalizada (semanas del mes)option
                  select
                div

                div style=flex1;min-width240px id=boxWeekly
                  labelCada cuántas semanaslabel
                  select id=stIntervalWeeks
                    option1optionoption2optionoption3optionoption4option
                  select
                div

                div style=flex1;min-width240px id=boxMonthWeeks class=hide
                  labelSemanas del meslabel
                  div class=weekPick
                    label class=wchipinput type=checkbox class=stWom value=1b1bªlabel
                    label class=wchipinput type=checkbox class=stWom value=2b2bªlabel
                    label class=wchipinput type=checkbox class=stWom value=3b3bªlabel
                    label class=wchipinput type=checkbox class=stWom value=4b4bªlabel
                    label class=wchipinput type=checkbox class=stWom value=5b5bªlabel
                  div
                  div class=hintInterpretación por “1º3º lunes”, etc. según ellos weekday seleccionados.div
                div
              div
            div

            !-- LISTA ESTRUCTURAL --
            div class=structPanel
              h3Listado de programación estructuralh3

              div id=structSummary class=msg style=margin-top8pxdiv

              div class=hrdiv

              div class=filterBar
                div class=field
                  labelFiltrar por equipo (etiqueta)label
                  select id=structTeamFilter
                    option value=(Todos)option
                  select
                div

                div class=field
                  labelFiltrar por quirófanolabel
                  select id=structOrFilter
                    option value=(Todos)option
                  select
                div
                div class=field
                  labelFiltrar por hora de iniciolabel
                  select id=structHourFilter
                    option value=(Todas)option
                  select
                div
                div class=field
                  labelFiltrar por díalabel
                  select id=structDayFilter
                    option value=(Todos)option
                    option value=LLunesoption
                    option value=MMartesoption
                    option value=XMiércolesoption
                    option value=JJuevesoption
                    option value=VViernesoption
                    option value=SSábadooption
                    option value=DDomingooption
                  select
                div
                div
                  button class=btn small id=btnStructClearFilterQuitar filtrobutton
                div
              div

              div id=msgStruct class=msg hidediv
              div id=structList class=tableWrap style=margin-top10pxdiv
            div
          div
        div

        !-- MASTER WAIT (ACTUALIZADO a “función nueva”) --
        div id=viewWait class=hide
          h2Lista de esperah2

          div class=row
            div style=width260px
              labelMostrarlabel
              select id=wlFilter
                option value=pendingPendientes (sin pasadas)option
                option value=pendingAllPendientes (incluye pasadas)option
              select
            div
            div class=actions style=margin-top26px
              button class=btn primary id=btnLoadWaitActualizarbutton
            div
          div

          div id=msgWait class=msg hidediv
          div id=waitList style=margin-top10pxdiv
        div

        !-- MASTER REPORT --
        div id=viewReport class=hide
          h2Reporteh2
          div class=row
            div style=flex1;min-width260px
              labelEmail destinolabel
              input id=rpEmail placeholder=destino@... 
            div
          div
          div class=row
            div style=flex1;min-width220px
              labelIniciolabel
              input id=rpStart type=date 
            div
            div style=flex1;min-width220px
              labelFinlabel
              input id=rpEnd type=date 
            div
          div
          div class=actions
            button class=btn primary id=btnSendReportEnviar reporte (Dirección)button
          div
          div class=hintIncluye visión global y desglosa bProgramadob, bEspeciales (Híbrido)b y bUrgencias24hb. Métrica bhoras realesb (no número de eventos).div
          div id=msgReport class=msg hidediv

          div class=hrdiv

          div class=rhead
            h3 style=margin0Reporte estructural (visual)h3
            div class=actions style=margin-top0
              button class=btn small primary id=btnStructVisualReportGenerar  actualizarbutton
            div
          div
          div class=hintDistribución de quirófanos estructurales por bdíab, bquirófanob y bsesiónb (mañanatarde).div
          div id=structVisualReport class=reportGrid hidediv
        div


        !-- MASTER EQUIPOS QUIRÚRGICOS --
        div id=viewGroups class=hide
          div class=row style=justify-contentspace-between;align-itemsflex-end;gap12px;flex-wrapwrap
            div
              h2 style=margin0Equipos quirúrgicosh2
              div class=mut id=groupsCount style=margin-top4px—div
            div
            div class=row style=gap8px;min-width280px;flex1;max-width520px
              input id=groupsSearch type=search placeholder=Buscar equipo, nombre, rol, email o teléfono… 
              button class=btn small ghost id=groupsClear type=buttonLimpiarbutton
            div
          div

          div id=groupsList class=groupsCompact style=margin-top10pxdiv
          div id=groupsEmpty class=mut style=margin-top10px;displaynoneNo hay resultados.div
        div


        !-- DEFAULT --
        div id=viewWelcome
          h2Bienvenidoh2
          div class=msg
            1) Introduce tu PIN.br
            2) Si no tienes PIN, pulsa b“Darme de alta”b.br
            3) Al acceder, verás el panel según tu perfil.
          div
        div
      div
    div
  div

  !-- Modal --
  div id=modalBack class=modalBack hide
    div class=modal id=modal
      
      h3 id=modalTitleDetalleh3
      div id=modalBody class=msgdiv

      
div id=modalForm class=hide style=margin-top10px
  div class=formGrid
    div class=field hide id=mfActionWrap
      labelAcciónlabel
      select id=mfAction disabled
        option value=STRUCT_EDIT_BLOCKEditar bloque estructuraloption
        option value=NON_EDITEditar bloque NO estructuraloption
      select
    div

    div class=field
      labelDuración (h)label
      select id=mfHours
        option1optionoption2optionoption3optionoption4option
        option5optionoption6optionoption7optionoption8option
        option9optionoption10optionoption11optionoption12option
      select
    div

    div class=field
      labelQuirófanolabel
      select id=mfOrselect
    div

    div class=field span2
      labelEtiquetalabel
      input id=mfLabel placeholder=Ej E COLO  COLO  MASTER 
    div

    div class=field span2 hint id=mfHintdiv
  div

  div id=modalActions class=actionsdiv
  div id=modalMsg class=msg hidediv
div

div
  div

  !-- Loading --
  div id=loadingBar class=loadingBar hide aria-live=polite
    div
      div class=txt id=loadingTextProcesando…div
      div class=sub id=loadingSubPor favor, esperadiv
    div
    div class=dot title=Procesandodiv
  div

script
   ===== CONSTANTES FRONT =====
  const OR_LIST = [
    Sótano 1,Sótano 2,Sótano 3,Sótano 4,Sótano 5,Sótano 6,
    Quirófano Híbrido,
    Centrales 1,Centrales 2,Centrales 3,Centrales 4,Centrales 5,Centrales 6,Centrales 7,Centrales 8,
    Maternidad 1,Maternidad 2,Maternidad 3,
    Urgencias,
    Paritorio 1,Paritorio 2
  ];

  const SPECIALTIES = [
    Traumatología y Cirugía Ortopédica,
    Cirugía General y Digestiva,
    Anestesiología y Reanimación,
    Ginecología y Obstetricia,
    Urología,
    Oftalmología,
    Otorrinolaringología (ORL),
    Neurocirugía,
    Cirugía Vascular,
    Cirugía Torácica,
    Cirugía Cardíaca,
    Cirugía Plástica, Estética y Reparadora,
    Cirugía Maxilofacial,
    Cirugía Pediátrica,
    Otros
  ];

  function fillSpecialties(){
    const sel = $(suEsp);
    if(!sel) return;
    if(sel.dataset.filled) return;
    sel.innerHTML = 'option value=(Selecciona)option' + SPECIALTIES.map(s=`option value=${escapeHtml(s)}${escapeHtml(s)}option`).join();
    sel.dataset.filled = 1;
  }


  const S = {
    pin null,
    role null,            Master  Usuario
    doctor null,
    emailVisible null,

    lastSlots [],
    lastReserveQuery null,
    lastGrid null,

    structRulesCache [],
    structTeamFilter ,
    structDayFilter ,
    structOrFilter ,
    structHourFilter ,
    orCalcSelected [],

    modalCtx null,

    doctorList [],
    doctorListLoaded false,

    masterNSQuery null,
    masterNSSlots [],
    masterNSSelectedIndex -1,

    groupsCache [],
    groupsByEquipo {},
    groupsLoaded false
  };

  const $ = (id)=document.getElementById(id);

  function showMsg(el, text, kind){
    if(!el) return;
    el.classList.remove(hide,ok,bad,warn);
    el.textContent = text  ;
    if(kind) el.classList.add(kind);
  }
  function hideMsg(el){
    if(!el) return;
    el.classList.add(hide);
    el.textContent = ;
    el.classList.remove(ok,bad,warn);
  }

  function setSessionPill(){
    $(pillUser).textContent = S.emailVisible  —;
    $(pillRole).textContent = (S.isMaster  Master  Usuario);
    $(btnLogout).classList.toggle(hide, !S.pin);

     Subtítulo dinámico
    const sub = $(appSubtitle);
    if(sub){
      sub.textContent = S.isMaster  Solicitud de quirófano + coordinación  Solicitud de quirófano;
    }

    document.body.classList.toggle(master, !!S.isMaster);

  }
  function hideAllViews(){
    [viewWelcome,viewReserve,viewMine,viewGrid,viewStruct,viewWait,viewReport,viewGroups]
      .forEach(v = $(v).classList.add(hide));
  }
  function go(viewId){
    hideAllViews();
    $(viewId).classList.remove(hide);
  }
  function isMaster(){ return S.role === Master  S.role === Administrador; }

   ===== FECHAS SIEMPRE MOSTRAR DDMMAAAA EN TEXTO =====
  function fmtDMY(dateStr){  YYYY-MM-DD - DDMMYYYY
    if(!dateStr) return ;
    const m = ^(d{4})-(d{2})-(d{2})$.exec(String(dateStr));
    if(!m) return String(dateStr);
    return `${m[3]}${m[2]}${m[1]}`;
  }
  function isoLocal(dateStr, hour){
     Devuelve ISO con offset local, p.ej. 2026-01-08T080000+0100
    const d = new Date(`${dateStr}T${String(hour).padStart(2,0)}0000`);
    const pad = (n)=String(Math.abs(n)).padStart(2,0);
    const off = -d.getTimezoneOffset();  minutos, positivo en UTC+X
    const sign = off=0  +  -;
    const hh = pad(Math.floor(Math.abs(off)60));
    const mm = pad(Math.abs(off)%60);
    const yyyy = d.getFullYear();
    const mo = String(d.getMonth()+1).padStart(2,0);
    const da = String(d.getDate()).padStart(2,0);
    const H = String(d.getHours()).padStart(2,0);
    const M = String(d.getMinutes()).padStart(2,0);
    const S = String(d.getSeconds()).padStart(2,0);
    return `${yyyy}-${mo}-${da}T${H}${M}${S}${sign}${hh}${mm}`;
  }


   menú quitar parrilla a usuarios generales
  function setMenuButtons(){
    const master = isMaster();
    $(btnGoReserve).classList.toggle(hide, !S.pin  master);
    $(btnGoMine).classList.toggle(hide, !S.pin  master);

    $(btnGoGrid).classList.toggle(hide, !S.pin);

    $(btnGoStruct).classList.toggle(hide, !S.pin  !master);
    $(btnGoWait).classList.toggle(hide, !S.pin  !master);
    $(btnGoReport).classList.toggle(hide, !S.pin  !master);
    $(btnGoGroups).classList.toggle(hide, !S.pin  !master);
  }

  function todayISO(){
    const d = new Date();
    d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
    return d.toISOString().slice(0,10);
  }
  function addDaysISO(n){
    const d = new Date();
    d.setDate(d.getDate() + n);
    d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
    return d.toISOString().slice(0,10);
  }

   Helper mover fechas en inputs date
  function shiftDate(inputId, deltaDays){
    const input = $(inputId);
    if(!input) return null;
    let val = input.value;
    if(!val){
      val = todayISO();
    }
    const d = new Date(val+T000000);
    d.setDate(d.getDate() + deltaDays);
    d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
    const iso = d.toISOString().slice(0,10);
    input.value = iso;
    return iso;
  }

   Navegación días
  function moveGridDay(delta){
    shiftDate(gdDate, delta);
    loadGrid();
  }
  function moveReserveDay(delta){
    shiftDate(rvDate, delta);
    checkSlots();
  }

   ===== Busy & google.script.run wrapper =====
  let sessionToken = 1;
  let busyCount = 0;
  const inFlightKeys = new Set();
  const disabledEls = new Set();

  function setBusy(isBusy, msg){
    const bar = $(loadingBar);
    const txt = $(loadingText);
    const sub = $(loadingSub);
    if(isBusy){
      busyCount++;
      txt.textContent = msg  Procesando…;
      sub.textContent = Por favor, espera;
      bar.classList.remove(hide);
    }else{
      busyCount = Math.max(0, busyCount - 1);
      if(busyCount === 0){
        bar.classList.add(hide);
        txt.textContent = Procesando…;
        sub.textContent = Por favor, espera;
      }
    }
  }

  function disableEls(els, disabled){
    const arr = Array.isArray(els)  els  [els];
    arr.filter(Boolean).forEach(el={
      if(disabled){
        el.disabled = true;
        disabledEls.add(el);
      }else{
        el.disabled = false;
        disabledEls.delete(el);
      }
    });
  }

  function resetAllBusyUI(){
    busyCount = 0;
    inFlightKeys.clear();
    $(loadingBar).classList.add(hide);
    for(const el of Array.from(disabledEls)){
      try{ el.disabled = false; }catch(_){}
    }
    disabledEls.clear();
  }

  
   🔧 URL del Worker (Cloudflare) que hace proxy al WebApp de Apps Script (para GitHub Pages)
   Ejemplo httpstu-worker.tudominio.workers.dev
  const API_WORKER_URL = httpsprogramacionh9o.ceo-vlnst.workers.dev;  URL del Worker (Cloudflare) - GAS

function callGAS(fnName, args, opt){
    const o = opt  {};
    const key = o.key  String(o.key)  ;
    if(key && inFlightKeys.has(key)) return;
    if(key) inFlightKeys.add(key);

    const myToken = sessionToken;
    setBusy(true, o.msg  Procesando…);
    disableEls(o.disable  [], true);

    const finalize = ()={
      if(key) inFlightKeys.delete(key);
      disableEls(o.disable  [], false);
      setBusy(false);
    };

    (async ()={
      try{
        if(!API_WORKER_URL){
          throw new Error(API_WORKER_URL no configurada en el index (URL del Worker).);
        }

        const resp = await fetch(API_WORKER_URL, {
          method POST,
          headers { Content-Typetextplain;charset=utf-8 },
          body JSON.stringify({ fn fnName, args args  [] })
        });

        const txt = await resp.text();
        let json;
        try{ json = JSON.parse(txt); }catch(_e){ throw new Error(Respuesta no-JSON del backend  + txt.slice(0,200)); }

        if(!json  json.ok !== true){
          throw new Error((json && json.error)  json.error  Error desconocido);
        }

        if(myToken !== sessionToken) { finalize(); return; }
        try{ o.onSuccess && o.onSuccess(json.data); } finally { finalize(); }

      }catch(err){
        if(myToken !== sessionToken) { finalize(); return; }
        console.error(API error, err);
        try{ o.onFailure && o.onFailure(err); } finally { finalize(); }
      }
    })();
  }

   ===== OR filter para KPIs parrilla =====
  function initOrCalcDefaults(){
    const exclude = new Set([Sótano 6,Quirófano Híbrido,Urgencias,Paritorio 1,Paritorio 2]);
    S.orCalcSelected = OR_LIST.filter(name = !exclude.has(name));
  }

  function buildOrCalcChips(){
    const box = $(orCalcChips);
    if(!box) return;
    box.innerHTML = ;
    const selected = new Set(S.orCalcSelected  []);
    OR_LIST.forEach(name={
      const lbl = document.createElement(label);
      lbl.className = wchip;
      const cb = document.createElement(input);
      cb.type = checkbox;
      cb.checked = selected.has(name);
      cb.onchange = ()={
        const set = new Set(S.orCalcSelected  []);
        if(cb.checked) set.add(name); else set.delete(name);
        S.orCalcSelected = Array.from(set);
        renderGridKpis();
      };
      const b = document.createElement(b);
      b.textContent = name;
      lbl.appendChild(cb);
      lbl.appendChild(b);
      box.appendChild(lbl);
    });
  }

  function getSelectedORsForCalc(){
    const arr = S.orCalcSelected  [];
    if(!arr.length) return OR_LIST.slice();
    return arr.slice();
  }

   ✅ NUEVO inferir duración del bloque NO estructural desde la fila
  function inferEventHoursInRow_(row, startIdx){
    const id = row.cells[startIdx].eventId;
    if(!id) return 1;
    let n = 0;
    for(let i = startIdx; i  row.cells.length; i++){
      if(row.cells[i].eventId !== id) break;
      n++;
    }
    return Math.max(1, n);
  }

   ===== LOGIN  LOGOUT =====
  function login(){
    hideMsg($(msgLogin));
    const pin = ($(pinInput).value  ).trim();
    if(!pin) return showMsg($(msgLogin), Introduce tu PIN., warn);

    callGAS(getDoctorByPin, [pin], {
      key login,
      disable [$(btnLogin), $(btnClear), $(pinInput)],
      msg Validando acceso…,
      onSuccess (doc)={
        S.pin = pin;
        
       precarga equipos quirúrgicos (para botón de cambio en parrilla)
      loadGroupsCache(true);
S.doctor = doc;
        const tipo = String(doc.tipo  doc.rol  ).trim();
        S.isMaster = ^(masteradministradoradmin)$i.test(tipo)  tipo.toLowerCase().includes(admin);
        S.role = S.isMaster  Administrador  Usuario;
        S.emailVisible = (doc.correo  doc.email  doc.mail  —);

        setSessionPill();
        setMenuButtons();
        hideMsg($(msgLogin));
        hideMsg($(msgMenu));

        if(isMaster()){
          go(viewGrid);
          $(gdDate).value = todayISO();
          loadGrid();
        } else {
          go(viewReserve);
          $(rvDate).value = addDaysISO(1);
          $(rvHours).value = 2;
        }
      },
      onFailure (e)= showMsg($(msgLogin), e.message  String(e), bad)
    });
  }

  function logout(){
    S.pin = null;
    S.role = null;
    S.isMaster = false;
    S.doctor = null;
    S.emailVisible = null;
    S.lastSlots = [];
    S.lastGrid = null;
    S.structRulesCache = [];
    S.modalCtx = null;
    S.doctorList = [];
    S.doctorListLoaded = false;
    S.masterNSQuery = null;
    S.masterNSSlots = [];
    S.masterNSSelectedIndex = -1;

    sessionToken++;
    resetAllBusyUI();
    setSessionPill();
    setMenuButtons();
    $(pinInput).value = ;
    hideMsg($(msgLogin));
    hideMsg($(msgMenu));
    go(viewWelcome);
  }

   ===== SIGNUP =====
  function toggleSignup(){
    $(signupBox).classList.toggle(hide);
    hideMsg($(msgSignup));
  }

  function signup(){
    hideMsg($(msgSignup));
    const data = {
      nombre    $(suNombre).value,
      apellidos $(suApellidos).value,
      especialidad $(suEsp).value,
      correo    $(suCorreo).value,
      telefono  $(suTel).value
    };
    callGAS(signupDoctor, [data], {
      keysignup,
      disable[$(btnSignup)],
      msgRegistrando alta…,
      onSuccess(res)={
        showMsg($(msgSignup), res.message  Alta completada., ok);
      },
      onFailure(e)={
        showMsg($(msgSignup), e.message  String(e), bad);
      }
    });
  }

   ===== RESERVAS (USUARIO) =====
  function checkSlots(){
    hideMsg($(msgReserve));
    $(slotsBox).innerHTML = ;
    $(btnOpenWaitlistFromReserve).classList.add(hide);

    const dateStr = $(rvDate).value;
    const hours = parseInt($(rvHours).value,10);

    if(!dateStr) return showMsg($(msgReserve), Selecciona una fecha., warn);

    callGAS(getDisponibilidadAuto, [S.pin, dateStr, hours], {
      keyslots,
      disable[$(btnCheckSlots)],
      msgBuscando huecos disponibles…,
      onSuccess(res)={
        S.lastSlots = res.slots  [];
        S.lastReserveQuery = { dateStr, hours };

        if(!res.slots  !res.slots.length){
          showMsg($(msgReserve), No hay huecos disponibles para esa fecha y duración., warn);
          $(btnOpenWaitlistFromReserve).classList.remove(hide);
          return;
        }

        const box = $(slotsBox);
        box.innerHTML = ;
        res.slots.forEach(iso={
          const d = new Date(iso);
          const btn = document.createElement(button);
          btn.className = slot;
          btn.textContent = `${d.toLocaleTimeString(es-ES,{hour2-digit,minute2-digit})}`;
          btn.onclick = ()=reserveSlot(iso, hours, dateStr);
          box.appendChild(btn);
        });
        showMsg($(msgReserve), Selecciona el hueco que prefieras., ok);
      },
      onFailure(e)={
        showMsg($(msgReserve), e.message  String(e), bad);
      }
    });
  }

  function reserveSlot(startISO, hours, dateStr){
    hideMsg($(msgReserve));
    if(!confirm(¿Confirmar la reserva en ese hueco)) return;

    callGAS(reservarAuto, [S.pin, startISO, hours], {
      keyreserve,
      msgCreando reserva…,
      onSuccess(res)={
        showMsg($(msgReserve), Reserva creada correctamente., ok);
      },
      onFailure(e)={
        showMsg($(msgReserve), e.message  String(e), bad);
      }
    });
  }

  function openWaitlistFromReserve(){
    hideMsg($(msgReserve));
    const q = S.lastReserveQuery;
    if(!q  !q.dateStr){
      return showMsg($(msgReserve), Primero busca disponibilidad para poder enviar a lista de espera., warn);
    }
    const note = prompt(Añade una nota opcional para la lista de espera (diagnóstico, prioridad, etc.),);

    callGAS(submitWaitlist, [S.pin, q.dateStr, q.hours, ANY, note  ], {
      keywaitlistFromReserve,
      msgEnviando solicitud a lista de espera…,
      onSuccess(res)={
        showMsg($(msgReserve), res.message  Solicitud enviada a lista de espera., ok);
      },
      onFailure(e)={
        showMsg($(msgReserve), e.message  String(e), bad);
      }
    });
  }

   ===== MIS RESERVAS (USUARIO) =====
  function loadMine(){
    hideMsg($(msgMine));
    $(mineBox).innerHTML = ;

    const days = $(mineDays).value  30;

    callGAS(getMyReservations, [S.pin, days], {
      keymine,
      disable[$(btnLoadMine)],
      msgCargando tus reservas…,
      onSuccess(res)={
        const list = res.reservations  [];
        if(!list.length){
          showMsg($(msgMine), No tienes reservas en el horizonte seleccionado., warn);
          return;
        }
        hideMsg($(msgMine));
        const wrap = $(mineBox);
        const table = document.createElement(table);
        const thead = document.createElement(thead);
        thead.innerHTML = trthFechaththHoraththFinththQuirófanoththTítulothththtr;
        table.appendChild(thead);
        const tbody = document.createElement(tbody);
        list.forEach(r={
          const tr = document.createElement(tr);
          tr.innerHTML = `
            td${escapeHtml(fmtDMY(r.date))}td
            td${escapeHtml(r.start)}td
            td${escapeHtml(r.end)}td
            td${escapeHtml(r.orName  )}td
            td${escapeHtml(r.title  )}td
          `;
          const tdBtn = document.createElement(td);
          const b = document.createElement(button);
          b.className = btn small bad;
          b.textContent = Cancelar;
          b.onclick = ()=cancelMyReservation(r.eventId);
          tdBtn.appendChild(b);
          tr.appendChild(tdBtn);
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        wrap.appendChild(table);
      },
      onFailure(e)={
        showMsg($(msgMine), e.message  String(e), bad);
      }
    });
  }

  function cancelMyReservation(eventId){
    if(!confirm(¿Seguro que quieres cancelar esta reserva)) return;
    callGAS(cancelReservation, [S.pin, eventId], {
      keycancelMy,
      msgCancelando reserva…,
      onSuccess(res)={
        showMsg($(msgMine), res.message  Reserva cancelada., ok);
        loadMine();
      },
      onFailure(e)={
        showMsg($(msgMine), e.message  String(e), bad);
      }
    });
  }

   ===== GRID =====
  function loadGrid(){
    hideMsg($(msgGrid));
    $(gridBox).innerHTML = ;
    $(gridKpis).innerHTML = ;

    const dateStr = $(gdDate).value  todayISO();
    $(gdDate).value = dateStr;

    callGAS(getGridOccupancy, [S.pin, dateStr], {
      keygrid,
      disable[$(btnLoadGrid)],
      msgCargando parrilla…,
      onSuccess(res)={
        S.lastGrid = res;
        renderGrid(res);
        renderGridKpis();
      },
      onFailure(e)={
        showMsg($(msgGrid), e.message  String(e), bad);
      }
    });
  }

  function renderGrid(data){
    const box = $(gridBox);
    box.innerHTML = ;
    if(!data  !data.rows  !data.rows.length){
      showMsg($(msgGrid), No hay información para esa fecha., warn);
      return;
    }
    hideMsg($(msgGrid));

    const table = document.createElement(table);
    const thead = document.createElement(thead);
    const trh = document.createElement(tr);
    const thOr = document.createElement(th);
    thOr.textContent = Quirófano;
    trh.appendChild(thOr);

    data.hoursOrder.forEach(h={
      const th = document.createElement(th);
      th.textContent = String(h).padStart(2,0)+00;
      trh.appendChild(th);
    });
    thead.appendChild(trh);
    table.appendChild(thead);

    const tbody = document.createElement(tbody);
    data.rows.forEach((row)={
      const tr = document.createElement(tr);
      const tdOr = document.createElement(td);
      tdOr.textContent = row.orName;
      tr.appendChild(tdOr);

      row.cells.forEach((cell, ci)={
        const td = document.createElement(td);
        td.dataset.orName = row.orName;
        td.dataset.hour = cell.hour;
        td.dataset.status = cell.status;
        td.dataset.date = data.date;

        if(cell.status === NA){
          td.className = cellNA;
          td.textContent = ;
        } else if(cell.status === FREE){
          td.className = cellFree;
          td.textContent = Libre;
        } else if(cell.status === NON){
          td.className = cellNon;
          td.textContent = cell.displayTitle  No estructural;
          td.dataset.cellIndex = String(ci);
        } else if(cell.status === STRUCT){
          td.className = cellStruct;
          td.textContent = cell.displayTitle  Estructural;
        }

        if(cell.status !== NA){
          if(cell.eventId) td.dataset.eventId = cell.eventId;
          if(cell.ruleId)  td.dataset.ruleId  = cell.ruleId;
          if(cell.label)   td.dataset.label   = cell.label;
          td.onclick = ()=onGridCellClick(td);
        }

        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    box.appendChild(table);
  }

  function renderGridKpis(){
    const box = $(gridKpis);
    box.innerHTML = ;
    if(!S.lastGrid  !S.lastGrid.rows) return;

    const selectedOrs = new Set(getSelectedORsForCalc());
    let free = 0, non = 0, struct = 0;

    S.lastGrid.rows.forEach(row={
      if(!selectedOrs.has(row.orName)) return;
      row.cells.forEach(c={
        if(c.status === FREE) free++;
        else if(c.status === NON) non++;
        else if(c.status === STRUCT) struct++;
      });
    });

    const mkBox = (title, val, desc)={
      const d = document.createElement(div);
      d.className = box;
      d.innerHTML = `span${escapeHtml(title)}spanb${val}bdiv${escapeHtml(desc)}div`;
      return d;
    };

    box.appendChild(mkBox(Huecos libres, free, Celdas libres en quirófanos seleccionados));
    box.appendChild(mkBox(Bloques no estructurales, non, Reservas no estructurales));
    box.appendChild(mkBox(Bloques estructurales, struct, Programación estructural ese día));
  }

  function buildEventBlockInfo(orName, eventId){
    const g = S.lastGrid;
    if(!g  !g.rows) return null;
    const row = g.rows.find(r = r.orName === orName);
    if(!row) return null;
    const hours = row.cells
      .filter(c = c.eventId === eventId)
      .map(c = c.hour);
    if(!hours.length) return null;
    hours.sort((a,b)=a-b);
    return {
      startHour hours[0],
      duration hours.length
    };
  }

  function buildBlockInfo(orName, eventId, ruleId){
     Devuelve {startHour, duration} buscando por eventId o, si falta, por ruleId
    const g = S.lastGrid;
    if(!g  !g.rows) return null;
    const row = g.rows.find(r = r.orName === orName);
    if(!row) return null;

    let hours = [];
    if(eventId){
      hours = row.cells.filter(c = c.eventId === eventId).map(c = c.hour);
    }
    if(!hours.length && ruleId){
      hours = row.cells.filter(c = c.ruleId === ruleId).map(c = c.hour);
    }
    if(!hours.length) return null;
    hours.sort((a,b)=a-b);
    return { startHour hours[0], duration hours.length };
  }


  function onGridCellClick(td){
    const status  = td.dataset.status;
    const orName  = td.dataset.orName;
    const hour    = parseInt(td.dataset.hour,10);
    const dateStr = td.dataset.date;
    const eventId = td.dataset.eventId  ;
    const ruleId  = td.dataset.ruleId  ;
    const label   = td.dataset.label  ;
    const cellIndex = parseInt(td.dataset.cellIndex  0, 10);

    const ctx = { status, orName, hour, dateStr, eventId, ruleId, label, cellIndex };

    if(!isMaster()){
      openModalInfo(ctx);
      return;
    }

    if(status === STRUCT){
      openModalStruct(ctx);
    } else if(status === NON){
      openModalNonStruct(ctx);
    } else if(status === FREE){
      openModalInfo(ctx);
    }
  }

   ===== MODAL =====
  function openModalBase(title, bodyHtml){
    setBlockModal(false);
    $(modalTitle).textContent = title;
    $(modalBody).innerHTML = bodyHtml;
    $(modalForm).classList.add(hide);
    $(modalActions).innerHTML = ;
    hideMsg($(modalMsg));
    $(modalBack).classList.remove(hide);
  }

  function setBlockModal(on){
    const mb = $(modalBack);
    const modal = $(modal);
    const title = $(modalTitle);
    if(!mb  !modal  !title) return;

    mb.classList.toggle(noDim, !!on);
    modal.classList.toggle(miniBlock, !!on);
    title.classList.toggle(blockTitle, !!on);
  }

  function teamFromLabel(label){
    const raw = String(label).trim();
    if(!raw) return ;
    let t = raw.replace(^Eb[s_-]i, ).trim();
    t = t.replace(s+g, ).trim();
    return t;
  }

  function swapButtonForTeam(team, ctx){
    if(!team) return ;
     construir diccionario de equipos
    const byTeam = {};
    (S.groupsCache[]).forEach(g={
      const tt = String(g.equipo).trim();
      if(!tt) return;
      if(!byTeam[tt]) byTeam[tt]=[];
      byTeam[tt].push(g);
    });

    let match = byTeam[team]  team  null;
    if(!match){
      const key = normalizeEquipoKey(team);
      match = Object.keys(byTeam).find(t = normalizeEquipoKey(t) === key)  null;
    }
    if(!match){
      if(!S.groupsLoaded) return `div class=mutCargando equipo…div`;
      return ;
    }

    const members = (byTeam[match][]).slice();
    members.sort((a,b)={
      const na = (a.cirujano  a.nombre  ).toString();
      const nb = (b.cirujano  b.nombre  ).toString();
      return na.localeCompare(nb,es);
    });

    const first = members[0]  {};
    const firstName = String(first.cirujano  first.nombre  —).trim();

    const emailObj = members.find(x=String(x.correox.email).trim());
    const hasEmail = !!String((emailObj && (emailObj.correoemailObj.email))  ).trim();

    if(!hasEmail){
      return `div class=mutEquipo b${escapeHtml(match)}b sin email en GruposQuirúrgicos.div`;
    }

     guarda contexto y crea botón
    S.selectedCellContext = ctx  null;
    return `
      div class=blkGrid style=margin-top6px
        div class=blkKEquipodivdiv class=blkV${escapeHtml(match)}div
        div class=blkKContactodivdiv class=blkV${escapeHtml(firstName)}div
      div
      div class=blkBtnRow
        button type=button class=btn good id=btnAskSwapFromBlock data-team=${escapeHtml(match)}Pedir cambiobutton
      div
    `;
  }

  function openBlockModal(ctx, titleText){
     precarga si hace falta
    if(!S.groupsLoaded) loadGroupsCache(true);

    setBlockModal(true);

    const t = titleText  Bloque;
    const date = ctx.dateStr  fmtDMY(ctx.dateStr)  ;
    const orName = ctx.orName  ;
    const h = (ctx.startHour!=null  String(ctx.startHour)  (ctx.hour!=null  String(ctx.hour)  ));
    const dur = (ctx.hours!=null  String(ctx.hours)  (ctx.duration!=null  String(ctx.duration)  ));
    const label = ctx.label  ;

    const body = `
      div class=blkWrap
        div class=blkGrid
          div class=blkKFechadivdiv class=blkV${escapeHtml(date—)}div
          div class=blkKQuirófanodivdiv class=blkV${escapeHtml(orName—)}div
          ${h  `div class=blkKHoradivdiv class=blkV${escapeHtml(h)}00div`  ``}
          ${dur  `div class=blkKDuracióndivdiv class=blkV${escapeHtml(dur)} hdiv`  ``}
          ${label  `div class=blkKEtiquetadivdiv class=blkV${escapeHtml(label)}div`  ``}
        div
        div id=blkSwapArea${swapButtonForTeam(teamFromLabel(label), ctx)  }div
      div
    `;

    openModalBase(t, body);

     wire button if present
    const btn = $(btnAskSwapFromBlock);
    if(btn){
      btn.onclick = ()={
        const team = (btn.getAttribute(data-team)  ).trim();
        openSwapModal(team, ctx  null);
      };
    }
  }


  function closeModal(){
    S.modalCtx = null;
    
    $(modal).classList.remove(wide);
    $(modalForm).classList.add(hide);
$(modalBack).classList.add(hide);
    hideMsg($(modalMsg));
  }

  function openModalInfo(ctx){
  if(!S.groupsLoaded) loadGroupsCache(true);

  const title = ;
  const startHour = (ctx.startHour!=null  ctx.startHour  ctx.hour);
  const startISO = ctx.startISO  (ctx.dateStr && startHour!=null  isoLocal(ctx.dateStr, startHour)  );

  S.modalCtx = Object.assign({}, ctx, {
    startHour,
    startISO,
    hours (ctx.hours!=null  ctx.hours  (ctx.inferredHours!=null  ctx.inferredHours  1))
  });
  S.selectedCellContext = S.modalCtx;

  const isStruct = (ctx.kind === STRUCT  ctx.isStructural === true  String(ctx.label).trim().toUpperCase().startsWith(E ));
  const h = (startHour!=null  startHour  0);
  const dur = Number(S.modalCtx.hours1);
  const endHour = (h + dur);
  const hh = String(h).padStart(2,0)+00;
  const eh = String(endHour).padStart(2,0)+00;

  const dmy = fmtDMY(ctx.dateStr)  —;
  const orName = ctx.orName  —;

  const sum = getTeamContactSummary(ctx.label);
  const team = sum.team  (String(ctx.label).trim().replace(^Eb[s_-]i,).trim())  —;
  const contact = sum.contact  —;
  const canAskSwap = !!(S.groupsLoaded && sum.team && (S.groupsCache[]).some(g=String(g.equipo).trim()===sum.team && String(g.correog.email).trim()));

   guardar para pedir cambio
  S._swapTeamFromBlock = canAskSwap  sum.team  ;

  const lines = `
    div class=miniLines
      div class=miniLine${escapeHtml(dmy)} · ${escapeHtml(orName)} · ${escapeHtml(hh)}–${escapeHtml(eh)} span class=miniSub(${dur} h)spandiv
      div class=miniLineEquipo ${escapeHtml(team)}div
      div class=miniLineContacto ${escapeHtml(contact)}div
    div
  `;

  const masterMini = isMaster()  `
    div class=dlgActions style=justify-contentcenter;margin-top10px
      button class=btn bad id=mCancelOcc type=button${isStruct  Cancelar solo este bloque  Eliminar este bloque}button
    div
    div id=mMsg class=mut style=margin-top8px;text-aligncenterdiv
  `  ``;

  const footer = `
    div class=dlgFooter style=margin-top12px
      div class=dlgActions style=justify-contentcenter;flex-wrapwrap
        button class=btn ghost id=btnCloseBottom type=buttonCerrarbutton
        button class=btn good id=btnAskSwapFooter type=button ${S._swapTeamFromBlock    disabled}Pedir cambiobutton
      div
    div
  `;

  openModalBase(title, lines + masterMini + footer);

  $(btnCloseBottom).onclick = ()=closeModal();

  const bswap = $(btnAskSwapFooter);
  if(bswap){
    bswap.onclick = ()={
      const t = (S._swapTeamFromBlock).trim();
      if(!t) return;
      openSwapModal(t, S.selectedCellContext  ctx  null);
    };
  }

  if(isMaster()){
    $(mCancelOcc).onclick = ()={
      if(isStruct) cancelStructBlock();
      else deleteNonStructBlock();
    };
  }
}

  function openModalFree(ctx){
    const body = `
      Hueco libren
      Fecha ${fmtDMY(ctx.dateStr)}n
      Quirófano ${ctx.orName}n
      Hora ${String(ctx.hour).padStart(2,0)}00n
      (Solo consulta desde la parrilla)
    `;
    openModalBase(Hueco libre, escapeHtml(body));
    wireAskSwapButton(ctx);
  }

  function openModalNonStruct(ctx){
    const g = S.lastGrid;
    const row = g.rows.find(r = r.orName === ctx.orName);
    const idx = Number.isFinite(ctx.cellIndex)  ctx.cellIndex  0;
    const inferredHours = row  inferEventHoursInRow_(row, idx)  1;

     calcular startHour real del bloque dentro de la fila (si ocupa varias celdas)
    let startHour = ctx.hour;
    if(row && ctx.eventId){
      let i = idx;
      while(i  0 && row.cells[i-1].eventId === ctx.eventId) i--;
      startHour = row.cells[i].hour  ctx.hour;
    }
    ctx.kind = NONSTRUCT;
    ctx.inferredHours = inferredHours;
    ctx.startHour = startHour;
    ctx.startISO = ctx.startISO  isoLocal(ctx.dateStr, startHour);

    openModalInfo(ctx);
  }

  function deleteNonStructBlock(){
    if(!S.modalCtx  !S.modalCtx.eventId) return;
    if(!confirm(¿Seguro que quieres ELIMINAR este quirófano NO estructural)) return;

    callGAS(masterDeleteEvent, [S.pin, S.modalCtx.eventId], {
      keydelNonStruct,
      msgEliminando quirófano no estructural…,
      onSuccess(res)={
        showMsg($(modalMsg), res.message  Bloque eliminado., ok);
        loadGrid();
        setTimeout(()=closeModal(), 800);
      },
      onFailure(e)={
        showMsg($(modalMsg), e.message  String(e), bad);
      }
    });
  }

  function prepareEditNonStructBlock(){
    if(!S.modalCtx) return;
    S.modalCtx.mode = NON_EDIT;

    $(modalForm).classList.remove(hide);
    $(mfAction).value = NON_EDIT;

    const mfOr = $(mfOr);
    mfOr.innerHTML = ;
    OR_LIST.forEach(o={
      const opt = document.createElement(option);
      opt.value = o;
      opt.textContent = o;
      mfOr.appendChild(opt);
    });
    mfOr.value = S.modalCtx.orName;

    $(mfLabel).value = S.modalCtx.label  MASTER;
    $(mfHours).value = String(S.modalCtx.hours  2);
    $(mfHint).textContent = Editarás SOLO este bloque NO estructural (mismo EventId).;
  }

  
  function openModalStruct(ctx){
    ctx.kind = STRUCT;
    ctx.isStructural = true;

    const info = buildBlockInfo(ctx.orName, ctx.eventId  , ctx.ruleId  );
    if(info){
      ctx.startHour = info.startHour;
      ctx.hour = info.startHour;
      ctx.hours = info.duration;
      ctx.startISO = ctx.startISO  (ctx.dateStr  isoLocal(ctx.dateStr, info.startHour)  );
    }else{
       fallback mínimo
      const h = (ctx.startHour!=null  ctx.startHour  ctx.hour);
      ctx.startISO = ctx.startISO  (ctx.dateStr && h!=null  isoLocal(ctx.dateStr, h)  );
      ctx.hours = ctx.hours  1;
    }

    openModalInfo(ctx);
  }



  function cancelStructBlock(){
    if(!S.modalCtx  !S.modalCtx.eventId) return;
    if(!confirm(¿Seguro que quieres cancelar este bloque estructural SOLO para este día)) return;

    const payload = {
      eventId S.modalCtx.eventId,    id de serie (informativo)
      startISO S.modalCtx.startISO,  ✅ clave para identificar la ocurrencia exacta
      hours S.modalCtx.hours,
      orName S.modalCtx.orName,
      ruleId S.modalCtx.ruleId  
    };

    callGAS(masterCancelStructuralOccurrence, [S.pin, payload], {
      keycancelStructBlock,
      msgCancelando bloque estructural…,
      onSuccess(res)={
        showMsg($(modalMsg), res.message  Bloque cancelado., ok);
        loadGrid();
        setTimeout(()=closeModal(), 800);
      },
      onFailure(e)={
        showMsg($(modalMsg), e.message  String(e), bad);
      }
    });
  }

  function prepareEditStructBlock(){
    if(!S.modalCtx) return;
    S.modalCtx.mode = STRUCT_EDIT_BLOCK;
    $(mfAction).value = STRUCT_EDIT_BLOCK;

    $(modalForm).classList.remove(hide);

    $(modal).classList.add(wide);
    
     Entrar en modo edición inline (oculta vista y muestra formulario)
    const bv = $(blockView);
    if(bv) bv.classList.add(hide);
    const bClose = $(btnCloseBottom); if(bClose) bClose.classList.add(hide);
    const bSwap = $(btnAskSwapFooter); if(bSwap) bSwap.classList.add(hide);
const mfOr = $(mfOr);
    mfOr.innerHTML = ;
    OR_LIST.forEach(o={
      const opt = document.createElement(option);
      opt.value = o;
      opt.textContent = o;
      mfOr.appendChild(opt);
    });
    mfOr.value = S.modalCtx.orName;

    $(mfLabel).value = S.modalCtx.label  MASTER;
    $(mfHours).value = String(S.modalCtx.hours  2);
    $(mfHint).textContent = Editarás SOLO este bloque se convertirá en NO estructural, sin modificar la serie original.;
  }

  function applyModalChanges(){
    if(!S.modalCtx) return;

    const label = $(mfLabel).value  MASTER;
    const hours = parseInt($(mfHours).value,10);
    const orName = $(mfOr).value;

    if(S.modalCtx.mode === STRUCT_EDIT_BLOCK){
      const payload = {
        eventId S.modalCtx.eventId,
        label,
        startISO S.modalCtx.startISO,
        hours,
        orName
      };

      callGAS(masterEditStructuralOccurrence, [S.pin, payload], {
        keyeditStructBlock,
        msgActualizando bloque estructural…,
        onSuccess(res)={
          showMsg($(modalMsg), res.message  Bloque actualizado., ok);
          loadGrid();
          setTimeout(()=closeModal(), 800);
        },
        onFailure(e)={
          showMsg($(modalMsg), e.message  String(e), bad);
        }
      });
      return;
    }

    if(S.modalCtx.mode === NON_EDIT){
      const payload = {
        eventId S.modalCtx.eventId,
        orName,
        startISO S.modalCtx.startISO,
        hours,
        label
      };

      callGAS(masterUpdateNonStructural, [S.pin, payload], {
        keyeditNonStruct,
        msgActualizando bloque NO estructural…,
        onSuccess(res)={
          showMsg($(modalMsg), res.message  Bloque actualizado., ok);
          loadGrid();
          setTimeout(()=closeModal(), 800);
        },
        onFailure(e)={
          showMsg($(modalMsg), e.message  String(e), bad);
        }
      });
      return;
    }
  }

  function editWholeSeriesFromRule(){
    if(!S.modalCtx  !S.modalCtx.ruleId){
      showMsg($(modalMsg), No se ha encontrado el RuleId para esta serie., bad);
      return;
    }
    const ruleId = S.modalCtx.ruleId;
    go(viewStruct);
    closeModal();

    if(!S.structRulesCache  !S.structRulesCache.length){
      callGAS(listStructuralRules, [S.pin], {
        keylistStructFromGrid,
        msgCargando reglas estructurales…,
        onSuccess(res)={
          S.structRulesCache = res.rules  [];
          renderStructFiltersAndList();
          loadRuleIntoEditor(ruleId);
        },
        onFailure(e)={
          showMsg($(msgStruct), e.message  String(e), bad);
        }
      });
    } else {
      renderStructFiltersAndList();
      loadRuleIntoEditor(ruleId);
    }
  }

   ===== ESTRUCTURALES (MASTER) =====
  function fillStructSelectors(){
    const stOr = $(stOr);
    if(stOr){
      stOr.innerHTML = ;
      OR_LIST.forEach(o={
        const opt = document.createElement(option);
        opt.value = o;
        opt.textContent = o;
        stOr.appendChild(opt);
      });
    }

    const stStartHour = $(stStartHour);
    if(stStartHour){
      stStartHour.innerHTML = ;
      for(let h=0; h24; h++){
        const opt = document.createElement(option);
        opt.value = h;
        opt.textContent = String(h).padStart(2,0)+00;
        stStartHour.appendChild(opt);
      }
      stStartHour.value = 8;
    }

    const mfOr = $(mfOr);
    if(mfOr){
      mfOr.innerHTML = ;
      OR_LIST.forEach(o={
        const opt = document.createElement(option);
        opt.value = o;
        opt.textContent = o;
        mfOr.appendChild(opt);
      });
    }

    const nsDur = $(stNSDur);
    if(nsDur){
      nsDur.value = 4;
    }
  }

  function syncCadenceUI(){
    const mode = $(stCadence).value;
    $(boxWeekly).classList.toggle(hide, mode !== WEEKLY);
    $(boxMonthWeeks).classList.toggle(hide, mode !== MONTH_WEEKS);
  }

  function clearStructEditor(){
    $(stId).value = ;
    $(stLabel).value = ;
    $(stOr).selectedIndex = 0;
    $(stStartHour).value = 8;
    $(stDur).value = 4;
    $(stStartDate).value = todayISO();
    $(stEndDate).value = ;
    document.querySelectorAll(.stDow).forEach(cb= cb.checked = false);
    document.querySelectorAll(.stWom).forEach(cb= cb.checked = false);
    $(stCadence).value = WEEKLY;
    $(stIntervalWeeks).value = 1;
    syncCadenceUI();
    hideMsg($(msgStructEdit));
  }

  function ruleToWeekdaysString(rule){
    const map = {
      MONDAYL, TUESDAYM, WEDNESDAYX, THURSDAYJ,
      FRIDAYV, SATURDAYS, SUNDAYD
    };
    return (rule.weekdays  []).map(w=map[w]  w).join(,);
  }

  
  function dedupeStructRulesClient(rules){
    const out = [];
    const seen = new Set(); // key per weekday
    (rules || []).forEach(r=>{
      if(!r) return;
      const label = String(r.label||"").trim().toLowerCase();
      const orName = String(r.orName||"").trim().toLowerCase();
      const sh = String(r.startHour);
      const days = Array.isArray(r.weekdays) ? r.weekdays : [];
      const keepDays = [];
      days.forEach(d=>{
        const k = label+"|"+orName+"|"+sh+"|"+String(d);
        if(seen.has(k)) return;
        seen.add(k);
        keepDays.push(d);
      });
      if(!keepDays.length) return;
      const clone = Object.assign({}, r);
      clone.weekdays = keepDays;
      out.push(clone);
    });
    return out;
  }

function renderStructFiltersAndList(){
    const rules = dedupeStructRulesClient(S.structRulesCache || []);

    const select = $(structTeamFilter);
    if(select){
      const labels = Array.from(new Set(rules.map(r=String(r.label  ).trim()).filter(Boolean))).sort((a,b)=a.localeCompare(b,es));
      select.innerHTML = 'option value=(Todos)option';
      labels.forEach(l={
        const opt = document.createElement(option);
        opt.value = l;
        opt.textContent = l;
        select.appendChild(opt);
      });
      select.value = S.structTeamFilter  ;
    }
    const daySel = $(structDayFilter);
    if(daySel){
      daySel.value = S.structDayFilter  ;
    }

    const orSel = $(structOrFilter);
    if(orSel){
      const ors = Array.from(new Set(rules.map(r=String(r.orName  r.location  ).trim()).filter(Boolean))).sort((a,b)=a.localeCompare(b,es));
      orSel.innerHTML = 'option value=(Todos)option';
      ors.forEach(o={
        const opt = document.createElement(option);
        opt.value = o;
        opt.textContent = o;
        orSel.appendChild(opt);
      });
      orSel.value = S.structOrFilter  ;
    }

    const hourSel = $(structHourFilter);
    if(hourSel){
      const hours = Array.from(new Set(rules.map(r=String(r.startHour  ).trim()).filter(Boolean))).map(h=Number(h)).filter(n=Number.isFinite(n)).sort((a,b)=a-b);
      hourSel.innerHTML = 'option value=(Todas)option';
      hours.forEach(h={
        const opt = document.createElement(option);
        opt.value = String(h);
        opt.textContent = String(h).padStart(2,0)+00;
        hourSel.appendChild(opt);
      });
      hourSel.value = S.structHourFilter  ;
    }


    const box = $(structList);
    const msg = $(msgStruct);
    box.innerHTML = ;
    hideMsg(msg);

    if(!rules.length){
      showMsg(msg, No hay reglas estructurales definidas., warn);
      $(structSummary).textContent = 0 reglas.;
      return;
    }

    const filtered = rules.filter(r={
      const okTeam = S.structTeamFilter  (String(r.label).trim() === S.structTeamFilter)  true;
      if(!okTeam) return false;

      const okOr = S.structOrFilter  (String(r.orNamer.location).trim() === S.structOrFilter)  true;
      if(!okOr) return false;

      const okHour = S.structHourFilter  (String(r.startHour  ).trim() === String(S.structHourFilter))  true;
      if(!okHour) return false;

      if(S.structDayFilter){
        const dKey = String(S.structDayFilter);
         rule.weekdays suele venir como [MONDAY, ...]
        const map = {LMONDAY,MTUESDAY,XWEDNESDAY,JTHURSDAY,VFRIDAY,SSATURDAY,DSUNDAY};
        const wantA = dKey;
        const wantB = map[dKey]  dKey;
        const arr = Array.isArray(r.weekdays)  r.weekdays.map(String)  [];
        const okDay = arr.includes(wantA)  arr.includes(wantB);
        if(!okDay) return false;
      }
      return true;
    });

    const table = document.createElement(table);
    const thead = document.createElement(thead);
    thead.innerHTML = trthIDththEquipoththQuirófanoththInicioththFinththHoraththDuraciónththCadenciaththDíasthtr;
    table.appendChild(thead);
    const tbody = document.createElement(tbody);

    filtered.forEach(r={
      const tr = document.createElement(tr);
      tr.innerHTML = `
        td${escapeHtml(r.id)}td
        td${escapeHtml(r.label  )}td
        td${escapeHtml(r.orName  )}td
        td${escapeHtml(fmtDMY(r.startDate  ))}td
        td${escapeHtml(fmtDMY(r.endDate  ))}td
        td${String(r.startHour).padStart(2,0)}00td
        td${r.durationHours} htd
        td${escapeHtml(r.cadenceNameEs  r.cadenceMode  )}td
        td${escapeHtml(ruleToWeekdaysString(r))}td
      `;
      tr.style.cursor = pointer;
      tr.onclick = ()=loadRuleIntoEditor(r.id);
      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    box.appendChild(table);

    $(structSummary).textContent = `${rules.length} reglas totales. Mostrando ${filtered.length}.`;
  }

  function refreshStructList(){
    hideMsg($(msgStruct));
    $(structList).innerHTML = ;
    $(structSummary).textContent = Cargando reglas…;

    callGAS(listStructuralRules, [S.pin], {
      keylistStruct,
      msgCargando programación estructural…,
      onSuccess(res)={
        S.structRulesCache = res.rules  [];
        renderStructFiltersAndList();
      },
      onFailure(e)={
        showMsg($(msgStruct), e.message  String(e), bad);
        $(structSummary).textContent = Error al cargar reglas.;
      }
    });
  }

  function loadRuleIntoEditor(id){
    const rule = (S.structRulesCache  []).find(r = r.id === id);
    if(!rule){
      showMsg($(msgStructEdit), No se ha encontrado esa regla., bad);
      return;
    }
    $(stId).value = rule.id  ;
    $(stLabel).value = rule.label  ;
    $(stOr).value = rule.orName  OR_LIST[0];
    $(stStartHour).value = String(rule.startHour  8);
    $(stDur).value = String(rule.durationHours  4);
    $(stStartDate).value = rule.startDate  ;
    $(stEndDate).value = rule.endDate  ;

    document.querySelectorAll(.stDow).forEach(cb={
      cb.checked = (rule.weekdays  []).includes(cb.value);
    });
    document.querySelectorAll(.stWom).forEach(cb={
      cb.checked = (rule.weeksOfMonth  []).map(String).includes(cb.value);
    });

    $(stCadence).value = rule.cadenceMode  WEEKLY;
    $(stIntervalWeeks).value = String(rule.intervalWeeks  1);
    syncCadenceUI();
    showMsg($(msgStructEdit), Regla cargada en el editor. Modifica y pulsa Guardar., ok);
  }

  function saveStructFromEditor(){
    hideMsg($(msgStructEdit));
    const weekdays = Array.from(document.querySelectorAll(.stDowchecked)).map(cb=cb.value);
    const weeksOfMonth = Array.from(document.querySelectorAll(.stWomchecked)).map(cb=cb.value);

    const payload = {
      id ($(stId).value  ).trim(),
      orName $(stOr).value,
      label $(stLabel).value,
      startDate $(stStartDate).value,
      endDate $(stEndDate).value,
      startHour $(stStartHour).value,
      durationHours $(stDur).value,
      cadenceMode $(stCadence).value,
      intervalWeeks $(stIntervalWeeks).value,
      weekdays,
      weeksOfMonth
    };

    callGAS(upsertStructuralRule, [S.pin, payload], {
      keysaveStruct,
      msgGuardando programación estructural…,
      onSuccess(res)={
        const msg = res.message  Guardado.;
        if(res && res.rule && res.rule.id){
          $(stId).value = res.rule.id;
        }
        showMsg($(msgStructEdit), msg, ok);
        refreshStructList();
      },
      onFailure(e)={
        showMsg($(msgStructEdit), e.message  String(e), bad);
      }
    });
  }

  function deleteStructById(){
    hideMsg($(msgStructEdit));
    const id = ($(stId).value  ).trim();
    if(!id) return showMsg($(msgStructEdit), Indica un ID para eliminar., warn);
    if(!confirm(¿Seguro que quieres eliminar TODA la serie estructural asociada a ese ID)) return;

    callGAS(deleteStructuralRule, [S.pin, id], {
      keydelStruct,
      msgEliminando programación estructural…,
      onSuccess(res)={
        showMsg($(msgStructEdit), res.message  Estructural eliminado., ok);
        clearStructEditor();
        refreshStructList();
      },
      onFailure(e)={
        showMsg($(msgStructEdit), e.message  String(e), bad);
      }
    });
  }

  function setStructTeamFilter(){
    S.structTeamFilter = $(structTeamFilter).value  ;
    renderStructFiltersAndList();
  }

  function setStructDayFilter(){
    S.structDayFilter = $(structDayFilter).value  ;
    renderStructFiltersAndList();
  }

  function setStructOrFilter(){
    S.structOrFilter = $(structOrFilter).value  ;
    renderStructFiltersAndList();
  }

  function setStructHourFilter(){
    S.structHourFilter = $(structHourFilter).value  ;
    renderStructFiltersAndList();
  }

  function clearStructFilter(){
    S.structTeamFilter = ;
    S.structDayFilter = ;
    S.structOrFilter = ;
    S.structHourFilter = ;
    if($(structTeamFilter)) $(structTeamFilter).value = ;
    if($(structDayFilter)) $(structDayFilter).value = ;
    if($(structOrFilter)) $(structOrFilter).value = ;
    if($(structHourFilter)) $(structHourFilter).value = ;
    renderStructFiltersAndList();
  }

  

 ===== GRUPOS QUIRÚRGICOS (consulta) =====
function loadGroupsCache(force){
  if(!S.pin) return;
  if(S.groupsLoaded && !force) return;
  callGAS(listSurgicalGroups, [S.pin], {
    keylistGroups,
    msgCargando equipos quirúrgicos…,
    onSuccess(res)={
      const groups = (res && res.groups)  res.groups  [];
      S.groupsCache = groups;

       Mapa normalizado equipo - [miembros]
      const map = {};
      groups.forEach(g={
        const k = normalizeEquipoKey(g.equipo);
        if(!k) return;
        if(!map[k]) map[k] = [];
        map[k].push(g);
      });
      S.groupsByEquipo = map;
      S.groupsLoaded = true;
      if(typeof S.__afterGroupsLoad === 'function'){ try{ S.__afterGroupsLoad(); }catch(e){} }

    },
    onFailure(_)={
      S.groupsCache = [];
      S.groupsByEquipo = {};
      S.groupsLoaded = true;
    }
  });

     Botones (Aplicar  Cancelar)
    $(modalActions).innerHTML = `
      button class=btn ghost id=mfCancelBtn type=buttonCancelarbutton
      button class=btn good id=mfApplyBtn type=buttonAplicar cambiosbutton
    `;
    const hint = $(mfHint);
    if(hint) hint.textContent = 'Se aplican cambios solo a este bloque (ocurrencia). No modifica la serie.';

    $(mfCancelBtn).onclick = ()={

       Salir de modo edición
      const bv = $(blockView);
      if(bv) bv.classList.remove(hide);
      const bClose = $(btnCloseBottom); if(bClose) bClose.classList.remove(hide);
      const bSwap = $(btnAskSwapFooter); if(bSwap) bSwap.classList.remove(hide);
      $(modalForm).classList.add(hide);
      $(modal).classList.remove(wide);
      $(modalActions).innerHTML = ;
      hideMsg($(modalMsg));
    };

    $(mfApplyBtn).onclick = ()=applyModalChanges();

  }

  function wireAskSwapButton(ctx){
     Guarda contexto para el email (fechaquirófanohora etc.)
    S.selectedCellContext = ctx  null;

    const btn = $(btnAskSwapFromBlock);
    if(!btn) return;

    btn.onclick = ()={
      const team = (btn.getAttribute(data-team)  ).trim();
      if(!team) return;
      openSwapModal(team, ctx  null);
    };
  }




function openGroupsView(){
   Solo master
  if(!S.pin  !isMaster()) return;

  const render = ()={
    const q = normalizeStr(($(groupsSearch).value  ).trim());
    const all = Array.isArray(S.groupsCache)  S.groupsCache.slice()  [];

     Orden equipo, rol, nombre
    all.sort((a,b)={
      const ea = normalizeEquipoKey(a.equipo);
      const eb = normalizeEquipoKey(b.equipo);
      if(ea !== eb) return ea.localeCompare(eb,es);
      const ra = normalizeStr(a.rol);
      const rb = normalizeStr(b.rol);
      if(ra !== rb) return ra.localeCompare(rb,es);
      const na = String(a.nombrea.cirujano).trim();
      const nb = String(b.nombreb.cirujano).trim();
      return na.localeCompare(nb,es);
    });

     Filtrar
    const filtered = !q  all  all.filter(g={
      const hay = [
        g.equipo, g.nombreg.cirujano, g.rol, g.especialidad, g.email, g.telefono
      ].map(x=normalizeStr(String(x))).join( );
      return hay.includes(q);
    });

     Agrupar por equipo
    const by = {};
    filtered.forEach(g={
      const key = (g.equipo).trim();
      if(!key) return;
      if(!by[key]) by[key] = [];
      by[key].push(g);
    });

    const teams = Object.keys(by).sort((a,b)=normalizeEquipoKey(a).localeCompare(normalizeEquipoKey(b),es));
    $(groupsCount).textContent = `${teams.length} equipo(s) · ${filtered.length} miembro(s)`;
    const list = $(groupsList);
    list.innerHTML = ;

    if(teams.length === 0){
      $(groupsEmpty).style.display = block;
      return;
    }
    $(groupsEmpty).style.display = none;

    teams.forEach(team={
      const members = by[team]  [];
      const admin = members.find(m={
        const r = normalizeStr(m.rol);
        return r.includes(admin)  r.includes(administrador);
      })  null;
      const adminName = String((admin && (admin.nombreadmin.cirujano))  ).trim()  —;
      const others = members.filter(m= m !== admin);

      const linesHtml = others.map(m={
        const nombre = escapeHtml(String(m.nombrem.cirujano).trim());
        const rol = escapeHtml(String(m.rol).trim());
        const esp = escapeHtml(String(m.especialidad).trim());
        const mail = escapeHtml(String(m.email).trim());
        const tel  = escapeHtml(String(m.telefono).trim());

        const parts = [];
        parts.push(`b${nombre  —}b`);
        const extras = [
          (rol && rol !== —)  rol  ,
          esp  esp  ,
          mail  mail  ,
          tel  tel  
        ].filter(Boolean);

        for(const x of extras){
          parts.push(`span class=sep·span`);
          parts.push(`span${x}span`);
        }
        return `div class=gLine${parts.join()}div`;
      }).join();

      const header = (others.length  0)  `
        details class=gTeamCard
          summary class=gTeamSummary
            div class=gTeamTopRow
              div class=gTeamCode${escapeHtml(team)}div
              div class=gTeamMeta
                span class=gTeamPill${members.length} miembro(s)span
                span class=gTeamPillAdmin b${escapeHtml(adminName)}bspan
              div
              div class=gTeamChevron▾div
            div
          summary
          div class=gTeamBody
            ${linesHtml}
          div
        details
      `  `
        div class=gTeamCard
          div class=gTeamSummary style=cursordefault
            div class=gTeamTopRow
              div class=gTeamCode${escapeHtml(team)}div
              div class=gTeamMeta
                span class=gTeamPill${members.length} miembro(s)span
                span class=gTeamPillAdmin b${escapeHtml(adminName)}bspan
              div
            div
          div
          div class=gEmptyTeamSin miembros adicionales.div
        div
      `;
      list.insertAdjacentHTML(beforeend, header);
    });
  };

  const ensure = ()={
     Wire UI
    if($(groupsSearch)){
      $(groupsSearch).oninput = ()=render();
      $(groupsClear).onclick = ()={ $(groupsSearch).value=; render(); };
    }
    render();
  };

  if(!S.groupsLoaded){
    S.__afterGroupsLoad = ensure;
    loadGroupsCache(true);
  }else{
    ensure();
  }
}



function normalizeStr(value){
  let s = String(value).trim().toLowerCase();
  if(!s) return ;
  try{
    s = s.normalize(NFD).replace([u0300-u036f]g,);  quita acentos
  }catch(_){}
  s = s.replace(s+g, );
  return s;
}

function escapeHtml(input){
  const s = String(input  );
  return s
    .replace(&g, &amp;)
    .replace(g, &lt;)
    .replace(g, &gt;)
    .replace(g, &quot;)
    .replace('g, &#039;);
}

 --- Color estable por equipo (HSL) ---
function teamColorForLabel(label){
  const s = String(label).trim().toUpperCase();
  let h = 0;
  for(let i=0;is.length;i++){
    h = (h31 + s.charCodeAt(i))  0;
  }
  const hue = h % 360;
   Fondo fuerte (100% saturación) y luminosidad moderada para que no sea pastel
  return {
    bg `hsl(${hue} 100% 42%)`,
    border `hsl(${hue} 100% 28%)`,
    text #ffffff,
    hue
  };
}


function normalizeEquipoKey(value){
  let s = String(value).trim();
  if(!s) return ;
  s = s.replace(s+g,  );
   En la parrilla, la Etiqueta suele venir como E CPLI (prefijo E )
  s = s.replace(^Es+i, );
  return s.toUpperCase();
}

  function getTeamContactSummary(label){
    const raw = String(label).trim();
    if(!raw) return { team, contact };
    let team = raw.replace(^Eb[s_-]i, ).trim().replace(s+g, );
    if(!team) return { team, contact };

    const byTeam = {};
    (S.groupsCache[]).forEach(g={
      const t = String(g.equipo).trim();
      if(!t) return;
      (byTeam[t] = []).push(g);
    });

    let match = byTeam[team]  team  null;
    if(!match){
      const key = normalizeEquipoKey(team);
      match = Object.keys(byTeam).find(t = normalizeEquipoKey(t) === key)  null;
    }
    if(!match){
      return { team, contact S.groupsLoaded    Cargando… };
    }

    const members = (byTeam[match][]).slice();
     Prefer administrador si existe (columna Rol)
    members.sort((a,b)={
      const ra = String(a.rol).toLowerCase() === administrador  0  1;
      const rb = String(b.rol).toLowerCase() === administrador  0  1;
      if(ra!==rb) return ra-rb;
      return String(a.cirujanoa.nombre).localeCompare(String(b.cirujanob.nombre),es);
    });
    const first = members[0]  {};
    const name = String(first.cirujano  first.nombre  ).trim();
    const spec = String(first.especialidad  ).trim();
    const contact = (name  name  ) + (spec   · +spec  );
    return { team match, contact };
  }


function groupInfoHtmlForLabel(label){
   Esperado E COTA - COTA
  const raw = String(label).trim();
  if(!raw) return ;

  let team = raw.replace(^Eb[s_-]i, ).trim();
  team = team.replace(s+g,  ).trim();
  if(!team) return ;

  const byTeam = {};
  (S.groupsCache[]).forEach(g={
    const t = String(g.equipo).trim();
    if(!t) return;
    if(!byTeam[t]) byTeam[t]=[];
    byTeam[t].push(g);
  });

  let match = byTeam[team]  team  null;
  if(!match){
    const key = normalizeEquipoKey(team);
    match = Object.keys(byTeam).find(t = normalizeEquipoKey(t) === key)  null;
  }

  if(!match){
    if(!S.groupsLoaded) return `div class=mut style=margin-top10pxCargando equipo…div`;
    return ;
  }

  const members = (byTeam[match][]).slice();
  members.sort((a,b)=String(a.cirujanoa.nombre).localeCompare(String(b.cirujanob.nombre),es));
  const first = members[0]  {};
  const firstName = String(first.cirujano  first.nombre  —).trim();
  const firstSpec = String(first.especialidad  ).trim();

  const emailObj = members.find(x=String(x.correox.email).trim());
  const hasEmail = !!String((emailObj && (emailObj.correoemailObj.email))  ).trim();

  const btn = hasEmail
     `div class=dlgActionsbutton type=button class=btn good id=btnAskSwapFromBlock data-team=${escapeHtml(match)}Pedir cambiobuttondiv`
     `div class=mut style=margin-top10pxEquipo b${escapeHtml(match)}b sin email en GruposQuirúrgicos.div`;

  return `
    div class=dlgGrid
      div class=dlgKEquipodivdiv class=dlgV${escapeHtml(match)}div
      div class=dlgKContactodivdiv class=dlgV${escapeHtml(firstName)}${firstSpec   · +escapeHtml(firstSpec)  }div
    div
    ${btn}
  `;
}
 ===== NO ESTRUCTURALES DESDE MASTER (búsqueda de huecos) =====
  function buildDoctorSelectForMaster(){
    const sel = $(stNSDoctorSelect);
    if(!sel) return;
    sel.innerHTML = 'option value=(Seleccionar usuario)option';
    const list = S.doctorList  [];
    list.forEach(d={
      const email = d.correo  d.email  d.emailVisible  ;
      if(!email) return;
      const name = [d.nombre, d.apellidos].filter(Boolean).join( );
      const label = name  `${name} – ${email}`  email;
      const opt = document.createElement(option);
      opt.value = email;
      opt.textContent = label;
      sel.appendChild(opt);
    });
  }

  function loadDoctorOptionsMaster(){
    if(S.doctorListLoaded) return;
    callGAS(listDoctorsForMaster, [S.pin], {
      keylistDoctorsMaster,
      msgCargando profesionales…,
      onSuccess(res)={
        S.doctorList = res.doctors  res.lista  [];
        S.doctorListLoaded = true;
        buildDoctorSelectForMaster();
      },
      onFailure(_)={
        S.doctorListLoaded = true;
      }
    });
  }

   Calcula bloques libres
  function computeFreeBlocksForDateGrid(grid, hours){
    const results = [];
    if(!grid  !grid.rows  !hours  hours = 0) return results;
    const needed = hours;

    grid.rows.forEach(row={
      const cells = row.cells  [];
      for(let i=0; i = cells.length - needed; i++){
        let ok = true;
        for(let k=0; kneeded; k++){
          if(cells[i+k].status !== FREE){
            ok = false;
            break;
          }
        }
        if(!ok) continue;
        const startHour = cells[i].hour;
        results.push({
          orName row.orName,
          startHour,
          hours needed,
          date grid.date
        });
      }
    });

    return results;
  }

   Render agrupado por ubicación
  function renderMasterNSSlots(){
    const box = $(stNSSlotsBox);
    box.innerHTML = ;
    const slots = S.masterNSSlots  [];
    if(!slots.length) return;

    const dateStr = S.masterNSQuery.dateStr  (slots[0] && slots[0].date)  todayISO();

    const groups = new Map();
    slots.forEach((s, idx)={
      const key = s.orName  —;
      if(!groups.has(key)) groups.set(key, []);
      groups.get(key).push({ s, idx });
    });

    const order = Array.from(groups.keys()).sort((a,b)={
      const ia = OR_LIST.indexOf(a);
      const ib = OR_LIST.indexOf(b);
      if(ia !== -1  ib !== -1){
        if(ia === -1) return 1;
        if(ib === -1) return -1;
        return ia - ib;
      }
      return a.localeCompare(b,es);
    });

    const wrap = document.createElement(div);
    wrap.className = slotsByOr;

    order.forEach(orName={
      const items = (groups.get(orName)  []).slice();
      items.sort((a,b)= (a.s.startHour0) - (b.s.startHour0));

      const row = document.createElement(div);
      row.className = slotsRow;

      const head = document.createElement(div);
      head.className = slotsRowHead;

      const title = document.createElement(div);
      title.className = slotsRowTitle;
      title.innerHTML = `span class=badgeUbicaciónspan ${escapeHtml(orName)}`;

      const count = document.createElement(div);
      count.className = badge;
      count.textContent = `${items.length} hueco${items.length === 1    s}`;

      head.appendChild(title);
      head.appendChild(count);

      const chips = document.createElement(div);
      chips.className = slotsRowChips;

      items.forEach(({s, idx})={
        const d = new Date(dateStr+T000000);
        d.setHours(s.startHour,0,0,0);

        const btn = document.createElement(button);
        btn.className = slot + (idx === S.masterNSSelectedIndex   selected  );
        btn.textContent = `${d.toLocaleTimeString(es-ES,{hour2-digit,minute2-digit})}`;
        btn.title = `${escapeHtml(orName)} · ${String(s.startHour).padStart(2,0)}00`;
        btn.onclick = ()={
          S.masterNSSelectedIndex = idx;
          renderMasterNSSlots();
        };
        chips.appendChild(btn);
      });

      row.appendChild(head);
      row.appendChild(chips);
      wrap.appendChild(row);
    });

    box.appendChild(wrap);
  }

  function masterFindNonStructSlots(opt){
    const o = opt  {};
    const refreshOnly = !!o.refreshOnly;
    const afterCreate = !!o.afterCreate;

    if(!refreshOnly){
      hideMsg($(msgStructNon));
    }

    $(stNSSlotsBox).innerHTML = ;
    S.masterNSQuery = null;
    S.masterNSSlots = [];
    S.masterNSSelectedIndex = -1;

    const dateStr = (o.dateStr  $(stNSDate).value);
    const hours = parseInt((o.hours  $(stNSDur).value),10);

    if(!dateStr) return showMsg($(msgStructNon), Selecciona una fecha., warn);
    if(!hours  hours = 0) return showMsg($(msgStructNon), Selecciona una duración válida., warn);

    callGAS(getGridOccupancy, [S.pin, dateStr], {
      keymasterNSGrid,
      msgBuscando huecos disponibles…,
      disable [$(btnNSFindSlots)],
      onSuccess(res)={
        S.masterNSQuery = {dateStr, hours};
        const slots = computeFreeBlocksForDateGrid(res, hours);
        S.masterNSSlots = slots;

        if(!slots.length){
          showMsg($(msgStructNon),
            afterCreate
               Quirófano creado. No quedan huecos libres para esa duración en ese día (ya actualizado).
               No hay huecos libres que permitan esa duración en ese día.,
            warn
          );
          return;
        }

        renderMasterNSSlots();

        showMsg($(msgStructNon),
          afterCreate
             Quirófano creado correctamente. Huecos actualizados selecciona otro hueco si quieres asignar uno nuevo.
             Selecciona un hueco y después pulsa «Asignar hueco seleccionado».,
          ok
        );
      },
      onFailure(e)={
        showMsg($(msgStructNon), e.message  String(e), bad);
      }
    });
  }

  function masterAssignNonStructSlot(){
    hideMsg($(msgStructNon));
    const idx = S.masterNSSelectedIndex;
    if(idx  0  !S.masterNSSlots.length){
      return showMsg($(msgStructNon), Primero selecciona uno de los huecos disponibles., warn);
    }

    const slot = S.masterNSSlots[idx];
    const dateStr = S.masterNSQuery.dateStr  slot.date;
    const hours = S.masterNSQuery.hours  slot.hours;
    const orName = slot.orName;

    const email = ($(stNSDoctorEmail).value  ).trim();
    if(!email){
      return showMsg($(msgStructNon), Selecciona o escribe el email del usuario., warn);
    }

    const rawLabel = ($(stNSLabel).value  ).trim();
    const label = rawLabel  rawLabel  email;

    const startISO = `${dateStr}T${String(slot.startHour).padStart(2,0)}0000`;

    const payload = {
      date dateStr,
      startISO,
      startHour slot.startHour,
      hours,
      orName,
      label,
      doctorEmail email
    };

    if(!confirm(`¿Crear quirófano NO estructural para ${email} el ${fmtDMY(dateStr)} en ${orName} a las ${String(slot.startHour).padStart(2,0)}00 durante ${hours} h`)){
      return;
    }

    callGAS(masterCreateNonStructural, [S.pin, payload], {
      keymasterCreateNonStruct,
      msgCreando quirófano no estructural…,
      disable [$(btnNSAssignSlot), $(btnNSFindSlots), $(stNSDoctorSelect), $(stNSDoctorEmail), $(stNSLabel), $(stNSDate), $(stNSDur)],
      onSuccess(res)={
        showMsg($(msgStructNon), res.message  Quirófano no estructural creado., ok);
        masterFindNonStructSlots({ refreshOnlytrue, afterCreatetrue, dateStr, hours });

        const gdDate = $(gdDate).value;
        if(gdDate && gdDate === dateStr){
          loadGrid();
        }
      },
      onFailure(e)={
        showMsg($(msgStructNon), e.message  String(e), bad);
      }
    });
  }

   ===== LISTA DE ESPERA (NUEVA) =====
  function openWaitlist(){
    go(viewWait);

    if(!S.pin){
      showMsg($(msgWait), Debes entrar primero con tu PIN., warn);
      return;
    }
    if(!isMaster()){
      showMsg($(msgWait), Solo el perfil Master puede ver y gestionar la lista de espera., warn);
      return;
    }
    loadWaitlistMaster();
  }

  function loadWaitlistMaster(){
    hideMsg($(msgWait));
    const listEl = $(waitList);
    listEl.innerHTML = `div class=msgCargando…div`;

    const mode = $(wlFilter).value;
    let onlyPending = true;
    let includePast = false;
    if(mode === pendingAll){ onlyPending = true; includePast = true; }

    callGAS(listWaitlist, [S.pin, onlyPending, includePast], {
      keywaitlist,
      msgCargando lista de espera…,
      onSuccess(res)={
        if(!res  !res.ok){
          listEl.innerHTML = ;
          showMsg($(msgWait), Respuesta inválida del servidor., bad);
          return;
        }
        renderWaitlist(res.items  []);
      },
      onFailure(e)={
        listEl.innerHTML = ;
        showMsg($(msgWait), e.message  String(e), bad);
      }
    });
  }

  function renderWaitlist(items){
    const listEl = $(waitList);
    listEl.innerHTML = ;

    if(!items.length){
      showMsg($(msgWait), No hay solicitudes con ese filtro., warn);
      return;
    }
    hideMsg($(msgWait));

    listEl.innerHTML = items.map(it={
      const who = `${it.nombre} ${it.apellidos}`.trim();
      const estado = it.estado  ;
      const canAct = (estado === PENDIENTE);
      return `
        div class=card style=margin10px 0
          div style=displayflex;justify-contentspace-between;gap10px;align-itemsflex-start;flex-wrapwrap
            div style=min-width280px;flex1
              div style=font-weight850
                ${escapeHtml(fmtDMY(it.fecha))} · ${escapeHtml(String(it.horas))}h · ${escapeHtml(it.preferencia)}
              div
              div class=hint${escapeHtml(who)} · ${escapeHtml(it.especialidad)} · ${escapeHtml(it.correo)}div
              ${it.nota  `div style=margin-top6px${escapeHtml(it.nota)}div`  ``}
              div class=hint style=margin-top6pxEstado b${escapeHtml(estado)}b · ID ${escapeHtml(it.waitId)}div
            div

            div style=displayflex;flex-directioncolumn;gap8px;min-width200px
              ${canAct  `button class=btn good onclick=acceptWait('${escapeHtml(it.waitId)}')Aceptar y asignarbutton`  ``}
              ${canAct  `button class=btn bad onclick=discardWait('${escapeHtml(it.waitId)}')Descartarbutton`  ``}
            div
          div
        div
      `;
    }).join();
  }

  function acceptWait(waitId){
    if(!waitId) return;
    if(!confirm(¿Asignar quirófano automáticamente para esta solicitud)) return;

    callGAS(acceptWaitlist, [S.pin, waitId], {
      keyacceptWait,
      msgBuscando hueco y asignando…,
      onSuccess(res)={
        showMsg($(msgWait), res.message  Solicitud asignada., ok);
        loadWaitlistMaster();
        loadGrid();
      },
      onFailure(e)={
        showMsg($(msgWait), e.message  String(e), bad);
      }
    });
  }

  function discardWait(waitId){
    if(!waitId) return;
    if(!confirm(¿Descartar esta solicitud y enviar email al solicitante)) return;

    callGAS(resolveWaitlist, [S.pin, waitId, DESCARTADA], {
      keydiscardWait,
      msgMarcando solicitud como descartada…,
      onSuccess(res)={
        showMsg($(msgWait), res.message  Solicitud descartada., ok);
        loadWaitlistMaster();
      },
      onFailure(e)={
        showMsg($(msgWait), e.message  String(e), bad);
      }
    });
  }

   ===== REPORTES =====
  function sendReport(){
    hideMsg($(msgReport));
    const email = $(rpEmail).value  ;
    const start = $(rpStart).value  ;
    const end   = $(rpEnd).value  ;
    if(!email  !start  !end){
      return showMsg($(msgReport), Indica email, inicio y fin., warn);
    }

    callGAS(sendORForecastReport, [S.pin, email, start, end], {
      keyreport,
      msgEnviando reporte por correo…,
      onSuccess(res)={
        showMsg($(msgReport), res.message  Reporte enviado., ok);
      },
      onFailure(e)={
        showMsg($(msgReport), e.message  String(e), bad);
      }
    });
  }

  
   ===== STRUCT VISUAL REPORT (COMPACT) =====
   Expects GAS getStructuralProgramReport(pin) - can return any of
    A) { locations[{ orName, byDaySession{ L{morning[...], afternoon[...]}, ... } , responsablesByTeam }] }
    B) { rows[{ orName, day, session, label, start, end, time, responsable }] }
    C) { blocks[...] }  (alias)
   Renderer is defensive and will try to adapt.

  function generateStructVisualReport(){
    hideMsg($(msgReport));
    const box = $(structVisualReport);
    box.classList.remove(hide);
    box.innerHTML = ;

    callGAS(getStructuralProgramReport, [S.pin], {
      keystructReport,
      msgGenerando reporte visual…,
      onSuccess(res)={
        try{
          renderStructVisualReport(res);
        }catch(err){
          console.error(err);
          showMsg($(msgReport), Error renderizando el reporte  + (err.messageString(err)), bad);
        }
      },
      onFailure(e)={
        console.error(e);
        showMsg($(msgReport), e.message  String(e), bad);
      }
    });
  }

  function renderStructVisualReport(data){
    const box = $(structVisualReport);
    box.classList.remove(hide);
    box.innerHTML = ;

    const rows = normalizeStructReportRows(data);
    if(!rows.length){
      showMsg($(msgReport), No hay bloques estructurales para mostrar en este rangocriterio., warn);
      return;
    }

     Group by location - day - session
    const map = new Map();  loc - { L{morning[],afternoon[]}, ... }
    rows.forEach(r={
      const loc = String(r.orNamer.location).trim()  —;
      const day = normalizeDayKey(r.day);
      const sess = normalizeSessionKey(r.session);
      if(!map.has(loc)){
        map.set(loc, {L{morning[],afternoon[]},M{morning[],afternoon[]},X{morning[],afternoon[]},J{morning[],afternoon[]},V{morning[],afternoon[]},S{morning[],afternoon[]},D{morning[],afternoon[]}});
      }
      const cell = map.get(loc)[day][sess];
      cell.push({
        label r.label  r.team  r.group  r.equipo  —,
        time r.time  r.range  r.horario  formatTimeRange(r),
        responsable r.responsable  r.admin  r.administrator  r.responsible  
      });
    });

    const dayOrder = [L,M,X,J,V,S,D];
    const dayName = {LLunes, MMartes, XMiércoles, JJueves, VViernes, SSábado, DDomingo};
    const sessName = {morningMañana, afternoonTarde};

     ✅ Render en TABLA (estilo Excel) para evitar solapes de celdas (bug de sticky+grid en algunos navegadores)
    const scroll = document.createElement(div);
    scroll.className = structReportScroll;

    const table = document.createElement(table);
    table.className = structReportTable;

    const thead = document.createElement(thead);
    const tr1 = document.createElement(tr);

    const thLoc = document.createElement(th);
    thLoc.className = srLoc;
    thLoc.rowSpan = 2;
    thLoc.textContent = Ubicación;
    tr1.appendChild(thLoc);

    dayOrder.forEach(d={
      const th = document.createElement(th);
      th.className = srDay;
      th.colSpan = 2;
      th.innerHTML = `div class=srDayTop${escapeHtml(dayName[d])}divdiv class=srDayKey${d}div`;
      tr1.appendChild(th);
    });

    const tr2 = document.createElement(tr);
    dayOrder.forEach(_d={
      const thM = document.createElement(th);
      thM.className = srSess;
      thM.textContent = M;
      tr2.appendChild(thM);

      const thT = document.createElement(th);
      thT.className = srSess;
      thT.textContent = T;
      tr2.appendChild(thT);
    });

    thead.appendChild(tr1);
    thead.appendChild(tr2);
    table.appendChild(thead);

    const tbody = document.createElement(tbody);

    [...map.keys()].sort((a,b)=a.localeCompare(b,es)).forEach(loc={
      const tr = document.createElement(tr);

      const tdLoc = document.createElement(td);
      tdLoc.className = srLocCell;
      tdLoc.textContent = loc;
      tr.appendChild(tdLoc);

      dayOrder.forEach(d={
        [morning,afternoon].forEach(sess={
          const td = document.createElement(td);
          td.className = srCell;

          const stack = document.createElement(div);
          stack.className = srCellStack;

          const items = map.get(loc)[d][sess];
          if(items && items.length){
            items.slice(0,6).forEach(it={
              const btn = document.createElement(button);
              btn.type = button;
              btn.className = srCard;
               En la tarjeta solo el nombre del equipo
              btn.innerHTML = `div class=srCardTopspan class=srLabel${escapeHtml(it.label  —)}spandiv`;
              const __c = teamColorForLabel(it.label);
              btn.style.background = __c.bg;
              btn.style.borderColor = __c.border;
              btn.style.color = __c.text  #fff;
               sombra mínima para separar sin “pastel”
              btn.style.boxShadow = inset 0 0 0 1px rgba(255,255,255,.10);

              btn.onclick = ()={
                openStructReportBlockModal({
                  location loc,
                  day dayName[d],
                  dayKey d,
                  session sessName[sess],
                  sessionKey sess,
                  label it.label,
                  time it.time  ,
                  responsable it.responsable  —
                });
              };
              stack.appendChild(btn);
            });

            if(items.length6){
              const more = document.createElement(div);
              more.className = srMore;
              more.textContent = `+${items.length-6} más`;
              stack.appendChild(more);
            }
          }else{
            const empty = document.createElement(div);
            empty.className = srEmpty;
            empty.textContent = ;
            stack.appendChild(empty);
          }

          td.appendChild(stack);
          tr.appendChild(td);
        });
      });

      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    scroll.appendChild(table);
    box.appendChild(scroll);

     Ensure modal exists once
    ensureStructReportModal();
  }


  function normalizeStructReportRows(data){
    if(!data) return [];
    if(Array.isArray(data.rows)) return data.rows;
    if(Array.isArray(data.blocks)) return data.blocks;
    if(Array.isArray(data.items)) return data.items;

     locations format
    if(Array.isArray(data.locations)){
      const out = [];
      data.locations.forEach(loc={
        const orName = loc.orName  loc.location  loc.name;
        const bds = loc.byDaySession  loc.byDay  loc.grid;
        if(!bds) return;
        Object.keys(bds).forEach(dayKey={
          const dayObj = bds[dayKey]  {};
          [morning,afternoon].forEach(sess={
            const arr = dayObj[sess]  dayObj[sess===morningMT]  [];
            if(!Array.isArray(arr)) return;
            arr.forEach(it={
              out.push({
                orName,
                day dayKey,
                session sess,
                label it.label  it.team  it.group  it.equipo,
                time it.time  it.range  it.horario,
                responsable it.responsable  it.admin  it.administrator  it.responsible
              });
            });
          });
        });
      });
      return out;
    }

     byDaySession without locations (single or global)
     Supports GAS format byDaySession[day] = { AM[], PM[], MIXED[] } and each item may include orName, label, startHour, durationHours
    if(data.byDaySession){
      const out=[];
      const bds=data.byDaySession  {};
      const pad2 = (n)= String(n).padStart(2,0);
      const fmtHour = (hFloat)={
        const h = Math.floor(Number(hFloat)0);
        const m = Math.round(((Number(hFloat)0) - h)60);
        return `${pad2(h)}${pad2(m)}`;
      };
      const sessMap = { AMmorning, PMafternoon, MIXEDmixed, Mmorning, Tafternoon };

      Object.keys(bds).forEach(dayKey={
        const dayObj=bds[dayKey]{};
        Object.keys(dayObj).forEach(rawSess={
          const arr = dayObj[rawSess];
          if(!Array.isArray(arr)) return;
          const sess = sessMap[String(rawSess).toUpperCase()]  String(rawSess).toLowerCase();
          arr.forEach(it={
            const orName = it.orName  it.location  it.or  data.orName  data.location  —;
            const label = it.label  it.team  it.group  it.equipo;
            let time = it.time  it.range  it.horario;

            if(!time){
              const sh = (it.startHour  it.start  it.startH);
              const dur = (it.durationHours  it.duration  it.durH);
              if(sh != null && dur != null){
                const end = Number(sh) + Number(dur);
                time = `${fmtHour(sh)}–${fmtHour(end)}`;
              }
            }

            out.push({
              orName,
              day dayKey,
              session sess,
              label,
              time,
              responsable it.responsable  it.admin  it.administrator  it.responsible  it.owner
            });
          });
        });
      });
      return out;
    }return [];
  }

  function normalizeDayKey(day){
    const d = String(day  ).trim();
     allow 0-6, Mon.., LMXJVSD
    const map = {
      0D,6S,5V,4J,3X,2M,1L,
      lunL,lunesL,monL,mondayL,
      marM,martesM,tueM,tuesdayM,
      miéX,mieX,miércolesX,miercolesX,wedX,wednesdayX,
      jueJ,juevesJ,thuJ,thursdayJ,
      vieV,viernesV,friV,fridayV,
      sábS,sabS,sábadoS,sabadoS,satS,saturdayS,
      domD,domingoD,sunD,sundayD,
      lL,mM,xX,jJ,vV,sS,dD
    };
    const k = normalizeStr(d).replace(.g,);
    return map[k]  ([L,M,X,J,V,S,D].includes(d)dL);
  }

  function normalizeSessionKey(sess){
    const s = normalizeStr(String(sess  ));
    if(s.includes(tarde)  s===t  s===pm  s.includes(afternoon)) return afternoon;
    return morning;
  }

  function formatTimeRange(r){
     Try to build from startend or startHendH
    const a = r.start  r.startISO  r.startTime  r.timeStart;
    const b = r.end  r.endISO  r.endTime  r.timeEnd;
    if(a && b){
      const sa = String(a).slice(11,16);
      const sb = String(b).slice(11,16);
      if(sa && sb && sa.includes() && sb.includes()) return `${sa}-${sb}`;
    }
    if(r.startH!=null && r.endH!=null){
      const sh = String(r.startH).padStart(2,0)+00;
      const eh = String(r.endH).padStart(2,0)+00;
      return `${sh}-${eh}`;
    }
    return ;
  }

  function makeCell(cls, txt){
    const d = document.createElement(div);
    d.className = cls;
    d.textContent = txt;
    return d;
  }

   --- Mini modal for block info ---
  function ensureStructReportModal(){
    if($(srModalBackdrop)) return;
    const bd = document.createElement(div);
    bd.id = srModalBackdrop;
    bd.className = srModalBackdrop hide;
    bd.innerHTML = `
      div class=srModal role=dialog aria-modal=true
        div class=srModalRow
          div class=srModalTitle id=srModalTitle—div
          button type=button class=srModalCloseX id=srModalCloseX aria-label=Cerrar✕button
        div
        div class=srModalBody
          div class=srModalLinespan class=mutedEquipospan span id=srModalEquipo—spandiv
          div class=srModalLinespan class=mutedTurnospan span id=srModalTurno—spandiv
          div class=srModalLinespan class=mutedCadenciaspan span id=srModalCadence—spandiv
          div class=srModalLinespan class=mutedConfiguraciónspan span id=srModalCadenceCfg—spandiv
          div class=srModalLinespan class=mutedAdministradorspan span id=srModalResp—spandiv
          div class=srModalLinespan class=mutedContactospan span id=srModalContact—spandiv
        div
        div class=srModalActions
          button type=button class=btn id=srModalCloseBtnCerrarbutton
        div
      div
    `;
    document.body.appendChild(bd);

    const close = ()={ bd.classList.add(hide); };

    bd.addEventListener(click,(e)={
      if(e.target===bd) close();
    });
    $(srModalCloseX).onclick = close;
    $(srModalCloseBtn).onclick = close;
    document.addEventListener(keydown,(e)={
      if(e.key===Escape && !bd.classList.contains(hide)) close();
    });
  }

  
  function findAdminForEquipo(label){
    const key = normalizeEquipoKey(label);
    const members = (key && S.groupsByEquipo && S.groupsByEquipo[key])  S.groupsByEquipo[key]  null;
    if(!members  !members.length) return null;
     Prefer rol Administrador
    const admin = members.find(m= String(m.rol).toLowerCase()===administrador)  members[0];
    return admin  null;
  }

  function fmtAdminContact(admin){
    if(!admin) return —;
    const email = admin.email  admin.correo  admin.mail  ;
    const phone = admin.telefono  admin.phone  admin.tlf  ;
    if(email && phone) return `${email} · ${phone}`;
    if(email) return email;
    if(phone) return phone;
    return —;
  }

   --- Cadencia resolver regla estructural para un bloque del reporte ---
  function findStructRuleForBlock(info){
    const locKey = normalizeStr(info.location);
    const labelKey = normalizeStr(info.label);
    const dayKey = info.dayKey  normalizeDayKey(info.day);
    const sessName = (function(v){
      const s = normalizeStr(String(v));
      if(s===ms===mananas.includes(mañana)s.includes(morning)) return mañana;
      if(s===ts===tardes.includes(afternoon)) return tarde;
      return s;
    })(info.session);
    const rules = Array.isArray(S.structRulesCache)  S.structRulesCache  [];
    if(!rules.length) return null;

    const inferSess = (r)={
      if(r.sessionNameEs) return String(r.sessionNameEs).toLowerCase();
      const sh = Number(r.startHour  r.startHourFloat  r.start  NaN);
      if(!Number.isFinite(sh)) return ;
      return (sh  15)  mañana  tarde;
    };

     1) Match fuerte (loc+label+day+session)
    let hit = rules.find(r={
      return normalizeStr(r.orNamer.location)===locKey &&
             normalizeStr(r.labelr.team)===labelKey &&
             (()={
             const arr = Array.isArray(r.weekdays)  r.weekdays.map(String)  [];
             if(!arr.length) return true;
             const map = {LMONDAY,MTUESDAY,XWEDNESDAY,JTHURSDAY,VFRIDAY,SSATURDAY,DSUNDAY};
             const wantA = String(dayKey);
             const wantB = map[wantA]  wantA;
             return arr.includes(wantA)  arr.includes(wantB);
           })() &&
             inferSess(r)===sessName;
    });
    if(hit) return hit;

     2) Match sin sesión (por si faltan horas o sesión)
    hit = rules.find(r={
      return normalizeStr(r.orNamer.location)===locKey &&
             normalizeStr(r.labelr.team)===labelKey &&
             (()={
             const arr = Array.isArray(r.weekdays)  r.weekdays.map(String)  [];
             if(!arr.length) return true;
             const map = {LMONDAY,MTUESDAY,XWEDNESDAY,JTHURSDAY,VFRIDAY,SSATURDAY,DSUNDAY};
             const wantA = String(dayKey);
             const wantB = map[wantA]  wantA;
             return arr.includes(wantA)  arr.includes(wantB);
           })();
    });
    return hit  null;
  }

  function describeCadence(rule){
    if(!rule) return {name—, cfg—};
    const mode = String(rule.cadenceMode).toUpperCase();
    const name = rule.cadenceNameEs  (
      mode===MONTH_WEEKS  Mensual (semanas del mes) 
      mode===WEEKLY  Semanal 
      mode  mode  —
    );

    const dayName = {LLunes,MMartes,XMiércoles,JJueves,VViernes,SSábado,DDomingo};
    const dow = Array.isArray(rule.weekdays)  rule.weekdays.map(String)  [];
    const dows = dow.length  dow.map(d=dayName[d]d).join(, )  —;

    const wom = Array.isArray(rule.weeksOfMonth)  rule.weeksOfMonth.map(String)  [];
    const womFmt = wom.length  wom.map(w=`${w}ª`).join(, )  —;

    const interval = Number(rule.intervalWeeks1);
    const intervalTxt = (mode===WEEKLY && interval1)  `Cada ${interval} semanas`  (mode===WEEKLY  Cada semana  );

    const startDate = rule.startDate  String(rule.startDate)  ;
    const endDate = rule.endDate  String(rule.endDate)  ;
    const dateTxt = (startDate  endDate)  `${startDate  —} → ${endDate  —}`  —;

    const sh = rule.startHour != null  String(rule.startHour)  ;
    const dur = rule.durationHours != null  String(rule.durationHours)  ;
    const timeTxt = (sh  dur)  `${sh  —}h · ${dur  —}h`  —;

    let extra = [];
    if(intervalTxt) extra.push(intervalTxt);
    if(mode===MONTH_WEEKS) extra.push(`Semanas del mes ${womFmt}`);
    extra.push(`Días ${dows}`);
    extra.push(`HoraDuración ${timeTxt}`);

    return {name, cfg extra.join( · )};
  }


function openStructReportBlockModal(info){
    ensureStructReportModal();

    const show = ()={
      const admin = findAdminForEquipo(info.label)  null;

      $(srModalEquipo).textContent = info.label  —;
      $(srModalTurno).textContent = info.session  —;
      const __rule = findStructRuleForBlock(info);
      const __cad = describeCadence(__rule);
      $(srModalCadence).textContent = __cad.name  —;
      $(srModalCadenceCfg).textContent = __cad.cfg  —;

      $(srModalResp).textContent = (admin && (admin.nombre  admin.name))  (admin.nombre  admin.name)  (info.responsable  —);
      $(srModalContact).textContent = fmtAdminContact(admin);

      $(srModalTitle).textContent = (info.label  —);
      $(srModalBackdrop).classList.remove(hide);
    };

    const ensureStructThenShow = ()={
       Para mostrar cadenciaconfiguración necesitamos tener la programación estructural cargada
      if(!S.structRulesCache  !S.structRulesCache.length){
        callGAS(listStructuralRules, [S.pin], {
          keylistStructForReportModal,
          msgCargando programación estructural…,
          onSuccess(res)={
            S.structRulesCache = res.rules  [];
            show();
          },
          onFailure(_)={
             Si falla, igualmente mostramos el modal (pero sin cadencia)
            show();
          }
        });
        return;
      }
      show();
    };

     Ensure group cache is loaded so we can resolve admincontact
    if(!S.groupsLoaded){
      S.__afterGroupsLoad = ()={ S.__afterGroupsLoad = null; ensureStructThenShow(); };
      loadGroupsCache(false);
      return;
    }

    ensureStructThenShow();
  }



 ===== INIT =====
  function initDatesAndDefaults(){
    const t = todayISO();
    if($(rvDate)) $(rvDate).value = addDaysISO(1);
    if($(gdDate)) $(gdDate).value = t;
    if($(stNSDate)) $(stNSDate).value = addDaysISO(1);
    if($(rpStart)) $(rpStart).value = t;
    if($(rpEnd)){
      const d = new Date();
      d.setDate(d.getDate()+30);
      d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
      $(rpEnd).value = d.toISOString().slice(0,10);
    }
  }

  document.addEventListener(DOMContentLoaded, ()={
    initOrCalcDefaults();
    buildOrCalcChips();
    fillStructSelectors();
    fillSpecialties();
    syncCadenceUI();
    initDatesAndDefaults();
    setSessionPill();
    setMenuButtons();

    $(btnLogin).onclick = login;
    $(btnClear).onclick = ()={$(pinInput).value = ; hideMsg($(msgLogin));};
    $(btnLogout).onclick = logout;

    $(btnToggleSignup).onclick = toggleSignup;
    $(btnSignup).onclick = signup;

    $(btnGoReserve).onclick = ()=go(viewReserve);
    $(btnGoMine).onclick    = ()=go(viewMine);
    $(btnGoGrid).onclick    = ()={ go(viewGrid); loadGrid(); };
    $(btnGoStruct).onclick  = ()={
      go(viewStruct);
      refreshStructList();
      loadDoctorOptionsMaster();
    };

    $(btnGoWait).onclick    = openWaitlist;
    $(btnGoReport).onclick  = ()=go(viewReport);

    

    if($(btnGoGroups)) $(btnGoGroups).onclick = ()={ go(viewGroups); openGroupsView(); };$(btnCheckSlots).onclick = checkSlots;
    $(btnOpenWaitlistFromReserve).onclick = openWaitlistFromReserve;
    $(btnLoadMine).onclick = loadMine;

    $(btnLoadGrid).onclick = loadGrid;
$(btnToggleAdvanced).onclick = ()={
      $(advancedBox).classList.toggle(hide);
    };

    if($(btnGridPrevDay)) $(btnGridPrevDay).onclick = ()=moveGridDay(-1);
    if($(btnGridNextDay)) $(btnGridNextDay).onclick = ()=moveGridDay(1);
    if($(btnRvPrevDay))   $(btnRvPrevDay).onclick   = ()=moveReserveDay(-1);
    if($(btnRvNextDay))   $(btnRvNextDay).onclick   = ()=moveReserveDay(1);

    $(btnNewStruct).onclick = clearStructEditor;
    $(btnSaveStruct).onclick = saveStructFromEditor;
    $(btnDeleteStructById).onclick = deleteStructById;
    $(btnReloadStruct).onclick = refreshStructList;
    $(btnStructClearFilter).onclick = clearStructFilter;
    $(structTeamFilter).onchange = setStructTeamFilter;
    if($(structDayFilter)) $(structDayFilter).onchange = setStructDayFilter;
$(structOrFilter).onchange = setStructOrFilter;
    $(structHourFilter).onchange = setStructHourFilter;
        $(stCadence).onchange = syncCadenceUI;

     NO estructurales master
    $(btnNSFindSlots).onclick = ()=masterFindNonStructSlots();
    $(btnNSAssignSlot).onclick = masterAssignNonStructSlot;

    const selDoctor = $(stNSDoctorSelect);
    if(selDoctor){
      selDoctor.onchange = ()={
        const email = selDoctor.value  ;
        $(stNSDoctorEmail).value = email;
      };
    }

    $(btnLoadWait).onclick = loadWaitlistMaster;
    $(wlFilter).onchange = ()={ if(!$(#viewWait).classList.contains(hide)) loadWaitlistMaster(); };

    $(btnSendReport).onclick = sendReport;
    $(btnStructVisualReport).onclick = generateStructVisualReport;

    $(btnModalClose).onclick = closeModal;
    $(btnModalApply).onclick = applyModalChanges;
  });

 --- Solicitud de cambio modal + envío directo (Apps Script) ---
let __swapTeam = ;
let __swapContext = null;

function openSwapModal(team, context){
  __swapTeam = String(team).trim();
  __swapContext = (context && typeof context === object)  context  null;

  const modal = document.getElementById(swapModal);
  const comment = document.getElementById(swapComment);
  const status = document.getElementById(swapStatus);
  if(!modal  !comment  !status) return;

  comment.value = ;
  status.textContent = ;
  modal.style.display = flex;
  comment.focus();

  const close = ()={ modal.style.display = none; };
  document.getElementById(swapCloseBtn).addEventListener(click, close, { oncetrue });
  document.getElementById(swapCancelBtn).addEventListener(click, close, { oncetrue });

  document.getElementById(swapSendBtn).addEventListener(click, async ()={
    try{
      status.textContent = Enviando...;
      const payload = {
        pin S.pin,
        equipo __swapTeam,
        comment comment.value  ,
        context __swapContext  {}
      };

       GAS
      if (typeof google !== undefined && google.script && google.script.run){
        google.script.run
          .withSuccessHandler((res)={
            if(res && res.ok){
              status.textContent = ✅ Solicitud enviada a  + (res.to  );
              setTimeout(()={ modal.style.display = none; }, 800);
            } else {
              status.textContent = ❌ No se pudo enviar.;
            }
          })
          .withFailureHandler((err)={
            status.textContent = ❌  + (err.message  String(errError));
          })
          .requestSwapToTeam(payload.pin, payload.equipo, payload.comment, payload.context);
        return;
      }

       Worker (si está configurado)
      if (typeof API_WORKER_URL !== undefined && API_WORKER_URL){
        const r = await fetch(API_WORKER_URL, {
          method POST,
          headers { Content-Typeapplicationjson },
          body JSON.stringify({ fnrequestSwapToTeam, args[payload.pin, payload.equipo, payload.comment, payload.context] })
        });
        const data = await r.json();
        if(data && data.ok){
          status.textContent = ✅ Solicitud enviada a  + (data.to  );
          setTimeout(()={ modal.style.display = none; }, 800);
        } else {
          status.textContent = ❌  + (data.error  No se pudo enviar.);
        }
        return;
      }

      status.textContent = ❌ No hay canal de envío disponible (GASWorker).;
    }catch(e){
      status.textContent = ❌  + (e.message  String(e));
    }
  }, { oncetrue });
}

script

!-- Modal Solicitud de cambio --

div id=swapModal class=modal style=displaynone
  div class=modalCard
    div class=modalTop
      div class=modalTitleSolicitud de cambiodiv
      
    div

    div class=mut style=margin-top2px
      Se enviará un correo al primer miembro del equipo seleccionado. Incluye tu nombre, correo y teléfono.
    div

    div style=margin-top10px
      div class=labelComentario (opcional)div
      textarea id=swapComment rows=5 placeholder=Ej. Necesito cambiar por incompatibilidad de horario, preferiría por la tarde, etc.textarea
    div

    div id=swapStatus class=mut style=margin-top10pxdiv

    div class=dlgActions style=margin-top12px
      button class=btn ghost id=swapCancelBtn type=buttonCancelarbutton
      button class=btn good id=swapSendBtn type=buttonEnviar solicitudbutton
    div
  div
div


body
html
