<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestión de Quirófanos – QuirófanosH9O</title>

  <style>
    :root{
      --bg:#f4f7fb;
      --card:#ffffff;
      --muted:#5b6b82;
      --text:#0f172a;
      --acc:#1d4ed8;
      --line:#d7e2f0;

      --bad:#b91c1c;
      --ok:#047857;
      --warn:#b45309;

      --softAcc: rgba(29,78,216,.08);
      --softOk: rgba(4,120,87,.08);
      --softWarn: rgba(180,83,9,.08);
      --softBad: rgba(185,28,28,.08);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1000px 500px at 10% -10%, rgba(29,78,216,.10), transparent 55%),
        radial-gradient(1000px 500px at 100% 0%, rgba(4,120,87,.08), transparent 55%),
        var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }

    .wrap{max-width:1280px;margin:0 auto;padding:12px}
    @media(min-width: 980px){ .wrap{padding:16px} }

    .topbar{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:12px 14px;border:1px solid var(--line);border-radius:16px;
      background: rgba(255,255,255,.88);
      backdrop-filter: blur(8px);
      position: sticky; top: 10px; z-index: 50;
      box-shadow: 0 8px 30px rgba(15,23,42,.06);
      flex-wrap:wrap;
      min-width:0;
    }

    .brand{display:flex;gap:12px;align-items:center;min-width:0}
    .logo{
      width:38px;height:38px;border-radius:14px;
      background: linear-gradient(135deg,#2563eb,#22c55e);
      box-shadow: 0 10px 25px rgba(15,23,42,.12);
      flex:0 0 auto;
    }
    .brand h1{font-size:15px;margin:0;line-height:1.2}
    .brand small{display:block;color:var(--muted);margin-top:2px}

    .pill{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
      padding:8px 10px;border:1px solid var(--line);border-radius:999px;
      background: rgba(255,255,255,.92);
      color:var(--muted);
      font-size:12px;
      max-width:100%;
      min-width:0;
    }
    .pill span{color:var(--text);font-weight:700}

    .btn{
      border:1px solid var(--line);
      background: #fff;
      color:var(--text);
      padding:10px 12px;border-radius:12px;
      cursor:pointer;
      font-weight:750;
      box-shadow: 0 8px 20px rgba(15,23,42,.06);
    }
    .btn:hover{border-color: rgba(29,78,216,.30)}
    .btn.primary{background: var(--softAcc);border-color: rgba(29,78,216,.25);color: #0b2a78;}
    .btn.good{background: var(--softOk);border-color: rgba(4,120,87,.22);color:#064e3b;}
    .btn.bad{background: var(--softBad);border-color: rgba(185,28,28,.22);color:#7f1d1d;}
    .btn.warn{background: var(--softWarn);border-color: rgba(180,83,9,.22);color:#7c2d12;}
    .btn.ghost{background: transparent;border-color: transparent;box-shadow:none;}
    .btn.small{padding:8px 10px;border-radius:10px;font-size:12px}
    .btn:disabled, button:disabled{opacity:.55;cursor:not-allowed;filter:saturate(.7);box-shadow:none;}

    .grid{display:grid;grid-template-columns: minmax(0,1fr);gap:12px;margin-top:14px;}
    @media(min-width: 980px){ .grid{grid-template-columns: 380px minmax(0,1fr)} }

    .card{
      border:1px solid var(--line);
      border-radius:18px;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(8px);
      padding:14px;
      box-shadow: 0 18px 45px rgba(15,23,42,.08);
      min-width:0;
    }
    .card h2{margin:0 0 10px 0;font-size:15px}
    .card h3{margin:0 0 10px 0;font-size:14px;color:var(--muted);font-weight:800}

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;min-width:0}
    label{display:block;color:var(--muted);font-size:12px;margin:10px 0 6px}

    input, select, textarea{
      width:100%;
      padding:10px 12px;border-radius:12px;
      border:1px solid var(--line);
      background: #fff;
      color: var(--text);
      outline:none;
      box-shadow: 0 6px 16px rgba(15,23,42,.05);
      min-width:0;
    }
    textarea{min-height:84px;resize:vertical}
    input:focus, select:focus, textarea:focus{
      border-color: rgba(29,78,216,.40);
      box-shadow: 0 0 0 4px rgba(29,78,216,.10);
    }

    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .hr{height:1px;background: var(--line);margin:12px 0}

    .msg{
      margin-top:10px;
      padding:10px 12px;border-radius:12px;
      border:1px solid var(--line);
      background: #fff;
      color:var(--muted);
      font-size: 13px;
      white-space: pre-wrap;
      box-shadow: 0 10px 24px rgba(15,23,42,.06);
      min-width:0;
    }
    .msg.ok{border-color: rgba(4,120,87,.24); background: var(--softOk); color: var(--text)}
    .msg.bad{border-color: rgba(185,28,28,.22); background: var(--softBad); color: var(--text)}
    .msg.warn{border-color: rgba(180,83,9,.22); background: var(--softWarn); color: var(--text)}
    .hide{display:none !important}

    .slots{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .slot{
      padding:8px 10px;border-radius:999px;border:1px solid var(--line);
      background: #fff;
      color: var(--text);
      cursor:pointer;
      font-size: 12px;
      box-shadow: 0 10px 24px rgba(15,23,42,.06);
    }
    .slot:hover{border-color: rgba(29,78,216,.30)}
    .slot.selected{
      border-color: rgba(29,78,216,.60);
      background: var(--softAcc);
      font-weight:700;
    }

    .tableWrap{
      overflow-x:auto;
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      box-shadow: 0 14px 32px rgba(15,23,42,.06);
      max-width:100%;
    }
    table{border-collapse:collapse;width:100%;min-width:0;}
    th, td{
      border-bottom:1px solid rgba(215,226,240,.9);
      border-right:1px solid rgba(215,226,240,.7);
      padding:8px 10px;
      font-size: 12px;
      white-space: nowrap;
    }
    th{position:sticky;top:0;background: rgba(255,255,255,.96); z-index: 2;}
    td:last-child, th:last-child{border-right:none}

    /* COLORES CELDAS */
    .cellFree{
      background: var(--softOk);
      color:#064e3b;
      cursor:pointer;
      font-weight:600;
    }
    .cellFree:hover{outline:1px solid rgba(4,120,87,.35)}

    .cellNA{opacity:.35}

    .cellNon,
    .cellStruct{
      background: var(--softBad);
      color:#7f1d1d;
      cursor:pointer;
      font-weight:600;
    }
    .cellNon:hover,
    .cellStruct:hover{
      outline:1px solid rgba(185,28,28,.35);
    }

    .badge{
      display:inline-block;padding:2px 8px;border-radius:999px;
      border:1px solid rgba(215,226,240,.95);
      background: #fff;
      color:var(--muted); font-size:11px;
      font-weight:800;
    }

    .modalBack{
      position:fixed; inset:0; background: rgba(15,23,42,.45);
      display:flex; align-items:center; justify-content:center;
      padding:16px; z-index: 999;
    }
    .modal{
      width:min(720px, 100%);
      border:1px solid var(--line);
      border-radius:18px;
      background: rgba(255,255,255,.98);
      padding:14px;
      box-shadow: 0 30px 80px rgba(15,23,42,.30);
    }
    .modal h3{margin:0 0 8px 0}
    .modal .x{float:right}
    .hint{color:var(--muted);font-size:12px;margin-top:6px}

    .kpi{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin-top:10px}
    .kpi .box{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      background: #fff;
      color: var(--muted); font-size:12px;
      box-shadow: 0 10px 24px rgba(15,23,42,.06);
    }
    .kpi .box b{display:block;color:var(--text);font-size:14px;margin-top:2px}

    .weekPick{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .wchip{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--line);
      background: #fff;
      color: var(--text);
      cursor:pointer;
      font-size:12px;
      user-select:none;
      box-shadow: 0 10px 24px rgba(15,23,42,.06);
    }
    .wchip:hover{border-color: rgba(29,78,216,.30)}
    .wchip input{width:auto; margin:0; accent-color: var(--acc )}
    .wchip b{font-weight:850}

    .mgrid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width: 640px){ .mgrid{grid-template-columns:1fr 1fr} }
    .mgrid .full{grid-column:1 / -1}

    .loadingBar{
      position: fixed;
      left: 16px;
      right: 16px;
      bottom: 16px;
      z-index: 2000;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(255,255,255,.96);
      backdrop-filter: blur(8px);
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      box-shadow: 0 20px 60px rgba(15,23,42,.20);
    }
    .loadingBar .txt{color: var(--text); font-size: 13px; font-weight:800}
    .loadingBar .sub{color: var(--muted); font-size: 12px}
    .loadingBar .dot{
      width:10px;height:10px;border-radius:50%;
      background: rgba(29,78,216,.9);
      box-shadow: 0 0 0 6px rgba(29,78,216,.14);
      animation: pulse 1.2s infinite ease-in-out;
    }
    @keyframes pulse{
      0%{transform:scale(.9); opacity:.6}
      50%{transform:scale(1.15); opacity:1}
      100%{transform:scale(.9); opacity:.6}
    }

    .structStack{
      display:flex;
      flex-direction:column;
      gap:12px;
      min-width:0;
    }
    .structPanel{
      border:1px solid var(--line);
      border-radius:16px;
      background: rgba(255,255,255,.96);
      padding:12px;
      box-shadow: 0 14px 32px rgba(15,23,42,.06);
      min-width:0;
    }
    .structPanel h3{margin:0 0 10px 0;color:var(--muted);font-size:14px;font-weight:850}

    .filterBar{
      display:flex;
      gap:10px;
      align-items:flex-end;
      flex-wrap:wrap;
      margin-top:6px;
      min-width:0;
    }
    .filterBar .field{
      min-width:240px;
      flex:1;
    }

    .summaryTable{
      width:100%;
      border-collapse:collapse;
      margin-top:8px;
      overflow:hidden;
      border-radius:12px;
    }
    .summaryTable th, .summaryTable td{
      border-bottom:1px solid rgba(215,226,240,.9);
      padding:8px 10px;
      font-size:12px;
      text-align:left;
      white-space:nowrap;
    }
    .summaryTable th{color:var(--muted); font-weight:900}

    .summaryKpiRow{
      display:flex; gap:10px; flex-wrap:wrap; margin-top:8px;
    }
    .summaryKpi{
      border:1px solid var(--line);
      border-radius:12px;
      background:#fff;
      padding:8px 10px;
      font-size:12px;
      color:var(--muted);
      box-shadow: 0 10px 24px rgba(15,23,42,.06);
    }
    .summaryKpi b{color:var(--text)}

    .reportGrid{
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      overflow:hidden;
      box-shadow: 0 14px 32px rgba(15,23,42,.06);
      margin-top:10px;
    }
    .reportGrid table{width:100%; border-collapse:collapse; min-width:840px;}
    .reportGrid th, .reportGrid td{
      border-bottom:1px solid rgba(215,226,240,.9);
      border-right:1px solid rgba(215,226,240,.7);
      padding:10px;
      vertical-align:top;
      font-size:12px;
      white-space:normal;
    }
    .reportGrid th{
      position:sticky; top:0; z-index:2;
      background: rgba(255,255,255,.98);
      color:var(--muted);
      font-weight:900;
    }
    .reportGrid td:last-child, .reportGrid th:last-child{border-right:none}
    .rchip{
      display:block;
      border:1px solid rgba(215,226,240,.95);
      border-radius:12px;
      padding:8px 10px;
      margin:6px 0;
      background: rgba(29,78,216,.05);
    }
    .rchip.struct{background: rgba(4,120,87,.06)}
    .rchip b{display:block;color:var(--text);font-size:12px;margin-bottom:2px}
    .rchip small{color:var(--muted)}
    .rhead{
      display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between;
    }

    /* ===== MEJORA: huecos NO estructurales agrupados por ubicación ===== */
    .slotsByOr{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:10px;
    }
    .slotsRow{
      border:1px solid var(--line);
      border-radius:14px;
      background: rgba(255,255,255,.96);
      box-shadow: 0 10px 24px rgba(15,23,42,.06);
      padding:10px;
      min-width:0;
    }
    .slotsRowHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
      flex-wrap:wrap;
    }
    .slotsRowTitle{
      font-weight:900;
      color:var(--text);
      font-size:12px;
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
    }
    .slotsRowTitle .badge{flex:0 0 auto;}
    .slotsRowChips{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      min-width:0;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>QuirófanosH9O</h1>
          <small>Solicitud de quirófano + coordinación (perfil master)</small>
        </div>
      </div>

      <div class="row">
        <div class="pill" id="pillSession">
          <small>Usuario</small> <span id="pillUser">—</span>
          <small>Perfil</small> <span id="pillRole">—</span>
        </div>
        <button class="btn small ghost hide" id="btnLogout">Salir</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <h2>Acceso</h2>

        <label>PIN (contraseña)</label>
        <input id="pinInput" type="password" inputmode="numeric" placeholder="Introduce tu PIN" />

        <div class="actions">
          <button class="btn primary" id="btnLogin">Entrar</button>
          <button class="btn" id="btnClear">Limpiar</button>
        </div>

        <div id="msgLogin" class="msg hide"></div>

        <div class="hr"></div>

        <div class="actions">
          <button class="btn" id="btnToggleSignup">Darme de alta</button>
        </div>

        <div id="signupBox" class="hide">
          <h3 style="margin-top:10px">Alta profesional (solo @vithas.es)</h3>

          <label>Nombre</label><input id="suNombre" placeholder="Nombre" />
          <label>Apellidos</label><input id="suApellidos" placeholder="Apellidos" />
          <label>Servicio / Especialidad</label><input id="suEsp" placeholder="Ej: Traumatología" />
          <label>Correo @vithas.es</label><input id="suCorreo" placeholder="nombre@vithas.es" />
          <label>Teléfono</label><input id="suTel" placeholder="Teléfono" />

          <div class="actions">
            <button class="btn good" id="btnSignup">Completar alta</button>
          </div>
          <div id="msgSignup" class="msg hide"></div>
        </div>

        <div class="hr"></div>

        <h2>Panel</h2>
        <div class="actions">
          <button class="btn hide" id="btnGoReserve">Solicitar quirófano</button>
          <button class="btn hide" id="btnGoMine">Mis solicitudes</button>

          <button class="btn hide" id="btnGoGrid">Parrilla</button>
          <button class="btn hide" id="btnGoStruct">Generar Quirófanos</button>
          <button class="btn hide" id="btnGoWait">Lista de espera</button>
          <button class="btn hide" id="btnGoReport">Reporte</button>
        </div>

        <div id="msgMenu" class="msg hide"></div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <!-- USER: RESERVAR -->
        <div id="viewReserve" class="hide">
          <h2>Solicitud de quirófano</h2>
          <div class="row">
            <div style="flex:1;min-width:260px">
              <label>Fecha</label>
              <div class="row" style="gap:6px">
                <input id="rvDate" type="date" style="flex:1;min-width:0" />
                <button class="btn small" id="btnRvPrevDay" title="Día anterior">←</button>
                <button class="btn small" id="btnRvNextDay" title="Día siguiente">→</button>
              </div>
            </div>
            <div style="width:160px">
              <label>Duración (h)</label>
              <select id="rvHours">
                <option>1</option><option>2</option><option>3</option><option>4</option>
                <option>5</option><option>6</option><option>7</option><option>8</option>
              </select>
            </div>
          </div>

          <div class="actions">
            <button class="btn primary" id="btnCheckSlots">Ver disponibilidad</button>
            <button class="btn warn hide" id="btnOpenWaitlistFromReserve">Solicitar lista de espera</button>
          </div>

          <div id="slotsBox" class="slots"></div>
          <div id="msgReserve" class="msg hide"></div>
        </div>

        <!-- USER: MIS RESERVAS -->
        <div id="viewMine" class="hide">
          <h2>Mis solicitudes</h2>

          <div class="row">
            <div style="width:220px">
              <label>Horizonte (días)</label>
              <select id="mineDays">
                <option value="30">30</option>
                <option value="60">60</option>
                <option value="90">90</option>
                <option value="180">180</option>
              </select>
            </div>
            <div class="actions" style="margin-top:26px">
              <button class="btn primary" id="btnLoadMine">Actualizar</button>
            </div>
          </div>

          <div id="mineBox" class="tableWrap" style="margin-top:10px"></div>
          <div id="msgMine" class="msg hide"></div>
        </div>

        <!-- MASTER: GRID -->
        <div id="viewGrid" class="hide">
          <h2>Parrilla quirúrgica</h2>
          <div class="row">
            <div style="flex:1;min-width:260px">
              <label>Fecha</label>
              <div class="row" style="gap:6px">
                <input id="gdDate" type="date" style="flex:1;min-width:0" />
                <button class="btn small" id="btnGridPrevDay" title="Día anterior">←</button>
                <button class="btn small" id="btnGridNextDay" title="Día siguiente">→</button>
              </div>
            </div>
            <div style="width:160px; display:none">
              <label>Duración (h) reserva</label>
              <select id="gdHours">
                <option>1</option><option>2</option><option>3</option><option>4</option>
                <option>5</option><option>6</option><option>7</option><option>8</option>
              </select>
            </div>
            <div class="actions" style="margin-top:26px">
              <button class="btn primary" id="btnLoadGrid">Cargar parrilla</button>
            </div>
          </div>

          <div id="gridReserveInfo" class="msg hide" style="margin-top:8px"></div>
          <div class="kpi" id="gridKpis"></div>

          <div class="actions" style="margin-top:8px">
            <button class="btn small" id="btnToggleAdvanced">Búsqueda avanzada</button>
          </div>
          <div id="advancedBox" class="hide" style="margin-top:4px">
            <label>Quirófanos incluidos en KPIs</label>
            <div id="orCalcChips" class="weekPick"></div>
          </div>

          <div id="gridBox" class="tableWrap" style="margin-top:10px"></div>
          <div id="msgGrid" class="msg hide"></div>
        </div>

        <!-- MASTER: ESTRUCTURALES + NO ESTRUCTURALES -->
        <div id="viewStruct" class="hide">
          <h2>Generar quirófanos</h2>

          <div class="structStack">
            <!-- NO ESTRUCTURALES (ARRIBA) -->
            <div class="structPanel">
              <h3>Crear quirófano NO estructural (Master)</h3>

              <div class="row">
                <div style="flex:1;min-width:200px">
                  <label>Fecha</label>
                  <input id="stNSDate" type="date" />
                </div>
                <div style="width:160px">
                  <label>Duración (h)</label>
                  <select id="stNSDur">
                    <option>1</option><option>2</option><option>3</option><option>4</option>
                    <option>5</option><option>6</option><option>7</option><option>8</option>
                    <option>9</option><option>10</option><option>11</option><option>12</option>
                  </select>
                </div>
              </div>

              <div class="row">
                <div style="flex:1;min-width:220px">
                  <label>Usuario (lista)</label>
                  <select id="stNSDoctorSelect">
                    <option value="">(Cargando profesionales…)</option>
                  </select>
                </div>
                <div style="flex:1;min-width:220px">
                  <label>Usuario (email editable)</label>
                  <input id="stNSDoctorEmail" placeholder="nombre@vithas.es" />
                </div>
              </div>

              <div class="row">
                <div style="flex:1;min-width:220px">
                  <label>Etiqueta (grupo / cirujano)</label>
                  <input id="stNSLabel" placeholder="Ej: Traumatología Dr. X" />
                </div>
              </div>

              <div class="actions">
                <button class="btn primary" id="btnNSFindSlots">Buscar huecos</button>
                <button class="btn good" id="btnNSAssignSlot">Asignar hueco seleccionado</button>
              </div>

              <div id="stNSSlotsBox" class="slots"></div>
              <div id="msgStructNon" class="msg hide"></div>
            </div>

            <!-- EDITOR ESTRUCTURAL -->
            <div class="structPanel">
              <div class="actions" style="margin-top:0">
                <button class="btn" id="btnNewStruct">Nuevo</button>
                <button class="btn good" id="btnSaveStruct">Guardar</button>
                <button class="btn bad" id="btnDeleteStructById">Eliminar por ID</button>
                <button class="btn primary" id="btnReloadStruct">Actualizar listado</button>
              </div>

              <div id="msgStructEdit" class="msg hide"></div>

              <div class="hr"></div>
              <h3>Editor de programación estructural</h3>

              <div class="row">
                <div style="flex:1;min-width:240px">
                  <label>ID (vacío = nuevo)</label>
                  <input id="stId" placeholder="(vacío para crear)" />
                </div>
                <div style="flex:1;min-width:240px">
                  <label>Equipo / Servicio (etiqueta)</label>
                  <input id="stLabel" placeholder="Ej: Traumatología COTA" />
                </div>
              </div>

              <div class="row">
                <div style="flex:1;min-width:240px">
                  <label>Quirófano</label>
                  <select id="stOr"></select>
                </div>
                <div style="width:160px">
                  <label>Hora inicio</label>
                  <select id="stStartHour"></select>
                </div>
                <div style="width:160px">
                  <label>Duración (h)</label>
                  <select id="stDur">
                    <option>1</option><option>2</option><option>3</option><option>4</option>
                    <option>5</option><option>6</option><option>7</option><option>8</option>
                    <option>9</option><option>10</option><option>11</option><option>12</option>
                  </select>
                </div>
              </div>

              <div class="row">
                <div style="flex:1;min-width:240px">
                  <label>Inicio</label>
                  <input id="stStartDate" type="date" />
                </div>
                <div style="flex:1;min-width:240px">
                  <label>Fin (vacío = 31/12)</label>
                  <input id="stEndDate" type="date" />
                </div>
              </div>

              <label>Días de la semana</label>
              <div class="row">
                <label style="display:flex;gap:8px;align-items:center"><input type="checkbox" class="stDow" value="MONDAY">L</label>
                <label style="display:flex;gap:8px;align-items:center"><input type="checkbox" class="stDow" value="TUESDAY">M</label>
                <label style="display:flex;gap:8px;align-items:center"><input type="checkbox" class="stDow" value="WEDNESDAY">X</label>
                <label style="display:flex;gap:8px;align-items:center"><input type="checkbox" class="stDow" value="THURSDAY">J</label>
                <label style="display:flex;gap:8px;align-items:center"><input type="checkbox" class="stDow" value="FRIDAY">V</label>
                <label style="display:flex;gap:8px;align-items:center"><input type="checkbox" class="stDow" value="SATURDAY">S</label>
                <label style="display:flex;gap:8px;align-items:center"><input type="checkbox" class="stDow" value="SUNDAY">D</label>
              </div>

              <div class="row">
                <div style="flex:1;min-width:240px">
                  <label>Cadencia</label>
                  <select id="stCadence">
                    <option value="WEEKLY">Semanales</option>
                    <option value="MONTH_WEEKS">Cadencia personalizada (semanas del mes)</option>
                  </select>
                </div>

                <div style="flex:1;min-width:240px" id="boxWeekly">
                  <label>Cada cuántas semanas</label>
                  <select id="stIntervalWeeks">
                    <option>1</option><option>2</option><option>3</option><option>4</option>
                  </select>
                </div>

                <div style="flex:1;min-width:240px" id="boxMonthWeeks" class="hide">
                  <label>Semanas del mes</label>
                  <div class="weekPick">
                    <label class="wchip"><input type="checkbox" class="stWom" value="1"><b>1</b>ª</label>
                    <label class="wchip"><input type="checkbox" class="stWom" value="2"><b>2</b>ª</label>
                    <label class="wchip"><input type="checkbox" class="stWom" value="3"><b>3</b>ª</label>
                    <label class="wchip"><input type="checkbox" class="stWom" value="4"><b>4</b>ª</label>
                    <label class="wchip"><input type="checkbox" class="stWom" value="5"><b>5</b>ª</label>
                  </div>
                  <div class="hint">Interpretación por “1º/3º lunes”, etc. según el/los weekday seleccionados.</div>
                </div>
              </div>
            </div>

            <!-- LISTA ESTRUCTURAL -->
            <div class="structPanel">
              <h3>Listado de programación estructural</h3>

              <div id="structSummary" class="msg" style="margin-top:8px"></div>

              <div class="hr"></div>

              <div class="filterBar">
                <div class="field">
                  <label>Filtrar por equipo (etiqueta)</label>
                  <select id="structTeamFilter">
                    <option value="">(Todos)</option>
                  </select>
                </div>
                <div>
                  <button class="btn small" id="btnStructClearFilter">Quitar filtro</button>
                </div>
              </div>

              <div id="msgStruct" class="msg hide"></div>
              <div id="structList" class="tableWrap" style="margin-top:10px"></div>
            </div>
          </div>
        </div>

        <!-- MASTER: WAIT (ACTUALIZADO a “función nueva”) -->
        <div id="viewWait" class="hide">
          <h2>Lista de espera</h2>

          <div class="row">
            <div style="width:260px">
              <label>Mostrar</label>
              <select id="wlFilter">
                <option value="pending">Pendientes (sin pasadas)</option>
                <option value="pendingAll">Pendientes (incluye pasadas)</option>
              </select>
            </div>
            <div class="actions" style="margin-top:26px">
              <button class="btn primary" id="btnLoadWait">Actualizar</button>
            </div>
          </div>

          <div id="msgWait" class="msg hide"></div>
          <div id="waitList" style="margin-top:10px"></div>
        </div>

        <!-- MASTER: REPORT -->
        <div id="viewReport" class="hide">
          <h2>Reporte</h2>
          <div class="row">
            <div style="flex:1;min-width:260px">
              <label>Email destino</label>
              <input id="rpEmail" placeholder="destino@..." />
            </div>
          </div>
          <div class="row">
            <div style="flex:1;min-width:220px">
              <label>Inicio</label>
              <input id="rpStart" type="date" />
            </div>
            <div style="flex:1;min-width:220px">
              <label>Fin</label>
              <input id="rpEnd" type="date" />
            </div>
          </div>
          <div class="actions">
            <button class="btn primary" id="btnSendReport">Enviar reporte (Dirección)</button>
          </div>
          <div class="hint">Incluye visión global y desglosa <b>Programado</b>, <b>Especiales (Híbrido)</b> y <b>Urgencias/24h</b>. Métrica: <b>horas reales</b> (no número de eventos).</div>
          <div id="msgReport" class="msg hide"></div>

          <div class="hr"></div>

          <div class="rhead">
            <h3 style="margin:0">Reporte estructural (visual)</h3>
            <div class="actions" style="margin-top:0">
              <button class="btn small primary" id="btnStructVisualReport">Generar / actualizar</button>
            </div>
          </div>
          <div class="hint">Distribución de quirófanos estructurales por <b>día</b>, <b>quirófano</b> y <b>sesión</b> (mañana/tarde).</div>
          <div id="structVisualReport" class="reportGrid hide"></div>
        </div>

        <!-- DEFAULT -->
        <div id="viewWelcome">
          <h2>Bienvenido</h2>
          <div class="msg">
            1) Introduce tu PIN.<br/>
            2) Si no tienes PIN, pulsa <b>“Darme de alta”</b>.<br/>
            3) Al acceder, verás el panel según tu perfil.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modalBack" class="modalBack hide">
    <div class="modal">
      <button class="btn small ghost x" id="btnModalClose">Cerrar</button>
      <h3 id="modalTitle">Detalle</h3>
      <div id="modalBody" class="msg"></div>

      <div id="modalForm" class="mgrid hide" style="margin-top:10px">
        <div>
          <label>Acción</label>
          <select id="mfAction" disabled>
            <option value="STRUCT_EDIT_BLOCK">Editar bloque estructural</option>
            <option value="NON_EDIT">Editar bloque NO estructural</option>
          </select>
        </div>

        <div>
          <label>Duración (h)</label>
          <select id="mfHours">
            <option>1</option><option>2</option><option>3</option><option>4</option>
            <option>5</option><option>6</option><option>7</option><option>8</option>
            <option>9</option><option>10</option><option>11</option><option>12</option>
          </select>
        </div>

        <div>
          <label>Etiqueta</label>
          <input id="mfLabel" placeholder="Ej: MASTER / Equipo / Servicio" />
        </div>

        <div>
          <label>Quirófano</label>
          <select id="mfOr"></select>
        </div>

        <div class="full">
          <div class="hint" id="mfHint"></div>
        </div>

        <div class="full actions">
          <button class="btn good" id="btnModalApply">Aplicar cambios</button>
        </div>
      </div>

      <div id="modalActions" class="actions"></div>
      <div id="modalMsg" class="msg hide"></div>
    </div>
  </div>

  <!-- Loading -->
  <div id="loadingBar" class="loadingBar hide" aria-live="polite">
    <div>
      <div class="txt" id="loadingText">Procesando…</div>
      <div class="sub" id="loadingSub">Por favor, espera</div>
    </div>
    <div class="dot" title="Procesando"></div>
  </div>

<script>
  // ===== CONSTANTES FRONT =====
  const OR_LIST = [
    "Sótano 1","Sótano 2","Sótano 3","Sótano 4","Sótano 5","Sótano 6",
    "Quirófano Híbrido",
    "Centrales 1","Centrales 2","Centrales 3","Centrales 4","Centrales 5","Centrales 6","Centrales 7","Centrales 8",
    "Maternidad 1","Maternidad 2","Maternidad 3",
    "Urgencias",
    "Paritorio 1","Paritorio 2"
  ];

  const S = {
    pin: null,
    role: null,           // "Master" | "User"
    doctor: null,
    emailVisible: null,

    lastSlots: [],
    lastReserveQuery: null,
    lastGrid: null,

    structRulesCache: [],
    structTeamFilter: "",
    orCalcSelected: [],

    modalCtx: null,

    doctorList: [],
    doctorListLoaded: false,

    masterNSQuery: null,
    masterNSSlots: [],
    masterNSSelectedIndex: -1
  };

  const $ = (id)=>document.getElementById(id);

  function showMsg(el, text, kind){
    if(!el) return;
    el.classList.remove("hide","ok","bad","warn");
    el.textContent = text || "";
    if(kind) el.classList.add(kind);
  }
  function hideMsg(el){
    if(!el) return;
    el.classList.add("hide");
    el.textContent = "";
    el.classList.remove("ok","bad","warn");
  }

  function setSessionPill(){
    $("pillUser").textContent = S.emailVisible || "—";
    $("pillRole").textContent = S.role || "—";
    $("btnLogout").classList.toggle("hide", !S.pin);
  }
  function hideAllViews(){
    ["viewWelcome","viewReserve","viewMine","viewGrid","viewStruct","viewWait","viewReport"]
      .forEach(v => $(v).classList.add("hide"));
  }
  function go(viewId){
    hideAllViews();
    $(viewId).classList.remove("hide");
  }
  function isMaster(){ return S.role === "Master"; }

  // ===== FECHAS: SIEMPRE MOSTRAR DD/MM/AAAA EN TEXTO =====
  function fmtDMY(dateStr){ // "YYYY-MM-DD" -> "DD/MM/YYYY"
    if(!dateStr) return "";
    const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(String(dateStr));
    if(!m) return String(dateStr);
    return `${m[3]}/${m[2]}/${m[1]}`;
  }

  // menú: quitar parrilla a usuarios generales
  function setMenuButtons(){
    const master = isMaster();
    $("btnGoReserve").classList.toggle("hide", !S.pin || master);
    $("btnGoMine").classList.toggle("hide", !S.pin || master);

    $("btnGoGrid").classList.toggle("hide", !S.pin || !master);

    $("btnGoStruct").classList.toggle("hide", !S.pin || !master);
    $("btnGoWait").classList.toggle("hide", !S.pin || !master);
    $("btnGoReport").classList.toggle("hide", !S.pin || !master);
  }

  function todayISO(){
    const d = new Date();
    d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
    return d.toISOString().slice(0,10);
  }
  function addDaysISO(n){
    const d = new Date();
    d.setDate(d.getDate() + n);
    d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
    return d.toISOString().slice(0,10);
  }

  // Helper mover fechas en inputs date
  function shiftDate(inputId, deltaDays){
    const input = $(inputId);
    if(!input) return null;
    let val = input.value;
    if(!val){
      val = todayISO();
    }
    const d = new Date(val+"T00:00:00");
    d.setDate(d.getDate() + deltaDays);
    d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
    const iso = d.toISOString().slice(0,10);
    input.value = iso;
    return iso;
  }

  // Navegación días
  function moveGridDay(delta){
    shiftDate("gdDate", delta);
    loadGrid();
  }
  function moveReserveDay(delta){
    shiftDate("rvDate", delta);
    checkSlots();
  }

  
  // ===== Busy & backend wrapper (GitHub Pages + GAS) =====
  window.window.sessionToken = (typeof window.window.sessionToken !== 'undefined') ? window.window.sessionToken : 1;
  let busyCount = 0;
  const inFlightKeys = new Set();
  const disabledEls = new Set();

  const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyiM2Do1ZEupkYJ02seCDCj4PipK_bcfFAw5k4DRBrVmEV7JPYGuuVDf-KwKxCCB3_0XA/exec";

  function setBusy(isBusy, msg){
    const bar = $("loadingBar");
    const txt = $("loadingText");
    const sub = $("loadingSub");
    if(isBusy){
      busyCount++;
      txt.textContent = msg || "Procesando…";
      sub.textContent = "Por favor, espera";
      bar.classList.remove("hide");
    }else{
      busyCount = Math.max(0, busyCount - 1);
      if(busyCount === 0){
        bar.classList.add("hide");
        txt.textContent = "Procesando…";
        sub.textContent = "Por favor, espera";
      }
    }
  }

  function disableEls(els, disabled){
    const arr = Array.isArray(els) ? els : [els];
    arr.filter(Boolean).forEach(el=>{
      if(disabled){
        el.disabled = true;
        disabledEls.add(el);
      }else{
        el.disabled = false;
        disabledEls.delete(el);
      }
    });
  }

  function resetAllBusyUI(){
    busyCount = 0;
    inFlightKeys.clear();
    $("loadingBar").classList.add("hide");
    for(const el of Array.from(disabledEls)){
      try{ el.disabled = false; }catch(_e){}
    }
    disabledEls.clear();
  }

  async function callGAS(fnName, args, opt){
    const o = opt || {};
    const key = o.key ? String(o.key) : "";
    if(key && inFlightKeys.has(key)) return;
    if(key) inFlightKeys.add(key);

    const myToken = window.window.sessionToken;
    setBusy(true, o.msg || "Procesando…");
    disableEls(o.disable || [], true);

    const finalize = ()=>{
      if(key) inFlightKeys.delete(key);
      disableEls(o.disable || [], false);
      setBusy(false);
    };

    try{
      const res = await fetch(GAS_WEBAPP_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ fn: fnName, args: args || [] })
      });

      if(myToken !== window.window.sessionToken) { finalize(); return; }
      if(!res.ok) throw new Error("HTTP " + res.status);

      const json = await res.json();
      if(!json || json.ok !== true) throw new Error(json?.error || "Error en backend");

      try{ o.onSuccess && o.onSuccess(json.data); }
      finally{ finalize(); }
    }catch(err){
      if(myToken !== window.window.sessionToken) { finalize(); return; }
      console.error("GAS ERROR:", err);
      try{ o.onFailure && o.onFailure(err); }
      finally{ finalize(); }
    }
  }


  // ===== OR filter para KPIs parrilla =====

  function initOrCalcDefaults(){
    const exclude = new Set(["Sótano 6","Quirófano Híbrido","Urgencias","Paritorio 1","Paritorio 2"]);
    S.orCalcSelected = OR_LIST.filter(name => !exclude.has(name));
  }

  function buildOrCalcChips(){
    const box = $("orCalcChips");
    if(!box) return;
    box.innerHTML = "";
    const selected = new Set(S.orCalcSelected || []);
    OR_LIST.forEach(name=>{
      const lbl = document.createElement("label");
      lbl.className = "wchip";
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = selected.has(name);
      cb.onchange = ()=>{
        const set = new Set(S.orCalcSelected || []);
        if(cb.checked) set.add(name); else set.delete(name);
        S.orCalcSelected = Array.from(set);
        renderGridKpis();
      };
      const b = document.createElement("b");
      b.textContent = name;
      lbl.appendChild(cb);
      lbl.appendChild(b);
      box.appendChild(lbl);
    });
  }

  function getSelectedORsForCalc(){
    const arr = S.orCalcSelected || [];
    if(!arr.length) return OR_LIST.slice();
    return arr.slice();
  }

  // ✅ NUEVO: inferir duración del bloque NO estructural desde la fila
  function inferEventHoursInRow_(row, startIdx){
    const id = row.cells[startIdx]?.eventId;
    if(!id) return 1;
    let n = 0;
    for(let i = startIdx; i < row.cells.length; i++){
      if(row.cells[i]?.eventId !== id) break;
      n++;
    }
    return Math.max(1, n);
  }

  // ===== LOGIN / LOGOUT =====
  function login(){
    hideMsg($("msgLogin"));
    const pin = ($("pinInput").value || "").trim();
    if(!pin) return showMsg($("msgLogin"), "Introduce tu PIN.", "warn");

    callGAS("getDoctorByPin", [pin], {
      key: "login",
      disable: [$("btnLogin"), $("btnClear"), $("pinInput")],
      msg: "Validando acceso…",
      onSuccess: (doc)=>{
        S.pin = pin;
        S.doctor = doc;
        S.role = (doc.tipo === "Master") ? "Master" : "User";
        S.emailVisible = (doc.correo || doc.email || doc.mail || "—");

        setSessionPill();
        setMenuButtons();
        hideMsg($("msgLogin"));
        hideMsg($("msgMenu"));

        if(isMaster()){
          go("viewGrid");
          $("gdDate").value = todayISO();
          loadGrid();
        } else {
          go("viewReserve");
          $("rvDate").value = addDaysISO(1);
          $("rvHours").value = "2";
        }
      },
      onFailure: (e)=> showMsg($("msgLogin"), e?.message || String(e), "bad")
    });
  }

  function logout(){
    S.pin = null;
    S.role = null;
    S.doctor = null;
    S.emailVisible = null;
    S.lastSlots = [];
    S.lastGrid = null;
    S.structRulesCache = [];
    S.modalCtx = null;
    S.doctorList = [];
    S.doctorListLoaded = false;
    S.masterNSQuery = null;
    S.masterNSSlots = [];
    S.masterNSSelectedIndex = -1;

    sessionToken++;
    resetAllBusyUI();
    setSessionPill();
    setMenuButtons();
    $("pinInput").value = "";
    hideMsg($("msgLogin"));
    hideMsg($("msgMenu"));
    go("viewWelcome");
  }

  // ===== SIGNUP =====
  function toggleSignup(){
    $("signupBox").classList.toggle("hide");
    hideMsg($("msgSignup"));
  }

  function signup(){
    hideMsg($("msgSignup"));
    const data = {
      nombre:    $("suNombre").value,
      apellidos: $("suApellidos").value,
      especialidad: $("suEsp").value,
      correo:    $("suCorreo").value,
      telefono:  $("suTel").value
    };
    callGAS("signupDoctor", [data], {
      key:"signup",
      disable:[$("btnSignup")],
      msg:"Registrando alta…",
      onSuccess:(res)=>{
        showMsg($("msgSignup"), res?.message || "Alta completada.", "ok");
      },
      onFailure:(e)=>{
        showMsg($("msgSignup"), e?.message || String(e), "bad");
      }
    });
  }

  // ===== RESERVAS (USUARIO) =====
  function checkSlots(){
    hideMsg($("msgReserve"));
    $("slotsBox").innerHTML = "";
    $("btnOpenWaitlistFromReserve").classList.add("hide");

    const dateStr = $("rvDate").value;
    const hours = parseInt($("rvHours").value,10);

    if(!dateStr) return showMsg($("msgReserve"), "Selecciona una fecha.", "warn");

    callGAS("getDisponibilidadAuto", [S.pin, dateStr, hours], {
      key:"slots",
      disable:[$("btnCheckSlots")],
      msg:"Buscando huecos disponibles…",
      onSuccess:(res)=>{
        S.lastSlots = res.slots || [];
        S.lastReserveQuery = { dateStr, hours };

        if(!res.slots || !res.slots.length){
          showMsg($("msgReserve"), "No hay huecos disponibles para esa fecha y duración.", "warn");
          $("btnOpenWaitlistFromReserve").classList.remove("hide");
          return;
        }

        const box = $("slotsBox");
        box.innerHTML = "";
        res.slots.forEach(iso=>{
          const d = new Date(iso);
          const btn = document.createElement("button");
          btn.className = "slot";
          btn.textContent = `${d.toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"})}`;
          btn.onclick = ()=>reserveSlot(iso, hours, dateStr);
          box.appendChild(btn);
        });
        showMsg($("msgReserve"), "Selecciona el hueco que prefieras.", "ok");
      },
      onFailure:(e)=>{
        showMsg($("msgReserve"), e?.message || String(e), "bad");
      }
    });
  }

  function reserveSlot(startISO, hours, dateStr){
    hideMsg($("msgReserve"));
    if(!confirm("¿Confirmar la reserva en ese hueco?")) return;

    callGAS("reservarAuto", [S.pin, startISO, hours], {
      key:"reserve",
      msg:"Creando reserva…",
      onSuccess:(res)=>{
        showMsg($("msgReserve"), "Reserva creada correctamente.", "ok");
      },
      onFailure:(e)=>{
        showMsg($("msgReserve"), e?.message || String(e), "bad");
      }
    });
  }

  function openWaitlistFromReserve(){
    hideMsg($("msgReserve"));
    const q = S.lastReserveQuery;
    if(!q || !q.dateStr){
      return showMsg($("msgReserve"), "Primero busca disponibilidad para poder enviar a lista de espera.", "warn");
    }
    const note = prompt("Añade una nota opcional para la lista de espera (diagnóstico, prioridad, etc.):","");

    callGAS("submitWaitlist", [S.pin, q.dateStr, q.hours, "ANY", note || ""], {
      key:"waitlistFromReserve",
      msg:"Enviando solicitud a lista de espera…",
      onSuccess:(res)=>{
        showMsg($("msgReserve"), res?.message || "Solicitud enviada a lista de espera.", "ok");
      },
      onFailure:(e)=>{
        showMsg($("msgReserve"), e?.message || String(e), "bad");
      }
    });
  }

  // ===== MIS RESERVAS (USUARIO) =====
  function loadMine(){
    hideMsg($("msgMine"));
    $("mineBox").innerHTML = "";

    const days = $("mineDays").value || "30";

    callGAS("getMyReservations", [S.pin, days], {
      key:"mine",
      disable:[$("btnLoadMine")],
      msg:"Cargando tus reservas…",
      onSuccess:(res)=>{
        const list = res.reservations || [];
        if(!list.length){
          showMsg($("msgMine"), "No tienes reservas en el horizonte seleccionado.", "warn");
          return;
        }
        hideMsg($("msgMine"));
        const wrap = $("mineBox");
        const table = document.createElement("table");
        const thead = document.createElement("thead");
        thead.innerHTML = "<tr><th>Fecha</th><th>Hora</th><th>Fin</th><th>Quirófano</th><th>Título</th><th></th></tr>";
        table.appendChild(thead);
        const tbody = document.createElement("tbody");
        list.forEach(r=>{
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${escapeHtml(fmtDMY(r.date))}</td>
            <td>${escapeHtml(r.start)}</td>
            <td>${escapeHtml(r.end)}</td>
            <td>${escapeHtml(r.orName || "")}</td>
            <td>${escapeHtml(r.title || "")}</td>
          `;
          const tdBtn = document.createElement("td");
          const b = document.createElement("button");
          b.className = "btn small bad";
          b.textContent = "Cancelar";
          b.onclick = ()=>cancelMyReservation(r.eventId);
          tdBtn.appendChild(b);
          tr.appendChild(tdBtn);
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        wrap.appendChild(table);
      },
      onFailure:(e)=>{
        showMsg($("msgMine"), e?.message || String(e), "bad");
      }
    });
  }

  function cancelMyReservation(eventId){
    if(!confirm("¿Seguro que quieres cancelar esta reserva?")) return;
    callGAS("cancelReservation", [S.pin, eventId], {
      key:"cancelMy",
      msg:"Cancelando reserva…",
      onSuccess:(res)=>{
        showMsg($("msgMine"), res?.message || "Reserva cancelada.", "ok");
        loadMine();
      },
      onFailure:(e)=>{
        showMsg($("msgMine"), e?.message || String(e), "bad");
      }
    });
  }

  // ===== GRID =====
  function loadGrid(){
    hideMsg($("msgGrid"));
    $("gridBox").innerHTML = "";
    $("gridKpis").innerHTML = "";

    const dateStr = $("gdDate").value || todayISO();
    $("gdDate").value = dateStr;

    callGAS("getGridOccupancy", [S.pin, dateStr], {
      key:"grid",
      disable:[$("btnLoadGrid")],
      msg:"Cargando parrilla…",
      onSuccess:(res)=>{
        S.lastGrid = res;
        renderGrid(res);
        renderGridKpis();
      },
      onFailure:(e)=>{
        showMsg($("msgGrid"), e?.message || String(e), "bad");
      }
    });
  }

  function renderGrid(data){
    const box = $("gridBox");
    box.innerHTML = "";
    if(!data || !data.rows || !data.rows.length){
      showMsg($("msgGrid"), "No hay información para esa fecha.", "warn");
      return;
    }
    hideMsg($("msgGrid"));

    const table = document.createElement("table");
    const thead = document.createElement("thead");
    const trh = document.createElement("tr");
    const thOr = document.createElement("th");
    thOr.textContent = "Quirófano";
    trh.appendChild(thOr);

    data.hoursOrder.forEach(h=>{
      const th = document.createElement("th");
      th.textContent = String(h).padStart(2,"0")+":00";
      trh.appendChild(th);
    });
    thead.appendChild(trh);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    data.rows.forEach((row)=>{
      const tr = document.createElement("tr");
      const tdOr = document.createElement("td");
      tdOr.textContent = row.orName;
      tr.appendChild(tdOr);

      row.cells.forEach((cell, ci)=>{
        const td = document.createElement("td");
        td.dataset.orName = row.orName;
        td.dataset.hour = cell.hour;
        td.dataset.status = cell.status;
        td.dataset.date = data.date;

        if(cell.status === "NA"){
          td.className = "cellNA";
          td.textContent = "";
        } else if(cell.status === "FREE"){
          td.className = "cellFree";
          td.textContent = "Libre";
        } else if(cell.status === "NON"){
          td.className = "cellNon";
          td.textContent = cell.displayTitle || "No estructural";
          td.dataset.cellIndex = String(ci);
        } else if(cell.status === "STRUCT"){
          td.className = "cellStruct";
          td.textContent = cell.displayTitle || "Estructural";
        }

        if(cell.status !== "NA"){
          if(cell.eventId) td.dataset.eventId = cell.eventId;
          if(cell.ruleId)  td.dataset.ruleId  = cell.ruleId;
          if(cell.label)   td.dataset.label   = cell.label;
          td.onclick = ()=>onGridCellClick(td);
        }

        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    box.appendChild(table);
  }

  function renderGridKpis(){
    const box = $("gridKpis");
    box.innerHTML = "";
    if(!S.lastGrid || !S.lastGrid.rows) return;

    const selectedOrs = new Set(getSelectedORsForCalc());
    let free = 0, non = 0, struct = 0;

    S.lastGrid.rows.forEach(row=>{
      if(!selectedOrs.has(row.orName)) return;
      row.cells.forEach(c=>{
        if(c.status === "FREE") free++;
        else if(c.status === "NON") non++;
        else if(c.status === "STRUCT") struct++;
      });
    });

    const mkBox = (title, val, desc)=>{
      const d = document.createElement("div");
      d.className = "box";
      d.innerHTML = `<span>${escapeHtml(title)}</span><b>${val}</b><div>${escapeHtml(desc)}</div>`;
      return d;
    };

    box.appendChild(mkBox("Huecos libres", free, "Celdas libres en quirófanos seleccionados"));
    box.appendChild(mkBox("Bloques no estructurales", non, "Reservas no estructurales"));
    box.appendChild(mkBox("Bloques estructurales", struct, "Programación estructural ese día"));
  }

  function buildEventBlockInfo(orName, eventId){
    const g = S.lastGrid;
    if(!g || !g.rows) return null;
    const row = g.rows.find(r => r.orName === orName);
    if(!row) return null;
    const hours = row.cells
      .filter(c => c.eventId === eventId)
      .map(c => c.hour);
    if(!hours.length) return null;
    hours.sort((a,b)=>a-b);
    return {
      startHour: hours[0],
      duration: hours.length
    };
  }

  function onGridCellClick(td){
    const status  = td.dataset.status;
    const orName  = td.dataset.orName;
    const hour    = parseInt(td.dataset.hour,10);
    const dateStr = td.dataset.date;
    const eventId = td.dataset.eventId || "";
    const ruleId  = td.dataset.ruleId || "";
    const label   = td.dataset.label || "";
    const cellIndex = parseInt(td.dataset.cellIndex || "0", 10);

    const ctx = { status, orName, hour, dateStr, eventId, ruleId, label, cellIndex };

    if(!isMaster()){
      openModalInfo(ctx);
      return;
    }

    if(status === "STRUCT"){
      openModalStruct(ctx);
    } else if(status === "NON"){
      openModalNonStruct(ctx);
    } else if(status === "FREE"){
      openModalFree(ctx);
    }
  }

  // ===== MODAL =====
  function openModalBase(title, bodyHtml){
    $("modalTitle").textContent = title;
    $("modalBody").innerHTML = bodyHtml;
    $("modalForm").classList.add("hide");
    $("modalActions").innerHTML = "";
    hideMsg($("modalMsg"));
    $("modalBack").classList.remove("hide");
  }

  function closeModal(){
    S.modalCtx = null;
    $("modalBack").classList.add("hide");
    hideMsg($("modalMsg"));
  }

  function openModalInfo(ctx){
    const body = `
      Fecha: ${fmtDMY(ctx.dateStr)}\n
      Quirófano: ${escapeHtml(ctx.orName)}\n
      Hora: ${String(ctx.hour).padStart(2,"0")}:00
    `;
    openModalBase("Detalle de celda", escapeHtml(body));
  }

  function openModalFree(ctx){
    const body = `
      Hueco libre\n
      Fecha: ${fmtDMY(ctx.dateStr)}\n
      Quirófano: ${escapeHtml(ctx.orName)}\n
      Hora: ${String(ctx.hour).padStart(2,"0")}:00\n
      (Solo consulta desde la parrilla)
    `;
    openModalBase("Hueco libre", escapeHtml(body));
  }

  function openModalNonStruct(ctx){
    const g = S.lastGrid;
    const row = g?.rows?.find(r => r.orName === ctx.orName);
    const idx = Number.isFinite(ctx.cellIndex) ? ctx.cellIndex : 0;

    const inferredHours = row ? inferEventHoursInRow_(row, idx) : 1;

    let startHour = ctx.hour;
    if(row && ctx.eventId){
      let i = idx;
      while(i > 0 && row.cells[i-1]?.eventId === ctx.eventId) i--;
      startHour = row.cells[i]?.hour ?? ctx.hour;
    }

    const startISO = `${ctx.dateStr}T${String(startHour).padStart(2,"0")}:00:00`;

    S.modalCtx = {
      mode: null,
      kind: "NON",
      dateStr: ctx.dateStr,
      orName: ctx.orName,
      eventId: ctx.eventId,
      label: ctx.label,
      startHour,
      hours: inferredHours,
      startISO
    };

    const body = `
Bloque NO estructural

Fecha: ${fmtDMY(ctx.dateStr)}
Quirófano: ${ctx.orName}
Inicio de bloque: ${String(startHour).padStart(2,"0")}:00
Duración estimada: ${inferredHours} h
Etiqueta: ${ctx.label || "(sin etiqueta)"}
EventId: ${ctx.eventId || "(no disponible)"}
    `;
    openModalBase("Bloque NO estructural", escapeHtml(body));

    const actions = $("modalActions");
    actions.innerHTML = "";

    const btnDelete = document.createElement("button");
    btnDelete.className = "btn bad";
    btnDelete.textContent = "Eliminar este quirófano NO estructural";
    btnDelete.onclick = ()=>deleteNonStructBlock();
    actions.appendChild(btnDelete);

    const btnEdit = document.createElement("button");
    btnEdit.className = "btn good";
    btnEdit.textContent = "Editar este quirófano NO estructural";
    btnEdit.onclick = ()=>prepareEditNonStructBlock();
    actions.appendChild(btnEdit);
  }

  function deleteNonStructBlock(){
    if(!S.modalCtx || !S.modalCtx.eventId) return;
    if(!confirm("¿Seguro que quieres ELIMINAR este quirófano NO estructural?")) return;

    callGAS("masterDeleteEvent", [S.pin, S.modalCtx.eventId], {
      key:"delNonStruct",
      msg:"Eliminando quirófano no estructural…",
      onSuccess:(res)=>{
        showMsg($("modalMsg"), res?.message || "Bloque eliminado.", "ok");
        loadGrid();
        setTimeout(()=>closeModal(), 800);
      },
      onFailure:(e)=>{
        showMsg($("modalMsg"), e?.message || String(e), "bad");
      }
    });
  }

  function prepareEditNonStructBlock(){
    if(!S.modalCtx) return;
    S.modalCtx.mode = "NON_EDIT";

    $("modalForm").classList.remove("hide");
    $("mfAction").value = "NON_EDIT";

    const mfOr = $("mfOr");
    mfOr.innerHTML = "";
    OR_LIST.forEach(o=>{
      const opt = document.createElement("option");
      opt.value = o;
      opt.textContent = o;
      mfOr.appendChild(opt);
    });
    mfOr.value = S.modalCtx.orName;

    $("mfLabel").value = S.modalCtx.label || "MASTER";
    $("mfHours").value = String(S.modalCtx.hours || 2);
    $("mfHint").textContent = "Editarás SOLO este bloque NO estructural (mismo EventId).";
  }

  function openModalStruct(ctx){
    const blk = buildEventBlockInfo(ctx.orName, ctx.eventId);
    if(!blk){
      const body = `
        Bloque estructural\n
        Fecha: ${fmtDMY(ctx.dateStr)}\n
        Quirófano: ${escapeHtml(ctx.orName)}\n
        Hora seleccionada: ${String(ctx.hour).padStart(2,"0")}:00\n
        (No se ha podido reconstruir el bloque completo)
      `;
      openModalBase("Bloque estructural", escapeHtml(body));
      return;
    }

    const startISO = `${ctx.dateStr}T${String(blk.startHour).padStart(2,"0")}:00:00`;

    S.modalCtx = {
      mode: null,
      kind: "STRUCT",
      dateStr: ctx.dateStr,
      orName: ctx.orName,
      eventId: ctx.eventId,
      ruleId: ctx.ruleId,
      label: ctx.label,
      startHour: blk.startHour,
      hours: blk.duration,
      startISO
    };

    const body = `
Bloque estructural

Fecha: ${fmtDMY(ctx.dateStr)}
Quirófano: ${ctx.orName}
Inicio de bloque: ${String(blk.startHour).padStart(2,"0")}:00
Duración estimada: ${blk.duration} h
Etiqueta: ${ctx.label || "(sin etiqueta)"}
RuleId: ${ctx.ruleId || "(no disponible)"}
    `;
    openModalBase("Bloque estructural", escapeHtml(body));

    const actions = $("modalActions");
    actions.innerHTML = "";

    const btnCancel = document.createElement("button");
    btnCancel.className = "btn bad";
    btnCancel.textContent = "Cancelar quirófano (solo este bloque)";
    btnCancel.onclick = ()=>cancelStructBlock();
    actions.appendChild(btnCancel);

    const btnEditBlock = document.createElement("button");
    btnEditBlock.className = "btn good";
    btnEditBlock.textContent = "Editar quirófano (solo este bloque)";
    btnEditBlock.onclick = ()=>prepareEditStructBlock();
    actions.appendChild(btnEditBlock);

    const btnEditSeries = document.createElement("button");
    btnEditSeries.className = "btn primary";
    btnEditSeries.textContent = "Editar toda la serie";
    btnEditSeries.onclick = ()=>editWholeSeriesFromRule();
    actions.appendChild(btnEditSeries);
  }

  function cancelStructBlock(){
    if(!S.modalCtx || !S.modalCtx.eventId) return;
    if(!confirm("¿Seguro que quieres cancelar este bloque estructural SOLO para este día?")) return;

    callGAS("masterCancelStructuralOccurrence", [S.pin, S.modalCtx.eventId], {
      key:"cancelStructBlock",
      msg:"Cancelando bloque estructural…",
      onSuccess:(res)=>{
        showMsg($("modalMsg"), res?.message || "Bloque cancelado.", "ok");
        loadGrid();
        setTimeout(()=>closeModal(), 800);
      },
      onFailure:(e)=>{
        showMsg($("modalMsg"), e?.message || String(e), "bad");
      }
    });
  }

  function prepareEditStructBlock(){
    if(!S.modalCtx) return;
    S.modalCtx.mode = "STRUCT_EDIT_BLOCK";
    $("mfAction").value = "STRUCT_EDIT_BLOCK";

    $("modalForm").classList.remove("hide");

    const mfOr = $("mfOr");
    mfOr.innerHTML = "";
    OR_LIST.forEach(o=>{
      const opt = document.createElement("option");
      opt.value = o;
      opt.textContent = o;
      mfOr.appendChild(opt);
    });
    mfOr.value = S.modalCtx.orName;

    $("mfLabel").value = S.modalCtx.label || "MASTER";
    $("mfHours").value = String(S.modalCtx.hours || 2);
    $("mfHint").textContent = "Editarás SOLO este bloque: se convertirá en NO estructural, sin modificar la serie original.";
  }

  function applyModalChanges(){
    if(!S.modalCtx) return;

    const label = $("mfLabel").value || "MASTER";
    const hours = parseInt($("mfHours").value,10);
    const orName = $("mfOr").value;

    if(S.modalCtx.mode === "STRUCT_EDIT_BLOCK"){
      const payload = {
        eventId: S.modalCtx.eventId,
        label,
        startISO: S.modalCtx.startISO,
        hours,
        orName
      };

      callGAS("masterEditStructuralOccurrence", [S.pin, payload], {
        key:"editStructBlock",
        msg:"Actualizando bloque estructural…",
        onSuccess:(res)=>{
          showMsg($("modalMsg"), res?.message || "Bloque actualizado.", "ok");
          loadGrid();
          setTimeout(()=>closeModal(), 800);
        },
        onFailure:(e)=>{
          showMsg($("modalMsg"), e?.message || String(e), "bad");
        }
      });
      return;
    }

    if(S.modalCtx.mode === "NON_EDIT"){
      const payload = {
        eventId: S.modalCtx.eventId,
        orName,
        startISO: S.modalCtx.startISO,
        hours,
        label
      };

      callGAS("masterUpdateNonStructural", [S.pin, payload], {
        key:"editNonStruct",
        msg:"Actualizando bloque NO estructural…",
        onSuccess:(res)=>{
          showMsg($("modalMsg"), res?.message || "Bloque actualizado.", "ok");
          loadGrid();
          setTimeout(()=>closeModal(), 800);
        },
        onFailure:(e)=>{
          showMsg($("modalMsg"), e?.message || String(e), "bad");
        }
      });
      return;
    }
  }

  function editWholeSeriesFromRule(){
    if(!S.modalCtx || !S.modalCtx.ruleId){
      showMsg($("modalMsg"), "No se ha encontrado el RuleId para esta serie.", "bad");
      return;
    }
    const ruleId = S.modalCtx.ruleId;
    go("viewStruct");
    closeModal();

    if(!S.structRulesCache || !S.structRulesCache.length){
      callGAS("listStructuralRules", [S.pin], {
        key:"listStructFromGrid",
        msg:"Cargando reglas estructurales…",
        onSuccess:(res)=>{
          S.structRulesCache = res.rules || [];
          renderStructFiltersAndList();
          loadRuleIntoEditor(ruleId);
        },
        onFailure:(e)=>{
          showMsg($("msgStruct"), e?.message || String(e), "bad");
        }
      });
    } else {
      renderStructFiltersAndList();
      loadRuleIntoEditor(ruleId);
    }
  }

  // ===== ESTRUCTURALES (MASTER) =====
  function fillStructSelectors(){
    const stOr = $("stOr");
    if(stOr){
      stOr.innerHTML = "";
      OR_LIST.forEach(o=>{
        const opt = document.createElement("option");
        opt.value = o;
        opt.textContent = o;
        stOr.appendChild(opt);
      });
    }

    const stStartHour = $("stStartHour");
    if(stStartHour){
      stStartHour.innerHTML = "";
      for(let h=0; h<24; h++){
        const opt = document.createElement("option");
        opt.value = h;
        opt.textContent = String(h).padStart(2,"0")+":00";
        stStartHour.appendChild(opt);
      }
      stStartHour.value = "8";
    }

    const mfOr = $("mfOr");
    if(mfOr){
      mfOr.innerHTML = "";
      OR_LIST.forEach(o=>{
        const opt = document.createElement("option");
        opt.value = o;
        opt.textContent = o;
        mfOr.appendChild(opt);
      });
    }

    const nsDur = $("stNSDur");
    if(nsDur){
      nsDur.value = "4";
    }
  }

  function syncCadenceUI(){
    const mode = $("stCadence").value;
    $("boxWeekly").classList.toggle("hide", mode !== "WEEKLY");
    $("boxMonthWeeks").classList.toggle("hide", mode !== "MONTH_WEEKS");
  }

  function clearStructEditor(){
    $("stId").value = "";
    $("stLabel").value = "";
    $("stOr").selectedIndex = 0;
    $("stStartHour").value = "8";
    $("stDur").value = "4";
    $("stStartDate").value = todayISO();
    $("stEndDate").value = "";
    document.querySelectorAll(".stDow").forEach(cb=> cb.checked = false);
    document.querySelectorAll(".stWom").forEach(cb=> cb.checked = false);
    $("stCadence").value = "WEEKLY";
    $("stIntervalWeeks").value = "1";
    syncCadenceUI();
    hideMsg($("msgStructEdit"));
  }

  function ruleToWeekdaysString(rule){
    const map = {
      MONDAY:"L", TUESDAY:"M", WEDNESDAY:"X", THURSDAY:"J",
      FRIDAY:"V", SATURDAY:"S", SUNDAY:"D"
    };
    return (rule.weekdays || []).map(w=>map[w] || w).join(",");
  }

  function renderStructFiltersAndList(){
    const rules = S.structRulesCache || [];

    const select = $("structTeamFilter");
    if(select){
      const labels = Array.from(new Set(rules.map(r=>String(r.label || "").trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b,"es"));
      select.innerHTML = '<option value="">(Todos)</option>';
      labels.forEach(l=>{
        const opt = document.createElement("option");
        opt.value = l;
        opt.textContent = l;
        select.appendChild(opt);
      });
      select.value = S.structTeamFilter || "";
    }

    const box = $("structList");
    const msg = $("msgStruct");
    box.innerHTML = "";
    hideMsg(msg);

    if(!rules.length){
      showMsg(msg, "No hay reglas estructurales definidas.", "warn");
      $("structSummary").textContent = "0 reglas.";
      return;
    }

    const filtered = S.structTeamFilter
      ? rules.filter(r => String(r.label || "").trim() === S.structTeamFilter)
      : rules.slice();

    const table = document.createElement("table");
    const thead = document.createElement("thead");
    thead.innerHTML = "<tr><th>ID</th><th>Equipo</th><th>Quirófano</th><th>Inicio</th><th>Fin</th><th>Hora</th><th>Duración</th><th>Cadencia</th><th>Días</th></tr>";
    table.appendChild(thead);
    const tbody = document.createElement("tbody");

    filtered.forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(r.id)}</td>
        <td>${escapeHtml(r.label || "")}</td>
        <td>${escapeHtml(r.orName || "")}</td>
        <td>${escapeHtml(fmtDMY(r.startDate || ""))}</td>
        <td>${escapeHtml(fmtDMY(r.endDate || ""))}</td>
        <td>${String(r.startHour).padStart(2,"0")}:00</td>
        <td>${r.durationHours} h</td>
        <td>${escapeHtml(r.cadenceNameEs || r.cadenceMode || "")}</td>
        <td>${escapeHtml(ruleToWeekdaysString(r))}</td>
      `;
      tr.style.cursor = "pointer";
      tr.onclick = ()=>loadRuleIntoEditor(r.id);
      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    box.appendChild(table);

    $("structSummary").textContent = `${rules.length} reglas totales. Mostrando ${filtered.length}.`;
  }

  function refreshStructList(){
    hideMsg($("msgStruct"));
    $("structList").innerHTML = "";
    $("structSummary").textContent = "Cargando reglas…";

    callGAS("listStructuralRules", [S.pin], {
      key:"listStruct",
      msg:"Cargando programación estructural…",
      onSuccess:(res)=>{
        S.structRulesCache = res.rules || [];
        renderStructFiltersAndList();
      },
      onFailure:(e)=>{
        showMsg($("msgStruct"), e?.message || String(e), "bad");
        $("structSummary").textContent = "Error al cargar reglas.";
      }
    });
  }

  function loadRuleIntoEditor(id){
    const rule = (S.structRulesCache || []).find(r => r.id === id);
    if(!rule){
      showMsg($("msgStructEdit"), "No se ha encontrado esa regla.", "bad");
      return;
    }
    $("stId").value = rule.id || "";
    $("stLabel").value = rule.label || "";
    $("stOr").value = rule.orName || OR_LIST[0];
    $("stStartHour").value = String(rule.startHour || 8);
    $("stDur").value = String(rule.durationHours || 4);
    $("stStartDate").value = rule.startDate || "";
    $("stEndDate").value = rule.endDate || "";

    document.querySelectorAll(".stDow").forEach(cb=>{
      cb.checked = (rule.weekdays || []).includes(cb.value);
    });
    document.querySelectorAll(".stWom").forEach(cb=>{
      cb.checked = (rule.weeksOfMonth || []).map(String).includes(cb.value);
    });

    $("stCadence").value = rule.cadenceMode || "WEEKLY";
    $("stIntervalWeeks").value = String(rule.intervalWeeks || 1);
    syncCadenceUI();
    showMsg($("msgStructEdit"), "Regla cargada en el editor. Modifica y pulsa Guardar.", "ok");
  }

  function saveStructFromEditor(){
    hideMsg($("msgStructEdit"));
    const weekdays = Array.from(document.querySelectorAll(".stDow:checked")).map(cb=>cb.value);
    const weeksOfMonth = Array.from(document.querySelectorAll(".stWom:checked")).map(cb=>cb.value);

    const payload = {
      id: ($("stId").value || "").trim(),
      orName: $("stOr").value,
      label: $("stLabel").value,
      startDate: $("stStartDate").value,
      endDate: $("stEndDate").value,
      startHour: $("stStartHour").value,
      durationHours: $("stDur").value,
      cadenceMode: $("stCadence").value,
      intervalWeeks: $("stIntervalWeeks").value,
      weekdays,
      weeksOfMonth
    };

    callGAS("upsertStructuralRule", [S.pin, payload], {
      key:"saveStruct",
      msg:"Guardando programación estructural…",
      onSuccess:(res)=>{
        const msg = res?.message || "Guardado.";
        if(res && res.rule && res.rule.id){
          $("stId").value = res.rule.id;
        }
        showMsg($("msgStructEdit"), msg, "ok");
        refreshStructList();
      },
      onFailure:(e)=>{
        showMsg($("msgStructEdit"), e?.message || String(e), "bad");
      }
    });
  }

  function deleteStructById(){
    hideMsg($("msgStructEdit"));
    const id = ($("stId").value || "").trim();
    if(!id) return showMsg($("msgStructEdit"), "Indica un ID para eliminar.", "warn");
    if(!confirm("¿Seguro que quieres eliminar TODA la serie estructural asociada a ese ID?")) return;

    callGAS("deleteStructuralRule", [S.pin, id], {
      key:"delStruct",
      msg:"Eliminando programación estructural…",
      onSuccess:(res)=>{
        showMsg($("msgStructEdit"), res?.message || "Estructural eliminado.", "ok");
        clearStructEditor();
        refreshStructList();
      },
      onFailure:(e)=>{
        showMsg($("msgStructEdit"), e?.message || String(e), "bad");
      }
    });
  }

  function setStructTeamFilter(){
    S.structTeamFilter = $("structTeamFilter").value || "";
    renderStructFiltersAndList();
  }

  function clearStructFilter(){
    S.structTeamFilter = "";
    $("structTeamFilter").value = "";
    renderStructFiltersAndList();
  }

  // ===== NO ESTRUCTURALES DESDE MASTER (búsqueda de huecos) =====
  function buildDoctorSelectForMaster(){
    const sel = $("stNSDoctorSelect");
    if(!sel) return;
    sel.innerHTML = '<option value="">(Seleccionar usuario)</option>';
    const list = S.doctorList || [];
    list.forEach(d=>{
      const email = d.correo || d.email || d.emailVisible || "";
      if(!email) return;
      const name = [d.nombre, d.apellidos].filter(Boolean).join(" ");
      const label = name ? `${name} – ${email}` : email;
      const opt = document.createElement("option");
      opt.value = email;
      opt.textContent = label;
      sel.appendChild(opt);
    });
  }

  function loadDoctorOptionsMaster(){
    if(S.doctorListLoaded) return;
    callGAS("listDoctorsForMaster", [S.pin], {
      key:"listDoctorsMaster",
      msg:"Cargando profesionales…",
      onSuccess:(res)=>{
        S.doctorList = res.doctors || res.lista || [];
        S.doctorListLoaded = true;
        buildDoctorSelectForMaster();
      },
      onFailure:(_)=>{
        S.doctorListLoaded = true;
      }
    });
  }

  // Calcula bloques libres
  function computeFreeBlocksForDateGrid(grid, hours){
    const results = [];
    if(!grid || !grid.rows || !hours || hours <= 0) return results;
    const needed = hours;

    grid.rows.forEach(row=>{
      const cells = row.cells || [];
      for(let i=0; i <= cells.length - needed; i++){
        let ok = true;
        for(let k=0; k<needed; k++){
          if(cells[i+k].status !== "FREE"){
            ok = false;
            break;
          }
        }
        if(!ok) continue;
        const startHour = cells[i].hour;
        results.push({
          orName: row.orName,
          startHour,
          hours: needed,
          date: grid.date
        });
      }
    });

    return results;
  }

  // Render agrupado por ubicación
  function renderMasterNSSlots(){
    const box = $("stNSSlotsBox");
    box.innerHTML = "";
    const slots = S.masterNSSlots || [];
    if(!slots.length) return;

    const dateStr = S.masterNSQuery?.dateStr || (slots[0] && slots[0].date) || todayISO();

    const groups = new Map();
    slots.forEach((s, idx)=>{
      const key = s.orName || "—";
      if(!groups.has(key)) groups.set(key, []);
      groups.get(key).push({ s, idx });
    });

    const order = Array.from(groups.keys()).sort((a,b)=>{
      const ia = OR_LIST.indexOf(a);
      const ib = OR_LIST.indexOf(b);
      if(ia !== -1 || ib !== -1){
        if(ia === -1) return 1;
        if(ib === -1) return -1;
        return ia - ib;
      }
      return a.localeCompare(b,"es");
    });

    const wrap = document.createElement("div");
    wrap.className = "slotsByOr";

    order.forEach(orName=>{
      const items = (groups.get(orName) || []).slice();
      items.sort((a,b)=> (a.s.startHour||0) - (b.s.startHour||0));

      const row = document.createElement("div");
      row.className = "slotsRow";

      const head = document.createElement("div");
      head.className = "slotsRowHead";

      const title = document.createElement("div");
      title.className = "slotsRowTitle";
      title.innerHTML = `<span class="badge">Ubicación</span> ${escapeHtml(orName)}`;

      const count = document.createElement("div");
      count.className = "badge";
      count.textContent = `${items.length} hueco${items.length === 1 ? "" : "s"}`;

      head.appendChild(title);
      head.appendChild(count);

      const chips = document.createElement("div");
      chips.className = "slotsRowChips";

      items.forEach(({s, idx})=>{
        const d = new Date(dateStr+"T00:00:00");
        d.setHours(s.startHour,0,0,0);

        const btn = document.createElement("button");
        btn.className = "slot" + (idx === S.masterNSSelectedIndex ? " selected" : "");
        btn.textContent = `${d.toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"})}`;
        btn.title = `${escapeHtml(orName)} · ${String(s.startHour).padStart(2,"0")}:00`;
        btn.onclick = ()=>{
          S.masterNSSelectedIndex = idx;
          renderMasterNSSlots();
        };
        chips.appendChild(btn);
      });

      row.appendChild(head);
      row.appendChild(chips);
      wrap.appendChild(row);
    });

    box.appendChild(wrap);
  }

  function masterFindNonStructSlots(opt){
    const o = opt || {};
    const refreshOnly = !!o.refreshOnly;
    const afterCreate = !!o.afterCreate;

    if(!refreshOnly){
      hideMsg($("msgStructNon"));
    }

    $("stNSSlotsBox").innerHTML = "";
    S.masterNSQuery = null;
    S.masterNSSlots = [];
    S.masterNSSelectedIndex = -1;

    const dateStr = (o.dateStr || $("stNSDate").value);
    const hours = parseInt((o.hours || $("stNSDur").value),10);

    if(!dateStr) return showMsg($("msgStructNon"), "Selecciona una fecha.", "warn");
    if(!hours || hours <= 0) return showMsg($("msgStructNon"), "Selecciona una duración válida.", "warn");

    callGAS("getGridOccupancy", [S.pin, dateStr], {
      key:"masterNSGrid",
      msg:"Buscando huecos disponibles…",
      disable: [$("btnNSFindSlots")],
      onSuccess:(res)=>{
        S.masterNSQuery = {dateStr, hours};
        const slots = computeFreeBlocksForDateGrid(res, hours);
        S.masterNSSlots = slots;

        if(!slots.length){
          showMsg($("msgStructNon"),
            afterCreate
              ? "Quirófano creado. No quedan huecos libres para esa duración en ese día (ya actualizado)."
              : "No hay huecos libres que permitan esa duración en ese día.",
            "warn"
          );
          return;
        }

        renderMasterNSSlots();

        showMsg($("msgStructNon"),
          afterCreate
            ? "Quirófano creado correctamente. Huecos actualizados: selecciona otro hueco si quieres asignar uno nuevo."
            : "Selecciona un hueco y después pulsa «Asignar hueco seleccionado».",
          "ok"
        );
      },
      onFailure:(e)=>{
        showMsg($("msgStructNon"), e?.message || String(e), "bad");
      }
    });
  }

  function masterAssignNonStructSlot(){
    hideMsg($("msgStructNon"));
    const idx = S.masterNSSelectedIndex;
    if(idx < 0 || !S.masterNSSlots.length){
      return showMsg($("msgStructNon"), "Primero selecciona uno de los huecos disponibles.", "warn");
    }

    const slot = S.masterNSSlots[idx];
    const dateStr = S.masterNSQuery?.dateStr || slot.date;
    const hours = S.masterNSQuery?.hours || slot.hours;
    const orName = slot.orName;

    const email = ($("stNSDoctorEmail").value || "").trim();
    if(!email){
      return showMsg($("msgStructNon"), "Selecciona o escribe el email del usuario.", "warn");
    }

    const rawLabel = ($("stNSLabel").value || "").trim();
    const label = rawLabel ? rawLabel : email;

    const startISO = `${dateStr}T${String(slot.startHour).padStart(2,"0")}:00:00`;

    const payload = {
      date: dateStr,
      startISO,
      startHour: slot.startHour,
      hours,
      orName,
      label,
      doctorEmail: email
    };

    if(!confirm(`¿Crear quirófano NO estructural para ${email} el ${fmtDMY(dateStr)} en ${orName} a las ${String(slot.startHour).padStart(2,"0")}:00 durante ${hours} h?`)){
      return;
    }

    callGAS("masterCreateNonStructural", [S.pin, payload], {
      key:"masterCreateNonStruct",
      msg:"Creando quirófano no estructural…",
      disable: [$("btnNSAssignSlot"), $("btnNSFindSlots"), $("stNSDoctorSelect"), $("stNSDoctorEmail"), $("stNSLabel"), $("stNSDate"), $("stNSDur")],
      onSuccess:(res)=>{
        showMsg($("msgStructNon"), res?.message || "Quirófano no estructural creado.", "ok");
        masterFindNonStructSlots({ refreshOnly:true, afterCreate:true, dateStr, hours });

        const gdDate = $("gdDate").value;
        if(gdDate && gdDate === dateStr){
          loadGrid();
        }
      },
      onFailure:(e)=>{
        showMsg($("msgStructNon"), e?.message || String(e), "bad");
      }
    });
  }

  // ===== LISTA DE ESPERA (NUEVA) =====
  function openWaitlist(){
    go("viewWait");

    if(!S.pin){
      showMsg($("msgWait"), "Debes entrar primero con tu PIN.", "warn");
      return;
    }
    if(!isMaster()){
      showMsg($("msgWait"), "Solo el perfil Master puede ver y gestionar la lista de espera.", "warn");
      return;
    }
    loadWaitlistMaster();
  }

  function loadWaitlistMaster(){
    hideMsg($("msgWait"));
    const listEl = $("waitList");
    listEl.innerHTML = `<div class="msg">Cargando…</div>`;

    const mode = $("wlFilter").value;
    let onlyPending = true;
    let includePast = false;
    if(mode === "pendingAll"){ onlyPending = true; includePast = true; }

    callGAS("listWaitlist", [S.pin, onlyPending, includePast], {
      key:"waitlist",
      msg:"Cargando lista de espera…",
      onSuccess:(res)=>{
        if(!res || !res.ok){
          listEl.innerHTML = "";
          showMsg($("msgWait"), "Respuesta inválida del servidor.", "bad");
          return;
        }
        renderWaitlist(res.items || []);
      },
      onFailure:(e)=>{
        listEl.innerHTML = "";
        showMsg($("msgWait"), e?.message || String(e), "bad");
      }
    });
  }

  function renderWaitlist(items){
    const listEl = $("waitList");
    listEl.innerHTML = "";

    if(!items.length){
      showMsg($("msgWait"), "No hay solicitudes con ese filtro.", "warn");
      return;
    }
    hideMsg($("msgWait"));

    listEl.innerHTML = items.map(it=>{
      const who = `${it.nombre||""} ${it.apellidos||""}`.trim();
      const estado = it.estado || "";
      const canAct = (estado === "PENDIENTE");
      return `
        <div class="card" style="margin:10px 0">
          <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start;flex-wrap:wrap">
            <div style="min-width:280px;flex:1">
              <div style="font-weight:850">
                ${escapeHtml(fmtDMY(it.fecha||""))} · ${escapeHtml(String(it.horas||""))}h · ${escapeHtml(it.preferencia||"")}
              </div>
              <div class="hint">${escapeHtml(who)} · ${escapeHtml(it.especialidad||"")} · ${escapeHtml(it.correo||"")}</div>
              ${it.nota ? `<div style="margin-top:6px">${escapeHtml(it.nota)}</div>` : ``}
              <div class="hint" style="margin-top:6px">Estado: <b>${escapeHtml(estado)}</b> · ID: ${escapeHtml(it.waitId||"")}</div>
            </div>

            <div style="display:flex;flex-direction:column;gap:8px;min-width:200px">
              ${canAct ? `<button class="btn good" onclick="acceptWait('${escapeHtml(it.waitId||"")}')">Aceptar y asignar</button>` : ``}
              ${canAct ? `<button class="btn bad" onclick="discardWait('${escapeHtml(it.waitId||"")}')">Descartar</button>` : ``}
            </div>
          </div>
        </div>
      `;
    }).join("");
  }

  function acceptWait(waitId){
    if(!waitId) return;
    if(!confirm("¿Asignar quirófano automáticamente para esta solicitud?")) return;

    callGAS("acceptWaitlist", [S.pin, waitId], {
      key:"acceptWait",
      msg:"Buscando hueco y asignando…",
      onSuccess:(res)=>{
        showMsg($("msgWait"), res?.message || "Solicitud asignada.", "ok");
        loadWaitlistMaster();
        loadGrid();
      },
      onFailure:(e)=>{
        showMsg($("msgWait"), e?.message || String(e), "bad");
      }
    });
  }

  function discardWait(waitId){
    if(!waitId) return;
    if(!confirm("¿Descartar esta solicitud y enviar email al solicitante?")) return;

    callGAS("resolveWaitlist", [S.pin, waitId, "DESCARTADA"], {
      key:"discardWait",
      msg:"Marcando solicitud como descartada…",
      onSuccess:(res)=>{
        showMsg($("msgWait"), res?.message || "Solicitud descartada.", "ok");
        loadWaitlistMaster();
      },
      onFailure:(e)=>{
        showMsg($("msgWait"), e?.message || String(e), "bad");
      }
    });
  }

  // ===== REPORTES =====
  function sendReport(){
    hideMsg($("msgReport"));
    const email = $("rpEmail").value || "";
    const start = $("rpStart").value || "";
    const end   = $("rpEnd").value || "";
    if(!email || !start || !end){
      return showMsg($("msgReport"), "Indica email, inicio y fin.", "warn");
    }

    callGAS("sendORForecastReport", [S.pin, email, start, end], {
      key:"report",
      msg:"Enviando reporte por correo…",
      onSuccess:(res)=>{
        showMsg($("msgReport"), res?.message || "Reporte enviado.", "ok");
      },
      onFailure:(e)=>{
        showMsg($("msgReport"), e?.message || String(e), "bad");
      }
    });
  }

  function generateStructVisualReport(){
    hideMsg($("msgReport"));
    const box = $("structVisualReport");
    box.classList.add("hide");
    box.innerHTML = "";

    callGAS("getStructuralProgramReport", [S.pin], {
      key:"structReport",
      msg:"Generando reporte visual…",
      onSuccess:(res)=>{
        renderStructVisualReport(res);
      },
      onFailure:(e)=>{
        showMsg($("msgReport"), e?.message || String(e), "bad");
      }
    });
  }

  function renderStructVisualReport(data){
    const box = $("structVisualReport");
    box.innerHTML = "";
    if(!data || !data.byDaySession){
      box.classList.add("hide");
      showMsg($("msgReport"), "Sin datos de estructurales.", "warn");
      return;
    }
    box.classList.remove("hide");

    const daysOrder = ["L","M","X","J","V","S","D"];
    const dayName = {L:"Lunes",M:"Martes",X:"Miércoles",J:"Jueves",V:"Viernes",S:"Sábado",D:"Domingo"};

    const table = document.createElement("table");
    const thead = document.createElement("thead");
    thead.innerHTML = "<tr><th>Día</th><th>Sesión</th><th>Bloques</th></tr>";
    table.appendChild(thead);
    const tbody = document.createElement("tbody");

    daysOrder.forEach(d=>{
      const sessions = data.byDaySession[d];
      if(!sessions) return;

      ["AM","PM","MIXED"].forEach(sess=>{
        const list = sessions[sess] || [];
        const tr = document.createElement("tr");
        const tdDay = document.createElement("td");
        tdDay.textContent = dayName[d] + (sess === "AM" ? " (mañana)" : sess === "PM" ? " (tarde)" : " (mixta)");
        const tdSess = document.createElement("td");
        tdSess.textContent = (sess === "AM" ? "Mañana" : sess === "PM" ? "Tarde" : "Mixta");
        const tdBlocks = document.createElement("td");

        if(!list.length){
          tdBlocks.textContent = "—";
        } else {
          list.forEach(r=>{
            const div = document.createElement("div");
            div.className = "rchip struct";
            const womTxt = r.weeksOfMonth && r.weeksOfMonth.length
              ? `Semanas: ${r.weeksOfMonth.join(",")}`
              : "";
            const occTxt = r.occPerMonth ? ` (${r.occPerMonth}×/mes)` : "";
            div.innerHTML = `
              <b>${escapeHtml(r.orName)} – ${escapeHtml(r.label || "")}</b>
              <small>
                ${String(r.startHour).padStart(2,"0")}:00 · ${r.durationHours} h · ${escapeHtml(r.cadenceNameEs || r.cadenceMode || "")}${occTxt}
                ${womTxt ? " · "+escapeHtml(womTxt) : ""}
              </small>
            `;
            tdBlocks.appendChild(div);
          });
        }

        tr.appendChild(tdDay);
        tr.appendChild(tdSess);
        tr.appendChild(tdBlocks);
        tbody.appendChild(tr);
      });
    });

    table.appendChild(tbody);
    box.appendChild(table);
  }

  // ===== ESCAPES =====
  function escapeHtml(str){
    return String(str || "").replace(/[&<>"']/g, s=>{
      if(s === "&") return "&amp;";
      if(s === "<") return "&lt;";
      if(s === ">") return "&gt;";
      if(s === '"') return "&quot;";
      if(s === "'") return "&#39;";
      return s;
    });
  }

  // ===== INIT =====
  function initDatesAndDefaults(){
    const t = todayISO();
    if($("rvDate")) $("rvDate").value = addDaysISO(1);
    if($("gdDate")) $("gdDate").value = t;
    if($("stNSDate")) $("stNSDate").value = addDaysISO(1);
    if($("rpStart")) $("rpStart").value = t;
    if($("rpEnd")){
      const d = new Date();
      d.setDate(d.getDate()+30);
      d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
      $("rpEnd").value = d.toISOString().slice(0,10);
    }
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    initOrCalcDefaults();
    buildOrCalcChips();
    fillStructSelectors();
    syncCadenceUI();
    initDatesAndDefaults();
    setSessionPill();
    setMenuButtons();

    $("btnLogin").onclick = login;
    $("btnClear").onclick = ()=>{$("pinInput").value = ""; hideMsg($("msgLogin"));};
    $("btnLogout").onclick = logout;

    $("btnToggleSignup").onclick = toggleSignup;
    $("btnSignup").onclick = signup;

    $("btnGoReserve").onclick = ()=>go("viewReserve");
    $("btnGoMine").onclick    = ()=>go("viewMine");
    $("btnGoGrid").onclick    = ()=>{ go("viewGrid"); loadGrid(); };
    $("btnGoStruct").onclick  = ()=>{
      go("viewStruct");
      refreshStructList();
      loadDoctorOptionsMaster();
    };

    $("btnGoWait").onclick    = openWaitlist;
    $("btnGoReport").onclick  = ()=>go("viewReport");

    $("btnCheckSlots").onclick = checkSlots;
    $("btnOpenWaitlistFromReserve").onclick = openWaitlistFromReserve;
    $("btnLoadMine").onclick = loadMine;

    $("btnLoadGrid").onclick = loadGrid;
    $("btnToggleAdvanced").onclick = ()=>{
      $("advancedBox").classList.toggle("hide");
    };

    if($("btnGridPrevDay")) $("btnGridPrevDay").onclick = ()=>moveGridDay(-1);
    if($("btnGridNextDay")) $("btnGridNextDay").onclick = ()=>moveGridDay(1);
    if($("btnRvPrevDay"))   $("btnRvPrevDay").onclick   = ()=>moveReserveDay(-1);
    if($("btnRvNextDay"))   $("btnRvNextDay").onclick   = ()=>moveReserveDay(1);

    $("btnNewStruct").onclick = clearStructEditor;
    $("btnSaveStruct").onclick = saveStructFromEditor;
    $("btnDeleteStructById").onclick = deleteStructById;
    $("btnReloadStruct").onclick = refreshStructList;
    $("btnStructClearFilter").onclick = clearStructFilter;
    $("structTeamFilter").onchange = setStructTeamFilter;
    $("stCadence").onchange = syncCadenceUI;

    // NO estructurales master
    $("btnNSFindSlots").onclick = ()=>masterFindNonStructSlots();
    $("btnNSAssignSlot").onclick = masterAssignNonStructSlot;

    const selDoctor = $("stNSDoctorSelect");
    if(selDoctor){
      selDoctor.onchange = ()=>{
        const email = selDoctor.value || "";
        $("stNSDoctorEmail").value = email;
      };
    }

    $("btnLoadWait").onclick = loadWaitlistMaster;
    $("wlFilter").onchange = ()=>{ if(!$("#viewWait").classList.contains("hide")) loadWaitlistMaster(); };

    $("btnSendReport").onclick = sendReport;
    $("btnStructVisualReport").onclick = generateStructVisualReport;

    $("btnModalClose").onclick = closeModal;
    $("btnModalApply").onclick = applyModalChanges;
  });
</script>
</body>
</html>
